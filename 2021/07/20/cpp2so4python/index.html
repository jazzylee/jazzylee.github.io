<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jazzylee.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.6.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="è®°å½•å°†c++æ–‡ä»¶è½¬æ¢æˆsoå¹¶ä½¿ç”¨pythonè°ƒç”¨çš„è¿‡ç¨‹ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="cpp2so4python">
<meta property="og:url" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/index.html">
<meta property="og:site_name" content="åŒ—æ¸¸è®°">
<meta property="og:description" content="è®°å½•å°†c++æ–‡ä»¶è½¬æ¢æˆsoå¹¶ä½¿ç”¨pythonè°ƒç”¨çš„è¿‡ç¨‹ã€‚">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721211506818.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721211517929.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721220655534.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722020258432.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722020644010.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/@0VF94S5TTMAP%25%5BHHUK2E4O.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722021039835.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722222533236.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722222622332.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722222841636.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722232421332.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722233227768.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723123411146.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723123944869.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723141755679.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723141854704.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723170929884.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723183855153.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723223009737.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723223911763.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724005744222.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724005908718.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724005934382.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724011834389.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724011943591.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724104438802.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724104610950.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724105227731.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724110314909.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724160925922.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724162331186.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724162624894.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722134417691.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722134426908.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722135316031.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722134617694.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210725181836340.png">
<meta property="article:published_time" content="2021-07-20T10:08:42.000Z">
<meta property="article:modified_time" content="2021-08-04T07:23:52.638Z">
<meta property="article:author" content="movice">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="libtorch">
<meta property="article:tag" content="pybind11">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721211506818.png">


<link rel="canonical" href="https://jazzylee.github.io/2021/07/20/cpp2so4python/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://jazzylee.github.io/2021/07/20/cpp2so4python/","path":"2021/07/20/cpp2so4python/","title":"cpp2so4python"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>cpp2so4python | åŒ—æ¸¸è®°</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">åŒ—æ¸¸è®°</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%8F"><span class="nav-number">1.</span> <span class="nav-text">åº</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pybind11"><span class="nav-number">2.</span> <span class="nav-text">pybind11</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Copy%E7%BD%91%E7%BB%9C%E8%B5%84%E6%BA%90"><span class="nav-number">2.1.</span> <span class="nav-text">Copyç½‘ç»œèµ„æº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86C-%E7%9A%84%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E8%BD%AC%E4%B8%BAso"><span class="nav-number">2.2.</span> <span class="nav-text">å°†C++çš„ç›®æ ‡æ£€æµ‹è½¬ä¸ºso</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%9A%84cmakelists"><span class="nav-number">2.2.1.</span> <span class="nav-text">ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„cmakelists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90so%E7%9A%84cmakelists"><span class="nav-number">2.2.2.</span> <span class="nav-text">ç”Ÿæˆsoçš„cmakelists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90so%E7%9A%84c-%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.3.</span> <span class="nav-text">ç”Ÿæˆsoçš„c++æºæ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E8%B0%83%E7%94%A8so"><span class="nav-number">2.2.4.</span> <span class="nav-text">pythonè°ƒç”¨so</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%99%E6%8F%92%E6%9B%B2"><span class="nav-number">2.2.5.</span> <span class="nav-text">æŠ¥é”™æ’æ›²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%9C%9C%E6%B1%81%E7%96%91%E9%97%AE"><span class="nav-number">2.2.6.</span> <span class="nav-text">èœœæ±ç–‘é—®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84"><span class="nav-number">2.3.</span> <span class="nav-text">å®Œå–„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90so%E7%9A%84c-%E6%BA%90%E6%96%87%E4%BB%B6-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">ç”Ÿæˆsoçš„c++æºæ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E8%B0%83%E7%94%A8so-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">pythonè°ƒç”¨so</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9F%E5%BA%A6%E5%AF%B9%E6%AF%94"><span class="nav-number">2.3.3.</span> <span class="nav-text">é€Ÿåº¦å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%9F%E7%B3%95%E7%9A%84%E7%B2%BE%E5%BA%A6"><span class="nav-number">2.3.4.</span> <span class="nav-text">ç³Ÿç³•çš„ç²¾åº¦</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9boxThreshold"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">ä¿®æ”¹boxThreshold</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#yolov5m-pt-gt-yolov5m-onnx"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">yolov5m.pt-&gt;yolov5m.onnx</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84%E7%8C%9C%E6%83%B3"><span class="nav-number">2.3.4.2.1.</span> <span class="nav-text">å¤±è´¥çš„çŒœæƒ³</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pt2pth2onnx"><span class="nav-number">2.3.4.2.2.</span> <span class="nav-text">pt2pth2onnx</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%A1%E6%80%9D%E4%B9%B1%E6%83%B3"><span class="nav-number">3.</span> <span class="nav-text">èƒ¡æ€ä¹±æƒ³</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#libtorch"><span class="nav-number">4.</span> <span class="nav-text">libtorch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD-%E6%9C%89%E5%9D%91"><span class="nav-number">4.1.</span> <span class="nav-text">ä¸‹è½½(æœ‰å‘)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">4.2.</span> <span class="nav-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.3.</span> <span class="nav-text">åŠ è½½æ¨¡å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E5%9D%91"><span class="nav-number">4.4.</span> <span class="nav-text">å¤§å‘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#remake-%C3%97"><span class="nav-number">4.5.</span> <span class="nav-text">remake(Ã—)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#remake2-%E2%88%9A"><span class="nav-number">4.6.</span> <span class="nav-text">remake2(âˆš)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B2%BE%E5%BA%A6%E5%AF%B9%E6%AF%94-libtorch-onnx-pt"><span class="nav-number">4.7.</span> <span class="nav-text">ç²¾åº¦å¯¹æ¯”(libtorch&#x2F;onnx&#x2F;pt)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%941"><span class="nav-number">4.7.1.</span> <span class="nav-text">å¯¹æ¯”1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%942"><span class="nav-number">4.7.2.</span> <span class="nav-text">å¯¹æ¯”2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%943"><span class="nav-number">4.7.3.</span> <span class="nav-text">å¯¹æ¯”3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%944"><span class="nav-number">4.7.4.</span> <span class="nav-text">å¯¹æ¯”4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">4.7.5.</span> <span class="nav-text">ç»“è®º</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libtorch-pybind11"><span class="nav-number">4.8.</span> <span class="nav-text">libtorch+pybind11</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.8.1.</span> <span class="nav-text">c++ç¨‹åº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cmakelists"><span class="nav-number">4.8.2.</span> <span class="nav-text">cmakelists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E8%B0%83%E7%94%A8"><span class="nav-number">4.8.3.</span> <span class="nav-text">pythonè°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9F%E5%BA%A6%E5%AF%B9%E6%AF%94-1"><span class="nav-number">4.8.4.</span> <span class="nav-text">é€Ÿåº¦å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B2%BE%E5%BA%A6%E5%AF%B9%E6%AF%94"><span class="nav-number">4.8.5.</span> <span class="nav-text">ç²¾åº¦å¯¹æ¯”</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">é™„å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ubuntu-opencv-cuda%E7%BC%96%E8%AF%91"><span class="nav-number">5.1.</span> <span class="nav-text">ubuntu opencv+cudaç¼–è¯‘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows%E4%B8%8A%E7%9A%84pybind11%E5%B0%9D%E8%AF%95"><span class="nav-number">5.2.</span> <span class="nav-text">windowsä¸Šçš„pybind11å°è¯•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ubuntu%E4%B8%8A%E7%9A%84pybind11%E5%AE%89%E8%A3%85"><span class="nav-number">5.3.</span> <span class="nav-text">ubuntuä¸Šçš„pybind11å®‰è£…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows%E5%AE%89%E8%A3%85libtorch"><span class="nav-number">5.4.</span> <span class="nav-text">windowså®‰è£…libtorch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libtorch%E6%8C%87%E5%AE%9ACUDA%E6%88%96CPU"><span class="nav-number">5.5.</span> <span class="nav-text">libtorchæŒ‡å®šCUDAæˆ–CPU</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9ACUDA"><span class="nav-number">5.5.1.</span> <span class="nav-text">æŒ‡å®šCUDA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU"><span class="nav-number">5.5.2.</span> <span class="nav-text">CPU</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">movice</p>
  <div class="site-description" itemprop="description">ğŸ”¥impetuousğŸ”¥fireğŸ”¥</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
    </div>
    <div>
      <!--clustrmaps-->
      <script type="text/javascript" id="clustrmaps" src="//clustrmaps.com/map_v2.js?d=V7pseSmYqG3eRqg-m6VS1UxwXHXL8gIybqq7QtBtLug&cl=ffffff&w=a"></script>
    </div>
    <!--music-->
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1791380&auto=0&height=66"></iframe>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jazzylee.github.io/2021/07/20/cpp2so4python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="movice">
      <meta itemprop="description" content="ğŸ”¥impetuousğŸ”¥fireğŸ”¥">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="åŒ—æ¸¸è®°">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          cpp2so4python
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-20 18:08:42" itemprop="dateCreated datePublished" datetime="2021-07-20T18:08:42+08:00">2021-07-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-08-04 15:23:52" itemprop="dateModified" datetime="2021-08-04T15:23:52+08:00">2021-08-04</time>
      </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>è®°å½•å°†c++æ–‡ä»¶è½¬æ¢æˆsoå¹¶ä½¿ç”¨pythonè°ƒç”¨çš„è¿‡ç¨‹ã€‚</p>
<span id="more"></span>

<h1 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h1><p><a href="https://jazzylee.github.io/2021/07/17/yolo5-opencv-cuda/">ä¸Šä¸€ç¯‡</a>ä¸­è®°å½•äº†YOLOv5såœ¨C++ä¸­çš„ä½¿ç”¨ï¼Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯å°†YOLOv5sçš„ptæ¨¡å‹è½¬æˆonnxæ¨¡å‹ï¼Œåœ¨C++ä¸­ä½¿ç”¨OpenCVçš„dnnæ¨¡å—åŠ è½½æ¨¡å‹è¿›è¡Œæ¨ç†ï¼Œå…¨ç¨‹æ˜¯åœ¨æœ¬åœ°è·‘çš„ï¼ˆåŸå› æ˜¯æœåŠ¡å™¨ä¸Šçš„OpenCVç«Ÿæ²¡æœ‰CUDAåŠ é€Ÿï¼Œä¸è¿‡åæ¥sudoé‡æ–°ç¼–è¯‘äº†CUDAåŠ é€Ÿçš„ç‰ˆæœ¬ï¼‰ï¼Œé€Ÿåº¦è¡¨ç°å·²ç»ååˆ†è®©æˆ‘æ»¡æ„äº†ã€‚ä½†æ˜¯å®é™…ä½¿ç”¨ä¸­ï¼Œè¿˜æ˜¯è¦æ±‚ä½¿åœ¨pythonç¯å¢ƒä¸­è¿è¡Œï¼Œäºæ˜¯å¼€å§‹æ‰¾æ–¹æ³•å°†C++è½¬æˆpythonå¯å¯¼å…¥çš„æ¨¡å—ã€‚</p>
<p>æŸ¥äº†èµ„æ–™å¹¶æ¯”è¾ƒäº†ä¸€ä¸‹ï¼Œå†³å®šä½¿ç”¨pybind11ã€‚</p>
<blockquote>
<p>PSï¼šubuntuä¸Šçš„pybind11å®‰è£…ç½‘ç»œä¸Šæœ‰ä¸€å †èµ„æºï¼Œå¯ä»¥ä¸ç”¨sudoï¼Œmakeå®Œä¹‹åå°±å¯ä»¥ç”¨äº†ã€‚åœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘çš„cppå’Œpybind11æ–‡ä»¶å¤¹æ”¾åœ¨åŒçº§ç›®å½•ï¼Œcmakelistsä¸­add_subdirectory(pybind11)</p>
</blockquote>
<h1 id="pybind11"><a href="#pybind11" class="headerlink" title="pybind11"></a>pybind11</h1><p>ç½‘ä¸Šä¾‹å­å¤ªå¤šï¼Œå…¶å®ä»”ç»†çœ‹ä¸€ä¸¤ä¸ªï¼Œå°±èƒ½åŸºç¡€æ“ä½œäº†ã€‚</p>
<h2 id="Copyç½‘ç»œèµ„æº"><a href="#Copyç½‘ç»œèµ„æº" class="headerlink" title="Copyç½‘ç»œèµ„æº"></a>Copyç½‘ç»œèµ„æº</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42227520/article/details/108214796">å‚è€ƒ1</a>ï¼Œå…¶ä¸­åŒ…å«äº†cppï¼Œcmakelistsï¼Œç»å°è¯•ï¼Œå¯ä»¥ç”Ÿæˆsoå¹¶æˆåŠŸå¯¼å…¥pythonã€‚ä½†æ˜¯è¿™ä¸ªä¾‹å­æ²¡æœ‰python importåçš„è°ƒç”¨éƒ¨åˆ†<img src="./image-20210721211506818.png" alt="image-20210721211506818"></li>
</ul>
<p><img src="./image-20210721211517929.png" alt="image-20210721211517929"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Heart_M/article/details/110958091">å‚è€ƒ2</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zouzoupaopao229/article/details/106802249">å‚è€ƒ3</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148076952">å‚è€ƒ4</a></li>
</ul>
<p>ä»¥<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42227520/article/details/108214796">å‚è€ƒ1</a>ä¸­çš„CreateObjæ–¹æ³•(å…¶å®å°±æ˜¯ä¸ªç®—ä¹˜æ³•çš„)ä¸ºä¾‹ï¼š</p>
<p><img src="./image-20210721220655534.png" alt="image-20210721220655534"></p>
<p>ç”Ÿæˆsoå¹¶è¢«pythonå¯¼å…¥åï¼Œè°ƒç”¨CreatObjï¼Œä¼ å…¥ä¸¤ä¸ªintï¼Œè¿”å›intï¼Œpyä¸­ä½¿ç”¨å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libmap_interface</span><br><span class="line">mapinterface =libmap_interface.MapInterface()<span class="comment">#MapInterfaceæ˜¯CPPä¸­å®šä¹‰çš„ç±»ï¼Œè¿™å¥å®ä¾‹åŒ–äº§ç”Ÿäº†å¯¹è±¡mapinterface</span></span><br><span class="line">a=mapinterface.CreateObj(<span class="number">3</span>,<span class="number">4</span>)<span class="comment">#è°ƒç”¨CreatObjæ–¹æ³•ï¼Œè®¡ç®—ä¸¤æ•°ä¹˜æ³•</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&gt;<span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­é‡Œçš„å‡½æ•°å‘½åæœ‰ç‚¹å¥‡è‘©ï¼Œæ”¹äº†æ”¹ï¼Œå¹¶ç²¾ç®€äº†ä¸€ä¸‹ï¼Œå¯ä»¥ä½œä¸ºä¸€ä¸ªpybindçš„mini demo</p>
<ul>
<li>C++å¦‚ä¸‹</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">mul</span><span class="params">(<span class="keyword">int</span> img_row, <span class="keyword">int</span> img_col)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">echoInt</span><span class="params">(<span class="keyword">int</span> para)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayBye</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MapInterface::mul</span><span class="params">(<span class="keyword">int</span> img_row, <span class="keyword">int</span> img_col)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> img_col*img_row;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapInterface::echoInt</span><span class="params">(<span class="keyword">int</span> para)</span></span>&#123;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;para: &quot;</span> &lt;&lt; para &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapInterface::sayBye</span><span class="params">()</span></span>&#123;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;goodbye&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libmymap, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;pybind11 Hierarchical Localization cpp backend&quot;</span>;</span><br><span class="line">    py::class_&lt;MapInterface&gt;(m, <span class="string">&quot;MapInterface&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;mul&quot;</span>, &amp;MapInterface::mul, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;echoInt&quot;</span>, &amp;MapInterface::echoInt)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;sayBye&quot;</span>, &amp;MapInterface::sayBye);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>cmakelistså¦‚ä¸‹</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION  <span class="number">3.16</span>.<span class="number">2</span>)</span><br><span class="line"><span class="keyword">project</span>(ProjectName)</span><br><span class="line"><span class="keyword">add_compile_options</span>(-std=c++<span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11 -g&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(PYBIND11_CPP_STANDARD -std=c++<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(pybind11)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INCLUDE_DIRECTORIES</span>(</span><br><span class="line">  <span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span></span><br><span class="line">  ./</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">add_library</span>(mymap MODULE </span><br><span class="line">            mymap.cpp</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(mymap </span><br><span class="line">            pybind11::module</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯•pyå¦‚ä¸‹</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libmymap</span><br><span class="line">cls = libmymap.MapInterface()</span><br><span class="line">cls.mul(<span class="number">3</span>,<span class="number">9</span>)<span class="comment">#&gt;27</span></span><br><span class="line">cls.sayBye()<span class="comment">#&gt;goodbye</span></span><br><span class="line">cls.echoInt(<span class="number">0</span>)<span class="comment">#&gt;para: 0</span></span><br></pre></td></tr></table></figure>

<h2 id="å°†C-çš„ç›®æ ‡æ£€æµ‹è½¬ä¸ºso"><a href="#å°†C-çš„ç›®æ ‡æ£€æµ‹è½¬ä¸ºso" class="headerlink" title="å°†C++çš„ç›®æ ‡æ£€æµ‹è½¬ä¸ºso"></a>å°†C++çš„ç›®æ ‡æ£€æµ‹è½¬ä¸ºso</h2><h3 id="ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„cmakelists"><a href="#ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„cmakelists" class="headerlink" title="ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„cmakelists"></a>ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„cmakelists</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION  3.16.2)</span><br><span class="line">project(yoloso)</span><br><span class="line">add_compile_options(-std=c++11)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -std=c++11 -g&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(PYBIND11_CPP_STANDARD -std=c++11)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">add_subdirectory(pybind11)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include_directories( <span class="variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span> )</span><br><span class="line">add_executable( predict predict.cpp )</span><br><span class="line">target_link_libraries( predict <span class="variable">$&#123;OpenCV_LIBS&#125;</span> )</span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿæˆsoçš„cmakelists"><a href="#ç”Ÿæˆsoçš„cmakelists" class="headerlink" title="ç”Ÿæˆsoçš„cmakelists"></a>ç”Ÿæˆsoçš„cmakelists</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION  <span class="number">3.16</span>.<span class="number">2</span>)</span><br><span class="line"><span class="keyword">project</span>(yoloso)</span><br><span class="line"><span class="keyword">add_compile_options</span>(-std=c++<span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11 -g&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(PYBIND11_CPP_STANDARD -std=c++<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(OpenCV REQUIRED)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(pybind11)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>( <span class="variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span> )</span><br><span class="line"><span class="keyword">INCLUDE_DIRECTORIES</span>(</span><br><span class="line">  <span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span></span><br><span class="line">  ./</span><br><span class="line">)</span><br><span class="line"><span class="keyword">add_library</span>(predict MODULE </span><br><span class="line">            predict.cpp</span><br><span class="line">    )</span><br><span class="line"><span class="comment">#add_executable( predict predict.cpp )</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(predict </span><br><span class="line">            pybind11::module</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">target_link_libraries</span>( predict <span class="variable">$&#123;OpenCV_LIBS&#125;</span> )</span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿæˆsoçš„c-æºæ–‡ä»¶"><a href="#ç”Ÿæˆsoçš„c-æºæ–‡ä»¶" class="headerlink" title="ç”Ÿæˆsoçš„c++æºæ–‡ä»¶"></a>ç”Ÿæˆsoçš„c++æºæ–‡ä»¶</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/dnn.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> dnn;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Output</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;<span class="comment">//ç±»åˆ«</span></span><br><span class="line">	<span class="keyword">float</span> confidence;<span class="comment">//ç½®ä¿¡åº¦</span></span><br><span class="line">	cv::Rect box;<span class="comment">//çŸ©å½¢æ¡†</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(<span class="number">1.f</span> / (<span class="number">1.f</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netAnchors[<span class="number">3</span>][<span class="number">6</span>] = &#123; &#123; <span class="number">10.0</span>, <span class="number">13.0</span>, <span class="number">16.0</span>, <span class="number">30.0</span>, <span class="number">33.0</span>, <span class="number">23.0</span> &#125;,&#123; <span class="number">30.0</span>, <span class="number">61.0</span>, <span class="number">62.0</span>, <span class="number">45.0</span>, <span class="number">59.0</span>, <span class="number">119.0</span> &#125;,&#123; <span class="number">116.0</span>, <span class="number">90.0</span>, <span class="number">156.0</span>, <span class="number">198.0</span>, <span class="number">373.0</span>, <span class="number">326.0</span> &#125; &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netStride[<span class="number">3</span>] = &#123; <span class="number">8.0</span>, <span class="number">16.0</span>, <span class="number">32.0</span> &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netWidth = <span class="number">640</span>; <span class="comment">//è¾“å…¥å¤§å°</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netHeight = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;</span><br><span class="line">	<span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;</span><br><span class="line">	std::vector&lt;std::string&gt; className = &#123; <span class="string">&quot;cigar&quot;</span>,<span class="string">&quot;seatBelt&quot;</span> &#125;;<span class="comment">//ç±»å</span></span><br><span class="line">	Net net;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">readModel</span><span class="params">(std::string netPath, <span class="keyword">bool</span> isCuda)</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">(string SrcImg)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Yolo::readModel</span><span class="params">(string netPath, <span class="keyword">bool</span> isCuda = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		net = <span class="built_in">readNetFromONNX</span>(netPath);</span><br><span class="line">	&#125;<span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;<span class="comment">//use GPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_CUDA);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CUDA);</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;	<span class="comment">//use CPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_DEFAULT);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CPU);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">Yolo::detect</span><span class="params">(string srcImg)</span> </span>&#123;</span><br><span class="line">	Mat blob;</span><br><span class="line">	Mat SrcImg = <span class="built_in">imread</span>(srcImg);</span><br><span class="line">	vector&lt;Output&gt; output;</span><br><span class="line">	<span class="built_in">blobFromImage</span>(SrcImg, blob, <span class="number">1</span> / <span class="number">255.0</span>, cv::<span class="built_in">Size</span>(netWidth, netHeight), <span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	net.<span class="built_in">setInput</span>(blob);</span><br><span class="line">	vector&lt;Mat&gt; netOutputImg;</span><br><span class="line">	net.forward(netOutputImg, net.<span class="built_in">getUnconnectedOutLayersNames</span>());</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; classIds;<span class="comment">//ç»“æœidæ•°ç»„</span></span><br><span class="line">	vector&lt;<span class="keyword">float</span>&gt; confidences;<span class="comment">//ç»“æœæ¯ä¸ªidå¯¹åº”ç½®ä¿¡åº¦æ•°ç»„</span></span><br><span class="line">	vector&lt;Rect&gt; boxes;<span class="comment">//æ¯ä¸ªidçŸ©å½¢æ¡†</span></span><br><span class="line">	<span class="keyword">float</span> ratio_h = (<span class="keyword">float</span>)SrcImg.rows / netHeight;</span><br><span class="line">	<span class="keyword">float</span> ratio_w = (<span class="keyword">float</span>)SrcImg.cols / netWidth;</span><br><span class="line">	<span class="keyword">int</span> net_width = className.<span class="built_in">size</span>() + <span class="number">5</span>;  <span class="comment">//è¾“å‡ºçš„ç½‘ç»œå®½åº¦æ˜¯ç±»åˆ«æ•°+5</span></span><br><span class="line">	<span class="keyword">float</span>* pdata = (<span class="keyword">float</span>*)netOutputImg[<span class="number">0</span>].data;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> stride = <span class="number">0</span>; stride &lt; <span class="number">3</span>; stride++) &#123;    <span class="comment">//stride</span></span><br><span class="line">		<span class="keyword">int</span> grid_x = (<span class="keyword">int</span>)(netWidth / netStride[stride]);</span><br><span class="line">		<span class="keyword">int</span> grid_y = (<span class="keyword">int</span>)(netHeight / netStride[stride]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> anchor = <span class="number">0</span>; anchor &lt; <span class="number">3</span>; anchor++) &#123; <span class="comment">//anchors</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_w = netAnchors[stride][anchor * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_h = netAnchors[stride][anchor * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid_y; i++) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid_y; j++) &#123;</span><br><span class="line">					<span class="keyword">float</span> box_score = <span class="built_in">Sigmoid</span>(pdata[<span class="number">4</span>]);<span class="comment">//è·å–æ¯ä¸€è¡Œçš„boxæ¡†ä¸­å«æœ‰æŸä¸ªç‰©ä½“çš„æ¦‚ç‡</span></span><br><span class="line">					<span class="keyword">if</span> (box_score &gt; boxThreshold) &#123;</span><br><span class="line">						<span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32FC1, pdata + <span class="number">5</span>)</span></span>;</span><br><span class="line">						Point classIdPoint;</span><br><span class="line">						<span class="keyword">double</span> max_class_socre;</span><br><span class="line">						cv::<span class="built_in">minMaxLoc</span>(scores, <span class="number">0</span>, &amp;max_class_socre, <span class="number">0</span>, &amp;classIdPoint);</span><br><span class="line">						max_class_socre = <span class="built_in">Sigmoid</span>((<span class="keyword">float</span>)max_class_socre);</span><br><span class="line">						<span class="keyword">if</span> (max_class_socre &gt; classThreshold) &#123;</span><br><span class="line">							<span class="keyword">float</span> x = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">0</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + j) * netStride[stride];  <span class="comment">//x</span></span><br><span class="line">							<span class="keyword">float</span> y = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">1</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + i) * netStride[stride];   <span class="comment">//y</span></span><br><span class="line">							<span class="keyword">float</span> w = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">2</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_w;   <span class="comment">//w</span></span><br><span class="line">							<span class="keyword">float</span> h = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">3</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_h;  <span class="comment">//h</span></span><br><span class="line">							<span class="keyword">int</span> left = (x - <span class="number">0.5</span>*w)*ratio_w;</span><br><span class="line">							<span class="keyword">int</span> top = (y - <span class="number">0.5</span>*h)*ratio_h;</span><br><span class="line">							classIds.<span class="built_in">push_back</span>(classIdPoint.x);</span><br><span class="line">							confidences.<span class="built_in">push_back</span>(max_class_socre);</span><br><span class="line">							boxes.<span class="built_in">push_back</span>(<span class="built_in">Rect</span>(left, top, <span class="built_in"><span class="keyword">int</span></span>(w*ratio_w), <span class="built_in"><span class="keyword">int</span></span>(h*ratio_h)));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					pdata += net_width;<span class="comment">//æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€è¡Œ</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//NMS</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; nms_result;</span><br><span class="line">	<span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nms_result.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> idx = nms_result[i];</span><br><span class="line">		Output result;</span><br><span class="line">		result.id = classIds[idx];</span><br><span class="line">		result.confidence = confidences[idx];</span><br><span class="line">		result.box = boxes[idx];</span><br><span class="line">		<span class="keyword">if</span> (result.id == <span class="number">0</span>) &#123;<span class="comment">//only cigar</span></span><br><span class="line">			output.<span class="built_in">push_back</span>(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; output.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().y);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// void printCoordinate(vector&lt;int&gt; &amp;detectResult) &#123;</span></span><br><span class="line"><span class="comment">// 	for (int i = 0; i &lt; detectResult.size()/4; i++) &#123;</span></span><br><span class="line"><span class="comment">// 		cout &lt;&lt; detectResult[i*4] &lt;&lt; &quot;\t&quot; &lt;&lt; detectResult[i * 4+1] &lt;&lt; &quot;\t&quot; &lt;&lt; detectResult[i * 4+2] &lt;&lt; &quot;\t&quot; &lt;&lt; detectResult[i * 4+3] &lt;&lt; &quot;\t&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	cout &lt;&lt; &quot;============================&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// int main()</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">// 	string img_path = &quot;./0 (6).png&quot;;</span></span><br><span class="line"><span class="comment">// 	string modelPath = &quot;./yolov5s.onnx&quot;;</span></span><br><span class="line"><span class="comment">// 	Yolo model;</span></span><br><span class="line"><span class="comment">// 	bool initFlag = false;</span></span><br><span class="line"><span class="comment">// 	clock_t start, end;//æ£€æµ‹è®¡æ—¶</span></span><br><span class="line"><span class="comment">// 	if (model.readModel(modelPath)) &#123;</span></span><br><span class="line"><span class="comment">// 		for (int c = 0; c &lt; 20; c++) &#123;//æ£€æµ‹20æ¬¡</span></span><br><span class="line"><span class="comment">// 			start = clock();</span></span><br><span class="line"><span class="comment">// 			Mat img = imread(img_path);</span></span><br><span class="line"><span class="comment">// 			vector&lt;int&gt; detectResult = model.detect(img);</span></span><br><span class="line"><span class="comment">// 			end = clock();</span></span><br><span class="line"><span class="comment">// 			cout &lt;&lt; &quot;Detect time:&quot; &lt;&lt; double(end - start) / CLOCKS_PER_SEC &lt;&lt; &quot;s&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// 			printCoordinate(detectResult);</span></span><br><span class="line"><span class="comment">// 		&#125;</span></span><br><span class="line"><span class="comment">// 	&#125;else &#123;</span></span><br><span class="line"><span class="comment">// 		cout &lt;&lt; &quot;æ¨¡å‹åˆå§‹åŒ–å¤±è´¥&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	return 0;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libpredict, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;yolov5s lib for python&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    py::class_&lt;Yolo&gt;(m, <span class="string">&quot;Yolo&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;readModel&quot;</span>, &amp;Yolo::readModel, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;detect&quot;</span>, &amp;Yolo::detect, py::return_value_policy::copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="pythonè°ƒç”¨so"><a href="#pythonè°ƒç”¨so" class="headerlink" title="pythonè°ƒç”¨so"></a>pythonè°ƒç”¨so</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> libpredict</span><br><span class="line"></span><br><span class="line">yolo = libpredict.Yolo()</span><br><span class="line">useGpu = <span class="literal">True</span></span><br><span class="line">modelPath = <span class="string">&#x27;./yolov5s.onnx&#x27;</span></span><br><span class="line">imgPath = <span class="string">&#x27;test.png&#x27;</span></span><br><span class="line"></span><br><span class="line">inited = yolo.readModel(modelPath,useGpu)</span><br><span class="line"><span class="keyword">if</span>(inited):</span><br><span class="line">    sumTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        img = cv2.imread(imgPath)</span><br><span class="line">        start = time.time()</span><br><span class="line">        result = yolo.detect(img)</span><br><span class="line">        end = time.time()</span><br><span class="line">        <span class="built_in">print</span>(end-start)</span><br><span class="line">        <span class="keyword">if</span> i!= <span class="number">0</span>:</span><br><span class="line">            sumTime+=(end-start)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;============&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(sumTime/<span class="number">19</span>)</span><br></pre></td></tr></table></figure>

<h3 id="æŠ¥é”™æ’æ›²"><a href="#æŠ¥é”™æ’æ›²" class="headerlink" title="æŠ¥é”™æ’æ›²"></a>æŠ¥é”™æ’æ›²</h3><p><img src="./image-20210722020258432.png" alt="image-20210722020258432"></p>
<p>å·²è§£å†³ï¼Œæ·»åŠ äº†#include&lt;pybind11/stl.h&gt;å¤´æ–‡ä»¶</p>
<p><img src="./image-20210722020644010.png" alt="image-20210722020644010"></p>
<p>ç°åœ¨çš„ç‘•ç–µæ˜¯dnnæ¨¡å—è¿˜ä¸æ”¯æŒcudaåŠ é€Ÿï¼Œå¦å¤–ï¼Œç°åœ¨<strong>è¿˜ä¸æ”¯æŒç›´æ¥ä¼ å…¥mat</strong>(åé¢è§£å†³)</p>
<h3 id="èœœæ±ç–‘é—®"><a href="#èœœæ±ç–‘é—®" class="headerlink" title="èœœæ±ç–‘é—®"></a>èœœæ±ç–‘é—®</h3><p>ä¸ºä»€ä¹ˆç”¨äº†pybind11åï¼Œæ¯”åŸå§‹çš„c++å®ç°æ›´å¿«äº†ï¼Ÿï¼Ÿ</p>
<p><img src="./@0VF94S5TTMAP%25%5BHHUK2E4O.png" alt="img"></p>
<p><img src="./image-20210722021039835.png" alt="image-20210722021039835"></p>
<h2 id="å®Œå–„"><a href="#å®Œå–„" class="headerlink" title="å®Œå–„"></a>å®Œå–„</h2><p>ä¸Šé¢çš„ç¨‹åºpythonä¸­ç›´æ¥ä¼ å…¥img pathï¼Œä½†æ˜¯æ˜¾ç„¶ä¼ å…¥opencvåŠ è½½çš„å›¾ç‰‡æ›´å…·ä¸€èˆ¬æ€§ã€‚ç„¶è€Œpythonä¸­çš„opencvåŠ è½½çš„å›¾ç‰‡æ˜¯ndarrayçš„æ ¼å¼ï¼ŒC++ä¸­æ˜¯cv::matã€‚<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/be16847b0b74?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation">å‚è€ƒ</a>è§£å†³ï¼Œä¸»è¦æ˜¯åœ¨cppä¸­å¢åŠ äº†ndarrayè½¬matçš„å‡½æ•°ã€‚</p>
<p>æœ€ç»ˆçš„cpp/pyå¦‚ä¸‹ï¼š</p>
<h3 id="ç”Ÿæˆsoçš„c-æºæ–‡ä»¶-1"><a href="#ç”Ÿæˆsoçš„c-æºæ–‡ä»¶-1" class="headerlink" title="ç”Ÿæˆsoçš„c++æºæ–‡ä»¶"></a>ç”Ÿæˆsoçš„c++æºæ–‡ä»¶</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/dnn.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/numpy.h&gt;</span><span class="comment">//add</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> dnn;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Output</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;<span class="comment">//ç±»åˆ«</span></span><br><span class="line">	<span class="keyword">float</span> confidence;<span class="comment">//ç½®ä¿¡åº¦</span></span><br><span class="line">	cv::Rect box;<span class="comment">//çŸ©å½¢æ¡†</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Python-&gt;C++ Mat</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_1c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;1-channel image must be 2 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC1, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_3c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;3-channel image must be 3 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC3, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(<span class="number">1.f</span> / (<span class="number">1.f</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netAnchors[<span class="number">3</span>][<span class="number">6</span>] = &#123; &#123; <span class="number">10.0</span>, <span class="number">13.0</span>, <span class="number">16.0</span>, <span class="number">30.0</span>, <span class="number">33.0</span>, <span class="number">23.0</span> &#125;,&#123; <span class="number">30.0</span>, <span class="number">61.0</span>, <span class="number">62.0</span>, <span class="number">45.0</span>, <span class="number">59.0</span>, <span class="number">119.0</span> &#125;,&#123; <span class="number">116.0</span>, <span class="number">90.0</span>, <span class="number">156.0</span>, <span class="number">198.0</span>, <span class="number">373.0</span>, <span class="number">326.0</span> &#125; &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netStride[<span class="number">3</span>] = &#123; <span class="number">8.0</span>, <span class="number">16.0</span>, <span class="number">32.0</span> &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netWidth = <span class="number">640</span>; <span class="comment">//è¾“å…¥å¤§å°</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netHeight = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;</span><br><span class="line">	<span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;</span><br><span class="line">	std::vector&lt;std::string&gt; className = &#123; <span class="string">&quot;cigar&quot;</span>,<span class="string">&quot;seatBelt&quot;</span> &#125;;<span class="comment">//ç±»å</span></span><br><span class="line">	Net net;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">readModel</span><span class="params">(std::string netPath, <span class="keyword">bool</span> isCuda)</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Yolo::readModel</span><span class="params">(string netPath, <span class="keyword">bool</span> isCuda = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		net = <span class="built_in">readNetFromONNX</span>(netPath);</span><br><span class="line">	&#125;<span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;<span class="comment">//use GPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_CUDA);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CUDA);</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;	<span class="comment">//use CPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_DEFAULT);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CPU);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">Yolo::detect</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span> </span>&#123;</span><br><span class="line">	Mat blob;</span><br><span class="line">	<span class="comment">// Mat SrcImg = imread(srcImg);</span></span><br><span class="line">	Mat SrcImg = <span class="built_in">numpy_uint8_3c_to_cv_mat</span>(input);</span><br><span class="line">	vector&lt;Output&gt; output;</span><br><span class="line">	<span class="built_in">blobFromImage</span>(SrcImg, blob, <span class="number">1</span> / <span class="number">255.0</span>, cv::<span class="built_in">Size</span>(netWidth, netHeight), <span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	net.<span class="built_in">setInput</span>(blob);</span><br><span class="line">	vector&lt;Mat&gt; netOutputImg;</span><br><span class="line">	net.forward(netOutputImg, net.<span class="built_in">getUnconnectedOutLayersNames</span>());</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; classIds;<span class="comment">//ç»“æœidæ•°ç»„</span></span><br><span class="line">	vector&lt;<span class="keyword">float</span>&gt; confidences;<span class="comment">//ç»“æœæ¯ä¸ªidå¯¹åº”ç½®ä¿¡åº¦æ•°ç»„</span></span><br><span class="line">	vector&lt;Rect&gt; boxes;<span class="comment">//æ¯ä¸ªidçŸ©å½¢æ¡†</span></span><br><span class="line">	<span class="keyword">float</span> ratio_h = (<span class="keyword">float</span>)SrcImg.rows / netHeight;</span><br><span class="line">	<span class="keyword">float</span> ratio_w = (<span class="keyword">float</span>)SrcImg.cols / netWidth;</span><br><span class="line">	<span class="keyword">int</span> net_width = className.<span class="built_in">size</span>() + <span class="number">5</span>;  <span class="comment">//è¾“å‡ºçš„ç½‘ç»œå®½åº¦æ˜¯ç±»åˆ«æ•°+5</span></span><br><span class="line">	<span class="keyword">float</span>* pdata = (<span class="keyword">float</span>*)netOutputImg[<span class="number">0</span>].data;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> stride = <span class="number">0</span>; stride &lt; <span class="number">3</span>; stride++) &#123;    <span class="comment">//stride</span></span><br><span class="line">		<span class="keyword">int</span> grid_x = (<span class="keyword">int</span>)(netWidth / netStride[stride]);</span><br><span class="line">		<span class="keyword">int</span> grid_y = (<span class="keyword">int</span>)(netHeight / netStride[stride]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> anchor = <span class="number">0</span>; anchor &lt; <span class="number">3</span>; anchor++) &#123; <span class="comment">//anchors</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_w = netAnchors[stride][anchor * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_h = netAnchors[stride][anchor * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid_y; i++) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid_y; j++) &#123;</span><br><span class="line">					<span class="keyword">float</span> box_score = <span class="built_in">Sigmoid</span>(pdata[<span class="number">4</span>]);<span class="comment">//è·å–æ¯ä¸€è¡Œçš„boxæ¡†ä¸­å«æœ‰æŸä¸ªç‰©ä½“çš„æ¦‚ç‡</span></span><br><span class="line">					<span class="keyword">if</span> (box_score &gt; boxThreshold) &#123;</span><br><span class="line">						<span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32FC1, pdata + <span class="number">5</span>)</span></span>;</span><br><span class="line">						Point classIdPoint;</span><br><span class="line">						<span class="keyword">double</span> max_class_socre;</span><br><span class="line">						cv::<span class="built_in">minMaxLoc</span>(scores, <span class="number">0</span>, &amp;max_class_socre, <span class="number">0</span>, &amp;classIdPoint);</span><br><span class="line">						max_class_socre = <span class="built_in">Sigmoid</span>((<span class="keyword">float</span>)max_class_socre);</span><br><span class="line">						<span class="keyword">if</span> (max_class_socre &gt; classThreshold) &#123;</span><br><span class="line">							<span class="keyword">float</span> x = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">0</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + j) * netStride[stride];  <span class="comment">//x</span></span><br><span class="line">							<span class="keyword">float</span> y = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">1</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + i) * netStride[stride];   <span class="comment">//y</span></span><br><span class="line">							<span class="keyword">float</span> w = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">2</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_w;   <span class="comment">//w</span></span><br><span class="line">							<span class="keyword">float</span> h = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">3</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_h;  <span class="comment">//h</span></span><br><span class="line">							<span class="keyword">int</span> left = (x - <span class="number">0.5</span>*w)*ratio_w;</span><br><span class="line">							<span class="keyword">int</span> top = (y - <span class="number">0.5</span>*h)*ratio_h;</span><br><span class="line">							classIds.<span class="built_in">push_back</span>(classIdPoint.x);</span><br><span class="line">							confidences.<span class="built_in">push_back</span>(max_class_socre);</span><br><span class="line">							boxes.<span class="built_in">push_back</span>(<span class="built_in">Rect</span>(left, top, <span class="built_in"><span class="keyword">int</span></span>(w*ratio_w), <span class="built_in"><span class="keyword">int</span></span>(h*ratio_h)));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					pdata += net_width;<span class="comment">//æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€è¡Œ</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//NMS</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; nms_result;</span><br><span class="line">	<span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nms_result.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> idx = nms_result[i];</span><br><span class="line">		Output result;</span><br><span class="line">		result.id = classIds[idx];</span><br><span class="line">		result.confidence = confidences[idx];</span><br><span class="line">		result.box = boxes[idx];</span><br><span class="line">		<span class="keyword">if</span> (result.id == <span class="number">0</span>) &#123;<span class="comment">//only cigar</span></span><br><span class="line">			output.<span class="built_in">push_back</span>(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; output.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().y);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libpredict, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;yolov5s lib for python&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    py::class_&lt;Yolo&gt;(m, <span class="string">&quot;Yolo&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;readModel&quot;</span>, &amp;Yolo::readModel, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;detect&quot;</span>, &amp;Yolo::detect, py::return_value_policy::copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="pythonè°ƒç”¨so-1"><a href="#pythonè°ƒç”¨so-1" class="headerlink" title="pythonè°ƒç”¨so"></a>pythonè°ƒç”¨so</h3><p>è¿™æ—¶ï¼Œpythonä¸­ä½¿ç”¨æ—¶ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯imreadåçš„ndarray</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> libpredict</span><br><span class="line">yolo = libpredict.Yolo()</span><br><span class="line">initFlag = yolo.readModel(<span class="string">&quot;./yolov5s.onnx&quot;</span>,<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span>(initFlag):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    	img = cv2.imread(<span class="string">&quot;./0 (6).png&quot;</span>)</span><br><span class="line">    	start = time.time()</span><br><span class="line">    	result = yolo.detect(img)</span><br><span class="line">    	<span class="built_in">print</span>(time.time()-start)</span><br><span class="line">    	<span class="built_in">print</span>(result)</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&#x27;============&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="é€Ÿåº¦å¯¹æ¯”"><a href="#é€Ÿåº¦å¯¹æ¯”" class="headerlink" title="é€Ÿåº¦å¯¹æ¯”"></a>é€Ÿåº¦å¯¹æ¯”</h3><p>yolov5sæ£€æµ‹é€Ÿåº¦å¯¹æ¯”(åŒä¸€å¼ å›¾ç‰‡ï¼Œ20æ¬¡å–å¹³å‡)</p>
<ul>
<li><p>Tesla V100-SXM2 32GBï¼Œ<strong>ç©ºè½½</strong></p>
</li>
<li><p>Intel(R) Xeon(R) Gold 6240 CPU @ 2.60GHz</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">è¯­è¨€</th>
<th align="center">æ¡†æ¶</th>
<th align="center">æ¨¡å‹</th>
<th align="center">æ—¶é—´</th>
<th align="center">å¤‡æ³¨</th>
<th>æ˜¾å­˜å ç”¨</th>
<th align="center">è·¯å¾„</th>
</tr>
</thead>
<tbody><tr>
<td align="center">C++</td>
<td align="center">opencv 4.4.0+cuda</td>
<td align="center">onnx</td>
<td align="center">å19æ¬¡å¹³å‡32.3ms</td>
<td align="center">ç¬¬ä¸€æ¬¡éœ€è¦2så¤š</td>
<td>1130MB</td>
<td align="center">~/cvyolo_cpp/predict.cpp</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">opencv 4.4.0+cuda+<strong>so</strong></td>
<td align="center">onnx</td>
<td align="center">å19æ¬¡å¹³å‡<strong>14.9ms</strong></td>
<td align="center">ç¬¬ä¸€æ¬¡éœ€è¦3så¤š</td>
<td>1260MB</td>
<td align="center">~/cvyolo/pytest.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">pytorch 1.8.1+cuda</td>
<td align="center">pt</td>
<td align="center">169ms</td>
<td align="center">æ–¹å·®å°ï¼Œä½†æ˜¯æ¯”æˆ‘1650è¿˜æ…¢</td>
<td>1415MB</td>
<td align="center">~/v5/yolov5/predict.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">python-opencv</td>
<td align="center">onnx</td>
<td align="center">689ms</td>
<td align="center">æ–¹å·®å°</td>
<td>Pass(CPU)</td>
<td align="center">~/cvyolo/opencvYOLO.py</td>
</tr>
</tbody></table>
<h3 id="ç³Ÿç³•çš„ç²¾åº¦"><a href="#ç³Ÿç³•çš„ç²¾åº¦" class="headerlink" title="ç³Ÿç³•çš„ç²¾åº¦"></a>ç³Ÿç³•çš„ç²¾åº¦</h3><p>è¿™ä¸ªé€Ÿåº¦å·²ç»ç›¸å½“ä»¤æˆ‘æ»¡æ„äº†ï¼Œpybind11ç”Ÿæˆsoåï¼Œç¬¬äºŒè¡Œpythonä¸­çš„ç»“æœå’Œç¬¬ä¸€è¡Œc++ä¸­çš„æ¨ç†ç»“æœä¸€è‡´ï¼Œä¸”è€—æ—¶æ›´çŸ­ã€‚</p>
<p>ä½†æ˜¯å½“å’ŒåŸç‰ˆpytorchçš„ptæ¨¡å‹å¯¹æ¯”æ—¶ï¼Œå‘ç°ç²¾åº¦æ‰äº†å¤ªå¤šï¼Œäºæ˜¯å°è¯•æå‡æ¨¡å‹ç²¾åº¦ã€‚</p>
<p>èƒ½æƒ³åˆ°çš„å‡ ä¸ªæ–¹æ³•æ˜¯ï¼š</p>
<ul>
<li>ä½¿ç”¨yolov5mè®­ç»ƒçš„æƒé‡å†è½¬onnx(è™½ç„¶yolov5måœ¨pytorchä¸­çš„é€Ÿåº¦æ¯”v5sæ…¢ä¸€äº›ï¼Œä½†æ˜¯ç²¾åº¦é«˜ä¸€äº›)</li>
<li>æƒ³åŠæ³•ä¿®æ”¹ä¸€ä¸‹åå¤„ç†çš„éƒ¨åˆ†(NMS)</li>
</ul>
<h4 id="ä¿®æ”¹boxThreshold"><a href="#ä¿®æ”¹boxThreshold" class="headerlink" title="ä¿®æ”¹boxThreshold"></a>ä¿®æ”¹boxThreshold</h4><p>pytorchæ–¹å¼å¯¹æ¯”opencv onnxæ–¹å¼çš„åŒºåˆ«åœ¨äºåå¤„ç†ä¸ä¸€æ ·ï¼Œpytorchçš„åå¤„ç†å®˜æ–¹åœ¨predict.pyä¸­å†™å¥½äº†ï¼Œopencvçš„åå¤„ç†æ˜¯copyåˆ«äººçš„githubé¡¹ç›®ï¼Œå¦å¤–copyæ¥çš„é‡Œé¢æœ‰3ä¸ªå¯æ§çš„å‚æ•°ï¼Œ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;<span class="comment">//a threshold used in non maximum suppression.</span></span><br><span class="line"><span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;<span class="comment">//a threshold used to filter boxes by score.</span></span><br><span class="line"><span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;<span class="comment">//è¿™ä¸ªæ²¡æœ‰ç”¨åœ¨NMSä¸­ï¼Œè¡¨ç¤ºå«æœ‰æŸä¸ªç‰©ä½“çš„æ¦‚ç‡</span></span><br><span class="line"><span class="comment">//è°ƒç”¨æ—¶æ ¸å¿ƒæ˜¯ä½¿ç”¨ä¸‹é¢çš„çš„å‡½æ•°</span></span><br><span class="line"><span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line"><span class="comment">//å£°æ˜å¦‚ä¸‹</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NMSBoxes</span><span class="params">(<span class="keyword">const</span> std::vector&lt;Rect&gt;&amp; bboxes, <span class="keyword">const</span> std::vector&lt;<span class="keyword">float</span>&gt;&amp; scores,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">const</span> <span class="keyword">float</span> score_threshold, <span class="keyword">const</span> <span class="keyword">float</span> nms_threshold,</span></span></span><br><span class="line"><span class="params"><span class="function">                               CV_OUT std::vector&lt;<span class="keyword">int</span>&gt;&amp; indices,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">const</span> <span class="keyword">float</span> eta = <span class="number">1.f</span>, <span class="keyword">const</span> <span class="keyword">int</span> top_k = <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="comment">/** @brief Performs non maximum suppression given boxes and corresponding scores.</span></span><br><span class="line"><span class="comment">     * @param bboxes a set of bounding boxes to apply NMS.</span></span><br><span class="line"><span class="comment">     * @param scores a set of corresponding confidences.</span></span><br><span class="line"><span class="comment">     * @param score_threshold a threshold used to filter boxes by score.</span></span><br><span class="line"><span class="comment">     * @param nms_threshold a threshold used in non maximum suppression.</span></span><br><span class="line"><span class="comment">     * @param indices the kept indices of bboxes after NMS.</span></span><br><span class="line"><span class="comment">     * @param eta a coefficient in adaptive threshold formula: \f$nms\_threshold_&#123;i+1&#125;=eta\cdot nms\_threshold_i\f$.</span></span><br><span class="line"><span class="comment">     * @param top_k if `&gt;0`, keep at most @p top_k picked indices.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure>

<p>åœ¨åŸç‰ˆyolov5çš„predict.pyä¸­åªæœ‰ä¸¤ä¸ªï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conf_thres=<span class="number">0.25</span>,  <span class="comment"># confidence threshold</span></span><br><span class="line">iou_thres=<span class="number">0.45</span>,  <span class="comment"># NMS IOU threshold</span></span><br></pre></td></tr></table></figure>

<p>å°è¯•æŠŠboxThresholdè°ƒé«˜ä¸€ç‚¹ï¼Œå¦‚0.4</p>
<p>è°ƒæ•´å‰åå¯¹æ¯”ï¼Œå‘ç°ç¡®å®å°‘äº†ä¸€ä¸ªæ¡†ï¼Œä½†æ˜¯ç•™ä¸‹çš„è¿™ä¸ªæ›´ç¦»è°±ã€‚ã€‚ã€‚</p>
<blockquote>
<p>ptæ¨¡å‹æ²¡æœ‰æ£€æµ‹åˆ°ç›®æ ‡ï¼Œonnxæ£€æµ‹åˆ°ä¸¤ä¸ªæ¡†(çœŸå®çš„ç›®æ ‡å’Œå­—æ¯Pçš„ç«–çº¿)ã€‚</p>
<p>ä½†æ˜¯æ”¹äº†boxThresholdåï¼ŒæŠŠPçš„ç«–çº¿ç•™ä¸‹äº†ã€‚ã€‚ã€‚</p>
</blockquote>
<p><img src="./image-20210722222533236.png" alt="before(python+so)"></p>
<p><img src="./image-20210722222622332.png" alt="after(c++)"></p>
<p><img src="./image-20210722222841636.png" alt="image-20210722222841636"></p>
<h4 id="yolov5m-pt-gt-yolov5m-onnx"><a href="#yolov5m-pt-gt-yolov5m-onnx" class="headerlink" title="yolov5m.pt-&gt;yolov5m.onnx"></a>yolov5m.pt-&gt;yolov5m.onnx</h4><blockquote>
<p>æ­¤æ—¶boxThresholdæ”¹ä¸ºåŸå§‹çš„0.25</p>
</blockquote>
<p>å·²ç”Ÿæˆonnx(E:\projs\v5\yolov5\runs\train\exp15\weights)ï¼Œä½†æ˜¯æ¨¡å‹æ–‡ä»¶ç«Ÿç„¶åˆ°äº†80MB+</p>
<p>æŠ½è±¡çš„è¾“å‡ºåˆæ¥äº†ï¼Œè€Œä¸”è¿™æ¬¡è€—æ—¶æ›´ä¹…ã€‚</p>
<p><img src="./image-20210722232421332.png" alt="image-20210722232421332"></p>
<p>ä¸‹é¢è¯•è¯•ptåŸç‰ˆè€—æ—¶å¤šä¹…ï¼Œæ£€æµ‹okï¼Œæ‰€ä»¥è¿˜æ˜¯<strong>pt-&gt;pth-&gt;onnx</strong>å‡ºäº†é—®é¢˜</p>
<p><img src="./image-20210722233227768.png" alt="image-20210722233227768"></p>
<h5 id="å¤±è´¥çš„çŒœæƒ³"><a href="#å¤±è´¥çš„çŒœæƒ³" class="headerlink" title="å¤±è´¥çš„çŒœæƒ³"></a>å¤±è´¥çš„çŒœæƒ³</h5><p>å°è¯•ä¸€ä¸‹ä½¿ç”¨ptç›´æ¥è½¬onnxï¼Œç”Ÿæˆçš„onnxå¤§å°84.2MB</p>
<p>é—®é¢˜æ¥äº†ï¼ŒåŒæ ·æ˜¯ä¸‹é¢ä¸€æ®µï¼Œåœ¨windowså¯ç”¨ï¼Œubuntuä¸å¯ç”¨</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/dnn.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> dnn;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Output</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;<span class="comment">//ç±»åˆ«</span></span><br><span class="line">	<span class="keyword">float</span> confidence;<span class="comment">//ç½®ä¿¡åº¦</span></span><br><span class="line">	cv::Rect box;<span class="comment">//çŸ©å½¢æ¡†</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(<span class="number">1.f</span> / (<span class="number">1.f</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netAnchors[<span class="number">3</span>][<span class="number">6</span>] = &#123; &#123; <span class="number">10.0</span>, <span class="number">13.0</span>, <span class="number">16.0</span>, <span class="number">30.0</span>, <span class="number">33.0</span>, <span class="number">23.0</span> &#125;,&#123; <span class="number">30.0</span>, <span class="number">61.0</span>, <span class="number">62.0</span>, <span class="number">45.0</span>, <span class="number">59.0</span>, <span class="number">119.0</span> &#125;,&#123; <span class="number">116.0</span>, <span class="number">90.0</span>, <span class="number">156.0</span>, <span class="number">198.0</span>, <span class="number">373.0</span>, <span class="number">326.0</span> &#125; &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netStride[<span class="number">3</span>] = &#123; <span class="number">8.0</span>, <span class="number">16.0</span>, <span class="number">32.0</span> &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netWidth = <span class="number">640</span>; <span class="comment">//è¾“å…¥å¤§å°</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netHeight = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;</span><br><span class="line">	<span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;</span><br><span class="line">	std::vector&lt;std::string&gt; className = &#123; <span class="string">&quot;cigar&quot;</span>,<span class="string">&quot;seatBelt&quot;</span> &#125;;<span class="comment">//ç±»å</span></span><br><span class="line">	Net net;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">readModel</span><span class="params">(std::string netPath, <span class="keyword">bool</span> isCuda)</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">(string SrcImg)</span></span>;</span><br><span class="line">	<span class="comment">// vector&lt;int&gt; detect(py::array_t&lt;unsigned char&gt;&amp; input);//ç”Ÿæˆsoæ–‡ä»¶è¦ç”¨è¿™ä¸ª</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Yolo::readModel</span><span class="params">(string netPath, <span class="keyword">bool</span> isCuda = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		net = <span class="built_in">readNetFromONNX</span>(netPath);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;<span class="comment">//use GPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_CUDA);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CUDA);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;	<span class="comment">//use CPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_DEFAULT);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CPU);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">Yolo::detect</span><span class="params">(string srcImg)</span> </span>&#123;</span><br><span class="line">	Mat blob;</span><br><span class="line">	Mat SrcImg = <span class="built_in">imread</span>(srcImg);</span><br><span class="line">	<span class="comment">// Mat SrcImg = numpy_uint8_3c_to_cv_mat(input);//soæ–‡ä»¶è¦ç”¨</span></span><br><span class="line">	vector&lt;Output&gt; output;</span><br><span class="line">	<span class="built_in">blobFromImage</span>(SrcImg, blob, <span class="number">1</span> / <span class="number">255.0</span>, cv::<span class="built_in">Size</span>(netWidth, netHeight), <span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	net.<span class="built_in">setInput</span>(blob);</span><br><span class="line">	vector&lt;Mat&gt; netOutputImg;</span><br><span class="line">	net.forward(netOutputImg, net.<span class="built_in">getUnconnectedOutLayersNames</span>());</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; classIds;<span class="comment">//ç»“æœidæ•°ç»„</span></span><br><span class="line">	vector&lt;<span class="keyword">float</span>&gt; confidences;<span class="comment">//ç»“æœæ¯ä¸ªidå¯¹åº”ç½®ä¿¡åº¦æ•°ç»„</span></span><br><span class="line">	vector&lt;Rect&gt; boxes;<span class="comment">//æ¯ä¸ªidçŸ©å½¢æ¡†</span></span><br><span class="line">	<span class="keyword">float</span> ratio_h = (<span class="keyword">float</span>)SrcImg.rows / netHeight;</span><br><span class="line">	<span class="keyword">float</span> ratio_w = (<span class="keyword">float</span>)SrcImg.cols / netWidth;</span><br><span class="line">	<span class="keyword">int</span> net_width = className.<span class="built_in">size</span>() + <span class="number">5</span>;  <span class="comment">//è¾“å‡ºçš„ç½‘ç»œå®½åº¦æ˜¯ç±»åˆ«æ•°+5</span></span><br><span class="line">	<span class="keyword">float</span>* pdata = (<span class="keyword">float</span>*)netOutputImg[<span class="number">0</span>].data;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> stride = <span class="number">0</span>; stride &lt; <span class="number">3</span>; stride++) &#123;    <span class="comment">//stride</span></span><br><span class="line">		<span class="keyword">int</span> grid_x = (<span class="keyword">int</span>)(netWidth / netStride[stride]);</span><br><span class="line">		<span class="keyword">int</span> grid_y = (<span class="keyword">int</span>)(netHeight / netStride[stride]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> anchor = <span class="number">0</span>; anchor &lt; <span class="number">3</span>; anchor++) &#123; <span class="comment">//anchors</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_w = netAnchors[stride][anchor * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_h = netAnchors[stride][anchor * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid_y; i++) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid_y; j++) &#123;</span><br><span class="line">					<span class="keyword">float</span> box_score = <span class="built_in">Sigmoid</span>(pdata[<span class="number">4</span>]);<span class="comment">//è·å–æ¯ä¸€è¡Œçš„boxæ¡†ä¸­å«æœ‰æŸä¸ªç‰©ä½“çš„æ¦‚ç‡</span></span><br><span class="line">					<span class="keyword">if</span> (box_score &gt; boxThreshold) &#123;</span><br><span class="line">						<span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32FC1, pdata + <span class="number">5</span>)</span></span>;</span><br><span class="line">						Point classIdPoint;</span><br><span class="line">						<span class="keyword">double</span> max_class_socre;</span><br><span class="line">						cv::<span class="built_in">minMaxLoc</span>(scores, <span class="number">0</span>, &amp;max_class_socre, <span class="number">0</span>, &amp;classIdPoint);</span><br><span class="line">						max_class_socre = <span class="built_in">Sigmoid</span>((<span class="keyword">float</span>)max_class_socre);</span><br><span class="line">						<span class="keyword">if</span> (max_class_socre &gt; classThreshold) &#123;</span><br><span class="line">							<span class="keyword">float</span> x = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">0</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + j) * netStride[stride];  <span class="comment">//x</span></span><br><span class="line">							<span class="keyword">float</span> y = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">1</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + i) * netStride[stride];   <span class="comment">//y</span></span><br><span class="line">							<span class="keyword">float</span> w = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">2</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_w;   <span class="comment">//w</span></span><br><span class="line">							<span class="keyword">float</span> h = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">3</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_h;  <span class="comment">//h</span></span><br><span class="line">							<span class="keyword">int</span> left = (x - <span class="number">0.5</span>*w)*ratio_w;</span><br><span class="line">							<span class="keyword">int</span> top = (y - <span class="number">0.5</span>*h)*ratio_h;</span><br><span class="line">							classIds.<span class="built_in">push_back</span>(classIdPoint.x);</span><br><span class="line">							confidences.<span class="built_in">push_back</span>(max_class_socre);</span><br><span class="line">							boxes.<span class="built_in">push_back</span>(<span class="built_in">Rect</span>(left, top, <span class="built_in"><span class="keyword">int</span></span>(w*ratio_w), <span class="built_in"><span class="keyword">int</span></span>(h*ratio_h)));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					pdata += net_width;<span class="comment">//æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€è¡Œ</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//NMS</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; nms_result;</span><br><span class="line">	<span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nms_result.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> idx = nms_result[i];</span><br><span class="line">		Output result;</span><br><span class="line">		result.id = classIds[idx];</span><br><span class="line">		result.confidence = confidences[idx];</span><br><span class="line">		result.box = boxes[idx];</span><br><span class="line">		<span class="keyword">if</span> (result.id == <span class="number">0</span>) &#123;<span class="comment">//only cigar</span></span><br><span class="line">			output.<span class="built_in">push_back</span>(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; output.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().y);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printCoordinate</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;detectResult)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; detectResult.<span class="built_in">size</span>() / <span class="number">4</span>; i++) &#123;</span><br><span class="line">		cout &lt;&lt; detectResult[i * <span class="number">4</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span> + <span class="number">1</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span> + <span class="number">2</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span> + <span class="number">3</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;============================&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	string modelPath = <span class="string">&quot;E:/projs/v5/yolov5/runs/train/exp15/weights/yolov5m_best.onnx&quot;</span>;</span><br><span class="line">	Yolo model;</span><br><span class="line">	string img_path = <span class="string">&quot;F:/cvTest/000.jpg&quot;</span>;</span><br><span class="line">	<span class="comment">//string img_path = &quot;./0 (6).png&quot;;</span></span><br><span class="line">	<span class="keyword">bool</span> initFlag = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">clock_t</span> start, end;<span class="comment">//æ£€æµ‹è®¡æ—¶</span></span><br><span class="line">	<span class="keyword">if</span> (model.<span class="built_in">readModel</span>(modelPath)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">20</span>; c++) &#123;<span class="comment">//æ£€æµ‹20æ¬¡</span></span><br><span class="line">			start = <span class="built_in">clock</span>();</span><br><span class="line">			<span class="comment">//soæ–‡ä»¶</span></span><br><span class="line">			<span class="comment">// Mat img = imread(img_path);</span></span><br><span class="line">			<span class="comment">// vector&lt;int&gt; detectResult = model.detect(img);</span></span><br><span class="line">			<span class="comment">//å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">			vector&lt;<span class="keyword">int</span>&gt; detectResult = model.<span class="built_in">detect</span>(img_path);</span><br><span class="line">			end = <span class="built_in">clock</span>();</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Detect time:&quot;</span> &lt;&lt; <span class="built_in"><span class="keyword">double</span></span>(end - start) / CLOCKS_PER_SEC &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="built_in">printCoordinate</span>(detectResult);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;æ¨¡å‹åˆå§‹åŒ–å¤±è´¥&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ubuntuæŠ¥é”™å†…å®¹ä¸º</p>
<p><img src="./image-20210723123411146.png" alt="image-20210723123411146"></p>
<p><strong>å’Œä¸Šé¢ä½¿ç”¨yolov5sçš„æŠ¥é”™ä¸€è‡´ï¼Œä»”ç»†çœ‹CV_32FC1å’ŒCV_32SC1</strong>ï¼Œæ„Ÿè§‰åœ¨æºç é‡Œè§è¿‡ï¼Ÿå°è¯•ä¿®æ”¹æºç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cv::Mat scores(1, className.size(), CV_32FC1, pdata + 5);//åŸå§‹ç‰ˆæœ¬</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32SC1, pdata + <span class="number">5</span>)</span></span>;<span class="comment">//æ”¹æˆè¿™ä¸ª</span></span><br></pre></td></tr></table></figure>

<p>ç»“æœè¿˜æ˜¯ä¸è¡Œï¼Œçœ‹æ¥æ²¡è¿™ä¹ˆç®€å•</p>
<p><img src="./image-20210723123944869.png" alt="image-20210723123944869"></p>
<p>è¿˜æ˜¯æ”¹å›å»å§ï¼Œè€è€å®å®ç”¨ptè½¬pthå†è½¬onnx</p>
<h5 id="pt2pth2onnx"><a href="#pt2pth2onnx" class="headerlink" title="pt2pth2onnx"></a>pt2pth2onnx</h5><p>ä¸¤ä¸ªç‰ˆæœ¬çš„convertï¼Œè€—æ—¶ä¸ä¸€æ ·ï¼Ÿ</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hpc203/yolov5-dnn-cpp-python">è¿™ä¸ªç‰ˆæœ¬</a>è€—æ—¶å¾ˆé•¿ï¼Œæ£€æµ‹å‡ºæŠ½è±¡å›¾ç‰‡</p>
<p><img src="./image-20210723141755679.png" alt="image-20210723141755679"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hpc203/yolov5-dnn-cpp-python-v2">è¿™ä¸ª</a>é€Ÿåº¦æ­£å¸¸äº†è®¸å¤šï¼Œä½†æ˜¯æ£€æµ‹ä¸åˆ°ç›®æ ‡ï¼Ÿï¼Ÿï¼Ÿ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string model_path = <span class="string">&quot;F:/Downloads/chromeDownload/yolov5-dnn-cpp-python-v2-main/convert-onnx/yolov5m.onnx&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210723141854704.png" alt="image-20210723141854704"></p>
<p>æŒºå®¹æ˜“æ¼æ£€ï¼Œubuntu c++å¯ä»¥è·‘é€šï¼Œè½¬æˆsoæ”¾åœ¨pythoné‡Œå¯¹æ¯”å‘ç°ï¼Œpythoné‡Œé¢å¹³å‡æ£€æµ‹æ—¶é—´ä»v5sçš„15msæåˆ°äº†å½“å‰v5mçš„20mså·¦å³ï¼Œä½†æ˜¯ç²¾ç¡®åº¦åŒåŒæ‹‰è·¨ã€‚</p>
<p>å› ä¸ºè®­ç»ƒæ•°æ®å¹¶ä¸å¤šï¼Œæ‰€ä»¥å°±æ²¡å°è¯•æ›´å¤§çš„v5lå’Œv5xäº†ã€‚</p>
<h1 id="èƒ¡æ€ä¹±æƒ³"><a href="#èƒ¡æ€ä¹±æƒ³" class="headerlink" title="èƒ¡æ€ä¹±æƒ³"></a>èƒ¡æ€ä¹±æƒ³</h1><ul>
<li><input checked="" disabled="" type="checkbox"> å…¶å®å¯ä»¥æš´éœ²ä¸€ä¸ªè®©dnné€‰æ‹©æŒ‡å®šcudaçš„æ¥å£(é™„å½•äº”)</li>
<li><input checked="" disabled="" type="checkbox"> ä¸Šé•œç‡å¾ˆé«˜çš„é‚£ä¸ªåšå®¢é‡Œé¢è¯„è®ºåŒºä¹Ÿæåˆ°äº†ç²¾åº¦ä¸‹é™çš„é—®é¢˜ï¼Œè¯„è®ºåŒºæœ‰äººæåˆ°ä¸€ä¸ªlibtorchï¼Œè¿™æ‰æƒ³èµ·æ¥å®˜æ–¹ç»™çš„exporté‡Œé¢ï¼Œé™¤äº†å¯ä»¥è½¬onnxï¼Œè¿˜å¯ä»¥è½¬libtorchï¼Œä»¥åŠcoreml(Appleçš„æœºå™¨å­¦ä¹ æ¡†æ¶)ï¼Œæ‰€ä»¥ä¸‹é¢å°è¯•libtorch</li>
</ul>
<h1 id="libtorch"><a href="#libtorch" class="headerlink" title="libtorch"></a>libtorch</h1><blockquote>
<p>LibTorchæ˜¯åŸºäºPyTorchçš„åŒ…å«å¤´æ–‡ä»¶ï¼Œåº“æ–‡ä»¶å’ŒCMakeç¼–è¯‘ï¼ˆé…ç½®ï¼‰æ–‡ä»¶çš„C++ APIã€‚</p>
</blockquote>
<p>ubuntuä¸Šçš„å®‰è£…è®°å½•å¦‚ä¸‹</p>
<h2 id="ä¸‹è½½-æœ‰å‘"><a href="#ä¸‹è½½-æœ‰å‘" class="headerlink" title="ä¸‹è½½(æœ‰å‘)"></a>ä¸‹è½½(æœ‰å‘)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o libtorch https://download.pytorch.org/libtorch/cu102/libtorch-shared-with-deps-1.8.1%2Bcu102.zip</span><br></pre></td></tr></table></figure>

<h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/john_bh/article/details/108221748">å‚è€ƒæ–‡ç« </a></p>
<blockquote>
<p>çœ‹æ•™ç¨‹è¿‡ç¨‹ä¸­å‘ç°ä¸€ä¸ªpython-cåµŒå…¥cmakeçš„å‘½ä»¤ï¼Œcool</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -DCMAKE_PREFIX_PATH=`python -c <span class="string">&#x27;import torch;print(torch.utils.cmake_prefix_path)&#x27;</span>`</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> libtorch</span><br><span class="line">mkdir example</span><br><span class="line"><span class="built_in">cd</span> example</span><br></pre></td></tr></table></figure>

<p>cmakelists:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span> FATAL_ERROR)</span><br><span class="line"><span class="keyword">project</span>(example-app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(Torch REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; $&#123;TORCH_CXX_FLAGS&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(example-app example-app.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(example-app <span class="string">&quot;$&#123;TORCH_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">set_property</span>(<span class="keyword">TARGET</span> example-app PROPERTY CXX_STANDARD <span class="number">14</span>)</span><br></pre></td></tr></table></figure>

<p>example-app.cpp:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;torch/torch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt;<span class="string">&quot;cuda::is_available():&quot;</span> &lt;&lt; torch::cuda::<span class="built_in">is_available</span>() &lt;&lt; std::endl;</span><br><span class="line">  torch::Tensor tensor = torch::<span class="built_in">rand</span>(&#123;<span class="number">2</span>, <span class="number">3</span>&#125;);</span><br><span class="line">  std::cout &lt;&lt; tensor &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build	</span><br><span class="line"><span class="comment">#cmake -DCMAKE_PREFIX_PATH=/absolute/path/to/libtorch ..</span></span><br><span class="line">cmake -DCMAKE_PREFIX_PATH=/home/ubuntu/users/jazzy/libtorch ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>èŠœæ¹–ï¼šCPUï¼Ÿï¼Ÿï¼Ÿ</p>
<p><img src="./image-20210723170929884.png" alt="image-20210723170929884"></p>
<h2 id="åŠ è½½æ¨¡å‹"><a href="#åŠ è½½æ¨¡å‹" class="headerlink" title="åŠ è½½æ¨¡å‹"></a>åŠ è½½æ¨¡å‹</h2><p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/376149679">https://zhuanlan.zhihu.com/p/376149679</a></p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/ncdhz/YoloV5-LibTorch">https://github.com/ncdhz/YoloV5-LibTorch</a></p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/yasenh/libtorch-yolov5">https://github.com/yasenh/libtorch-yolov5</a> starå¥½å¤š</p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/SwordSing/libtorch-yolov5">https://github.com/SwordSing/libtorch-yolov5</a> è¿™ä¸ªç²¾ç®€</p>
<p><img src="./image-20210723183855153.png" alt="image-20210723183855153"></p>
<h2 id="å¤§å‘"><a href="#å¤§å‘" class="headerlink" title="å¤§å‘"></a>å¤§å‘</h2><p>ä¸Šé¢çš„libtorchå’Œopencvä¸€èµ·ç”¨çš„æ—¶å€™ç¼–è¯‘ä¸é€šè¿‡ï¼Œä¸€å †ç±»ä¼¼undefined reference to `cv::imreadçš„é—®é¢˜ã€‚</p>
<p>æŸ¥äº†å¾ˆå¤šèµ„æ–™ï¼Œæ‰¾åˆ°<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/62124555/cant-link-a-project-using-cmake-with-opencv-and-libtorch">è¿™ä¸ª</a>ï¼š</p>
<p><img src="./image-20210723223009737.png" alt="image-20210723223009737"></p>
<p>äºæ˜¯é‡æ–°ä¸‹è¿™ä¸ªlibtorch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://download.pytorch.org/libtorch/cu102/libtorch-cxx11-abi-shared-with-deps-1.8.1%2Bcu102.zip</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘é€šè¿‡ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/BIGBALLON/PyTorch-CPP">è¿™ä¸ªä¾‹å­</a>è¿™æ¬¡è·‘å¾—å¾ˆé¡º</p>
<p><img src="./image-20210723223911763.png" alt="image-20210723223911763"></p>
<h2 id="remake-Ã—"><a href="#remake-Ã—" class="headerlink" title="remake(Ã—)"></a>remake(Ã—)</h2><p>ä½¿ç”¨ï¼š<a target="_blank" rel="noopener" href="https://github.com/yasenh/libtorch-yolov5">https://github.com/yasenh/libtorch-yolov5</a></p>
<p>é—®é¢˜ï¼šimwriteå‡ºé”™</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./libtorch-yolov5 --weights <span class="string">&quot;../official_yolov5s.torchscript.pt&quot;</span> --source <span class="string">&quot;/home/ubuntu/users/jazzy/cvyolo/0 (6).png&quot;</span> --view-img <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724005744222.png" alt="image-20210724005744222"></p>
<p>è§£å†³ï¼šimwriteæ—¶å€™æ”¹æˆç»å¯¹è·¯å¾„</p>
<p><img src="./image-20210724005908718.png" alt="image-20210724005908718"></p>
<p>è¯†åˆ«ç»“æœæ˜¯è¿™ä¸ªæ ·å­ï¼Œè¯´æ˜yolov5è½¬torchscriptæˆåŠŸè¢«è¯»å…¥äº†ï¼Œä¸è¿‡è¿™ä¸ªtimeæœ‰ç‚¹æ‰å¿ƒï¼Ÿä¹Ÿå¯èƒ½æ˜¯æ¨¡å‹æœ¬èº«å¤ªå¤§å¯¼è‡´çš„ã€‚</p>
<p><img src="./image-20210724005934382.png" alt="image-20210724005934382"></p>
<p>å‡†å¤‡å¯¼å…¥è‡ªå·±çš„è¯•è¯•ã€‚è€Œä¸”cppé‡Œé¢ä¸œè¥¿å¤ªå¤šï¼Œå¾—ç²¾ç®€ä¸€ä¸‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 22 ms</span><br><span class="line">[W NNPACK.cpp:80] Could not initialize NNPACK! Reason: Unsupported hardware.</span><br><span class="line">inference takes : 1153 ms</span><br><span class="line">post-process takes : 5 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 744 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 925 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 10 ms</span><br><span class="line">inference takes : 771 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 7 ms</span><br><span class="line">inference takes : 832 ms</span><br><span class="line">post-process takes : 23 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 8 ms</span><br><span class="line">inference takes : 640 ms</span><br><span class="line">post-process takes : 13 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 335 ms</span><br><span class="line">post-process takes : 32 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 524 ms</span><br><span class="line">post-process takes : 14 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 492 ms</span><br><span class="line">post-process takes : 21 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 12 ms</span><br><span class="line">inference takes : 698 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 7 ms</span><br><span class="line">inference takes : 415 ms</span><br><span class="line">post-process takes : 18 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 520 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 603 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 9 ms</span><br><span class="line">inference takes : 318 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 499 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 528 ms</span><br><span class="line">post-process takes : 18 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 331 ms</span><br><span class="line">post-process takes : 12 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 704 ms</span><br><span class="line">post-process takes : 15 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 8 ms</span><br><span class="line">inference takes : 494 ms</span><br><span class="line">post-process takes : 14 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 496 ms</span><br><span class="line">post-process takes : 26 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 696 ms</span><br><span class="line">post-process takes : 13 ms</span><br><span class="line">img saved~</span><br></pre></td></tr></table></figure>

<p>æ‰“æ‰°äº†ã€‚ã€‚ã€‚ä¸Šé¢æ²¡å¼€cudaåŠ é€Ÿï¼Œéƒ½æ˜¯CPUè·‘çš„</p>
<p><img src="./image-20210724011834389.png" alt="image-20210724011834389"></p>
<p>è®¾ç½®æˆtrueä¹‹åå‘ç°ï¼Œï¼Œï¼Œä¼¼ä¹æœ‰imgè¿˜å­˜åœ¨cpuä¸Š</p>
<p><img src="./image-20210724011943591.png" alt="image-20210724011943591"></p>
<p>ç°åœ¨çš„mainæ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;detector.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cxxopts.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;std::string&gt; <span class="title">LoadNames</span><span class="params">(<span class="keyword">const</span> std::string&amp; path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// load class names</span></span><br><span class="line">    std::vector&lt;std::string&gt; class_names;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">infile</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (infile.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">        std::string line;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span> (infile,line)) &#123;</span><br><span class="line">            class_names.<span class="built_in">emplace_back</span>(line);</span><br><span class="line">        &#125;</span><br><span class="line">        infile.<span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error loading the class names!\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> class_names;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Demo</span><span class="params">(cv::Mat&amp; img,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> std::vector&lt;std::vector&lt;Detection&gt;&gt;&amp; detections,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; class_names,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">bool</span> label = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!detections.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; detection : detections[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; box = detection.bbox;</span><br><span class="line">            <span class="keyword">float</span> score = detection.score;</span><br><span class="line">            <span class="keyword">int</span> class_idx = detection.class_idx;</span><br><span class="line"></span><br><span class="line">            cv::<span class="built_in">rectangle</span>(img, box, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (label) &#123;</span><br><span class="line">                std::stringstream ss;</span><br><span class="line">                ss &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; score;</span><br><span class="line">                std::string s = class_names[class_idx] + <span class="string">&quot; &quot;</span> + ss.<span class="built_in">str</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">auto</span> font_face = cv::FONT_HERSHEY_DUPLEX;</span><br><span class="line">                <span class="keyword">auto</span> font_scale = <span class="number">1.0</span>;</span><br><span class="line">                <span class="keyword">int</span> thickness = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">int</span> baseline=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">auto</span> s_size = cv::<span class="built_in">getTextSize</span>(s, font_face, font_scale, thickness, &amp;baseline);</span><br><span class="line">                cv::<span class="built_in">rectangle</span>(img,</span><br><span class="line">                        cv::<span class="built_in">Point</span>(box.<span class="built_in">tl</span>().x, box.<span class="built_in">tl</span>().y - s_size.height - <span class="number">5</span>),</span><br><span class="line">                        cv::<span class="built_in">Point</span>(box.<span class="built_in">tl</span>().x + s_size.width, box.<span class="built_in">tl</span>().y),</span><br><span class="line">                        cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">-1</span>);</span><br><span class="line">                cv::<span class="built_in">putText</span>(img, s, cv::<span class="built_in">Point</span>(box.<span class="built_in">tl</span>().x, box.<span class="built_in">tl</span>().y - <span class="number">5</span>),</span><br><span class="line">                            font_face , font_scale, cv::<span class="built_in">Scalar</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), thickness);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cv::namedWindow(&quot;Result&quot;, cv::WINDOW_AUTOSIZE);</span></span><br><span class="line">    <span class="comment">// cv::imshow(&quot;Result&quot;, img);</span></span><br><span class="line">    <span class="comment">// cv::waitKey(0);</span></span><br><span class="line">    cv::<span class="built_in">imwrite</span>(<span class="string">&quot;/home/ubuntu/users/jazzy/newlib/libtorch/libtorch-yolov5/build/Result.jpg&quot;</span>,img);</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;img saved~&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">cxxopts::Options <span class="title">parser</span><span class="params">(argv[<span class="number">0</span>], <span class="string">&quot;A LibTorch inference implementation of the yolov5&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> add other args</span></span><br><span class="line">    parser.<span class="built_in">allow_unrecognised_options</span>().<span class="built_in">add_options</span>()</span><br><span class="line">            (<span class="string">&quot;weights&quot;</span>, <span class="string">&quot;model.torchscript.pt path&quot;</span>, cxxopts::value&lt;std::string&gt;())</span><br><span class="line">            (<span class="string">&quot;source&quot;</span>, <span class="string">&quot;source&quot;</span>, cxxopts::value&lt;std::string&gt;())</span><br><span class="line">            (<span class="string">&quot;conf-thres&quot;</span>, <span class="string">&quot;object confidence threshold&quot;</span>, cxxopts::value&lt;<span class="keyword">float</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;0.4&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;iou-thres&quot;</span>, <span class="string">&quot;IOU threshold for NMS&quot;</span>, cxxopts::value&lt;<span class="keyword">float</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;0.5&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;gpu&quot;</span>, <span class="string">&quot;Enable cuda device or cpu&quot;</span>, cxxopts::value&lt;<span class="keyword">bool</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;true&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;view-img&quot;</span>, <span class="string">&quot;display results&quot;</span>, cxxopts::value&lt;<span class="keyword">bool</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;false&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;h,help&quot;</span>, <span class="string">&quot;Print usage&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> opt = parser.<span class="built_in">parse</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opt.<span class="built_in">count</span>(<span class="string">&quot;help&quot;</span>)) &#123;</span><br><span class="line">        std::cout &lt;&lt; parser.<span class="built_in">help</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if gpu flag is set</span></span><br><span class="line">    <span class="keyword">bool</span> is_gpu = opt[<span class="string">&quot;gpu&quot;</span>].as&lt;<span class="keyword">bool</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set device type - CPU/GPU</span></span><br><span class="line">    torch::DeviceType device_type;</span><br><span class="line">    <span class="keyword">if</span> (torch::cuda::<span class="built_in">is_available</span>() &amp;&amp; is_gpu) &#123;</span><br><span class="line">        device_type = torch::kCUDA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        device_type = torch::kCPU;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load class names from dataset for visualization</span></span><br><span class="line">    std::vector&lt;std::string&gt; class_names = <span class="built_in">LoadNames</span>(<span class="string">&quot;../coco.names&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (class_names.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load network</span></span><br><span class="line">    std::string weights = opt[<span class="string">&quot;weights&quot;</span>].as&lt;std::string&gt;();</span><br><span class="line">    <span class="comment">//std::string weights = &quot;../official_yolov5s.torchscript.pt&quot;;</span></span><br><span class="line">    <span class="keyword">auto</span> detector = <span class="built_in">Detector</span>(weights, device_type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load input image</span></span><br><span class="line">    std::string source = opt[<span class="string">&quot;source&quot;</span>].as&lt;std::string&gt;();</span><br><span class="line">    cv::Mat img = cv::<span class="built_in">imread</span>(source);</span><br><span class="line">    <span class="keyword">if</span> (img.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error loading the image!\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run once to warm up</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Run once on empty image&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">auto</span> temp_img = cv::Mat::<span class="built_in">zeros</span>(img.rows, img.cols, CV_32FC3);</span><br><span class="line">    detector.<span class="built_in">Run</span>(temp_img, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up threshold</span></span><br><span class="line">    <span class="keyword">float</span> conf_thres = opt[<span class="string">&quot;conf-thres&quot;</span>].as&lt;<span class="keyword">float</span>&gt;();</span><br><span class="line">    <span class="keyword">float</span> iou_thres = opt[<span class="string">&quot;iou-thres&quot;</span>].as&lt;<span class="keyword">float</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inference</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">auto</span> result = detector.<span class="built_in">Run</span>(img, conf_thres, iou_thres);</span><br><span class="line">        <span class="keyword">if</span>(i==<span class="number">19</span>)<span class="built_in">Demo</span>(img, result, class_names);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// visualize detections</span></span><br><span class="line">    <span class="comment">// if (opt[&quot;view-img&quot;].as&lt;bool&gt;()) &#123;</span></span><br><span class="line">    <span class="comment">//     Demo(img, result, class_names);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cv::destroyAllWindows();</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éš¾æï¼Œæ¢ä¸ªgithubé¡¹ç›®çœ‹çœ‹</p>
<h2 id="remake2-âˆš"><a href="#remake2-âˆš" class="headerlink" title="remake2(âˆš)"></a>remake2(âˆš)</h2><p>ä½¿ç”¨ï¼š<a target="_blank" rel="noopener" href="https://github.com/ncdhz/YoloV5-LibTorch">https://github.com/ncdhz/YoloV5-LibTorch</a> </p>
<p>å‘ç°å¦‚æœptæ¨¡å‹æ˜¯CPUçš„æ¨¡å‹ï¼Œå†libtorché‡Œé¢ä½¿ç”¨cuda çš„è¯ä¼šæœ‰ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<p><img src="./image-20210724104438802.png" alt="image-20210724104438802"></p>
<p>ä¸ç”¨cudaçš„è¯(false)é¡ºåˆ©è¿è¡Œï¼Œä½†æ˜¯é€Ÿåº¦æ„Ÿäºº</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">YoloV5 <span class="title">yolo</span><span class="params">(<span class="string">&quot;/home/ubuntu/users/jazzy/newlib/libtorch/YoloV5-LibTorch/test/exp17best.torchscript.pt&quot;</span>,<span class="literal">false</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724104610950.png" alt="image-20210724104610950"></p>
<p><img src="./image-20210724105227731.png" alt="image-20210724105227731"></p>
<p>åæ¥çŸ¥é“å¯èƒ½æ˜¯å› ä¸ºä½¿ç”¨çš„torchlibæ¨¡å‹æ˜¯CPUç‰ˆçš„ã€‚ä¸‹é¢å°è¯•GPUçš„libtorchæ¨¡å‹ï¼Œæˆäº†ï¼Œexport ä½¿ç”¨gpuçš„æ¨¡å‹copy<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40198848/article/details/112872844">è¿™ä¸ª</a>ä»£ç ï¼Œå¹¶ä¸”ç²¾ç®€äº†ä¸€ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;./&#x27;</span>)  <span class="comment"># to run &#x27;$ python *.py&#x27; files in subdirectories</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> models.experimental <span class="keyword">import</span> attempt_load</span><br><span class="line"><span class="keyword">from</span> utils.activations <span class="keyword">import</span> Hardswish, SiLU</span><br><span class="line"><span class="keyword">from</span> utils.general <span class="keyword">import</span> set_logging, check_img_size</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--weights&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;./runs/train/exp17/weights/best.pt&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;weights path&#x27;</span>)  <span class="comment"># from yolov5/models/</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--img-size&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">640</span>, <span class="number">640</span>], <span class="built_in">help</span>=<span class="string">&#x27;image size&#x27;</span>)  <span class="comment"># height, width</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--batch-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1</span>, <span class="built_in">help</span>=<span class="string">&#x27;batch size&#x27;</span>)</span><br><span class="line">    opt = parser.parse_args()</span><br><span class="line">    opt.img_size *= <span class="number">2</span> <span class="keyword">if</span> <span class="built_in">len</span>(opt.img_size) == <span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span>  <span class="comment"># expand</span></span><br><span class="line">    <span class="built_in">print</span>(opt)</span><br><span class="line">    set_logging()</span><br><span class="line">    t = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load PyTorch model</span></span><br><span class="line">    model = attempt_load(opt.weights, map_location=torch.device(<span class="string">&#x27;cuda&#x27;</span>))  <span class="comment"># load FP32 model</span></span><br><span class="line">    labels = model.names</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Checks</span></span><br><span class="line">    gs = <span class="built_in">int</span>(<span class="built_in">max</span>(model.stride))  <span class="comment"># grid size (max stride)</span></span><br><span class="line">    opt.img_size = [check_img_size(x, gs) <span class="keyword">for</span> x <span class="keyword">in</span> opt.img_size]  <span class="comment"># verify img_size are gs-multiples</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Input</span></span><br><span class="line">    img = torch.zeros(opt.batch_size, <span class="number">3</span>, *opt.img_size).to(device=<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">    <span class="comment"># image size(1,3,320,192) iDetection</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update model</span></span><br><span class="line">    <span class="keyword">for</span> k, m <span class="keyword">in</span> model.named_modules():</span><br><span class="line">        m._non_persistent_buffers_set = <span class="built_in">set</span>()  <span class="comment"># pytorch 1.6.0 compatibility</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, models.common.Conv):  <span class="comment"># assign export-friendly activations</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m.act, nn.Hardswish):</span><br><span class="line">                m.act = Hardswish()</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m.act, nn.SiLU):</span><br><span class="line">                m.act = SiLU()</span><br><span class="line">        <span class="comment"># elif isinstance(m, models.yolo.Detect):</span></span><br><span class="line">        <span class="comment">#     m.forward = m.forward_export  # assign forward (optional)</span></span><br><span class="line">    <span class="comment">#model.model[-1].export = True  # set Detect() layer export=True</span></span><br><span class="line">    model.model[-<span class="number">1</span>].export = <span class="literal">False</span></span><br><span class="line">    y = model(img)  <span class="comment"># dry run</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># TorchScript export</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nStarting TorchScript export with torch %s...&#x27;</span> % torch.__version__)</span><br><span class="line">        f = opt.weights.replace(<span class="string">&#x27;.pt&#x27;</span>, <span class="string">&#x27;.torchscript.pt&#x27;</span>)  <span class="comment"># filename</span></span><br><span class="line">        ts = torch.jit.trace(model, img)</span><br><span class="line">        ts.save(f)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;TorchScript export success, saved as %s&#x27;</span> % f)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;TorchScript export failure: %s&#x27;</span> % e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\nExport complete (%.2fs). Visualize with https://github.com/lutzroeder/netron.&#x27;</span> % (time.time() - t))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯é€Ÿåº¦ä¾ç„¶æ„Ÿäººï¼ˆç›¸åŒç¯å¢ƒä¸‹æ¯”ç›´æ¥ç”¨pytorchå¿«äº†ä¸€äº›ï¼Œä¸æ¸…æ¥šä¸ºä»€ä¹ˆæœåŠ¡å™¨è·‘èµ·æ¥è¿™ä¹ˆæ…¢ï¼‰</p>
<p><img src="./image-20210724110314909.png" alt="image-20210724110314909"></p>
<p>å½“å‰ç”¨çš„æ˜¯yolov5sï¼ˆexp17ï¼‰è½¬çš„torchscriptæ¨¡å‹ã€‚é€Ÿåº¦ç›¸å¯¹å¿«äº†ä¸€ç‚¹ï¼Œçœ‹çœ‹ç²¾åº¦æ€ä¹ˆæ ·ã€‚</p>
<h2 id="ç²¾åº¦å¯¹æ¯”-libtorch-onnx-pt"><a href="#ç²¾åº¦å¯¹æ¯”-libtorch-onnx-pt" class="headerlink" title="ç²¾åº¦å¯¹æ¯”(libtorch/onnx/pt)"></a>ç²¾åº¦å¯¹æ¯”(libtorch/onnx/pt)</h2><p>libtorchä¸onnxåŠptçš„ç²¾åº¦å¯¹æ¯”ï¼Œç”¨äºéªŒè¯libtorchæ˜¯å¦æ‹‰è·¨ï¼Œæ‹‰è·¨çš„è¯åé¢å°±ä¸æè¿™ä¸ªäº†ã€‚</p>
<h3 id="å¯¹æ¯”1"><a href="#å¯¹æ¯”1" class="headerlink" title="å¯¹æ¯”1"></a>å¯¹æ¯”1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_572.jpg</span><br><span class="line">onnx time: 1.7160511016845703 result: [278, 30, 304, 47, 130, 237, 170, 261]</span><br><span class="line">pt time: 0.11151266098022461 result: [[0, 131, 236, 170, 260]]</span><br><span class="line"></span><br><span class="line">libtorch:å‡†ç¡®åº¦okï¼Œé€Ÿåº¦æ¯”ptå¿«ï¼šå¹³å‡70ms</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724160925922.png" alt="image-20210724160925922"></p>
<h3 id="å¯¹æ¯”2"><a href="#å¯¹æ¯”2" class="headerlink" title="å¯¹æ¯”2"></a>å¯¹æ¯”2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_555.jpg</span><br><span class="line">onnx time: 0.02010798454284668 result: [263, 60, 314, 272, 149, 242, 173, 309]</span><br><span class="line">pt time: 0.12859725952148438 result: []</span><br><span class="line"></span><br><span class="line">libtorch:å‡†ç¡®åº¦å’Œptä¸€è‡´(æ£€æµ‹ä¸åˆ°)ï¼Œå¹³å‡103ms</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹æ¯”3"><a href="#å¯¹æ¯”3" class="headerlink" title="å¯¹æ¯”3"></a>å¯¹æ¯”3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_215.png</span><br><span class="line">onnx time: 0.02190113067626953 result: []</span><br><span class="line">pt time: 0.1412513256072998 result: [[0, 343, 319, 363, 327]]</span><br><span class="line"></span><br><span class="line">libtorch:å¹³å‡127msï¼Œç»“æœå’Œptä¸€è‡´</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724162331186.png" alt="image-20210724162331186"></p>
<h3 id="å¯¹æ¯”4"><a href="#å¯¹æ¯”4" class="headerlink" title="å¯¹æ¯”4"></a>å¯¹æ¯”4</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_212.jpg</span><br><span class="line">onnx time: 0.017680644989013672 result: [1, 290, 117, 341, 6, 89, 62, 113, 137, 126, 190, 151, 1, 364, 80, 396]</span><br><span class="line">pt time: 0.11270976066589355 result: [[0, 0, 193, 68, 231]]</span><br><span class="line"></span><br><span class="line">libtorch:133ms!??ç»“æœok</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724162624894.png" alt="image-20210724162624894"></p>
<h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>ç²¾åº¦å’Œé€Ÿåº¦å’ŒåŸå§‹çš„å‡ ä¹æ²¡åŒºåˆ«ï¼Œä¸‹é¢å°è¯•è½¬æˆsoåœ¨pythonä¸­è°ƒç”¨ã€‚</p>
<h2 id="libtorch-pybind11"><a href="#libtorch-pybind11" class="headerlink" title="libtorch+pybind11"></a>libtorch+pybind11</h2><blockquote>
<p>åˆ†æï¼š</p>
<p>æš´éœ²æ¥å£ï¼šåŠ è½½æ¨¡å‹ï¼Œwarmupï¼Œæ£€æµ‹</p>
<p>è¿”å›å€¼ï¼švector</p>
</blockquote>
<p>è¿™ä¸ªéƒ¨åˆ†æŠŠå‡ ä¸ªcppæ–‡ä»¶åˆåœ¨ä¸€èµ·äº†ï¼Œå¹¶ä¸”åˆ é™¤äº†æ²¡ç”¨åˆ°çš„å‡½æ•°ã€‚cmakelistséƒ¨åˆ†å¡äº†æˆ‘å¾ˆä¹…ã€‚</p>
<h3 id="c-ç¨‹åº"><a href="#c-ç¨‹åº" class="headerlink" title="c++ç¨‹åº"></a>c++ç¨‹åº</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;torch/torch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;torch/script.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/numpy.h&gt;</span><span class="comment">//add</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Python-&gt;C++ Mat</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_1c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;1-channel image must be 2 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC1, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_3c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;3-channel image must be 3 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC3, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ImageResizeData å›¾ç‰‡å¤„ç†è¿‡åä¿å­˜å›¾ç‰‡çš„æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageResizeData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æ·»åŠ å¤„ç†è¿‡åçš„å›¾ç‰‡</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setImg</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">    <span class="comment">// è·å–å¤„ç†è¿‡åçš„å›¾ç‰‡</span></span><br><span class="line">	<span class="function">cv::Mat <span class="title">getImg</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// å½“åŸå§‹å›¾ç‰‡å®½é«˜æ¯”å¤§äºå¤„ç†è¿‡åå›¾ç‰‡å®½é«˜æ¯”æ—¶æ­¤å‡½æ•°è¿”å› true</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">isW</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// å½“åŸå§‹å›¾ç‰‡é«˜å®½æ¯”å¤§äºå¤„ç†è¿‡åå›¾ç‰‡é«˜å®½æ¯”æ—¶æ­¤å‡½æ•°è¿”å› true</span></span><br><span class="line"><span class="comment">//	bool isH();</span></span><br><span class="line">    <span class="comment">// æ·»åŠ å¤„ç†ä¹‹åå›¾ç‰‡çš„å®½</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setWidth</span><span class="params">(<span class="keyword">int</span> width)</span></span>;</span><br><span class="line">    <span class="comment">// è·å–å¤„ç†ä¹‹åå›¾ç‰‡çš„å®½</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ å¤„ç†ä¹‹åå›¾ç‰‡çš„é«˜</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setHeight</span><span class="params">(<span class="keyword">int</span> height)</span></span>;</span><br><span class="line">    <span class="comment">// è·å–å¤„ç†ä¹‹åå›¾ç‰‡çš„é«˜</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ åŸå§‹å›¾ç‰‡çš„å®½</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setW</span><span class="params">(<span class="keyword">int</span> w)</span></span>;</span><br><span class="line">    <span class="comment">// è·å–åŸå§‹å›¾ç‰‡çš„å®½</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getW</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ åŸå§‹å›¾ç‰‡çš„é«˜</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setH</span><span class="params">(<span class="keyword">int</span> h)</span></span>;</span><br><span class="line">    <span class="comment">// è·å–åŸå§‹å›¾ç‰‡çš„é«˜</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getH</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ ä»åŸå§‹å›¾ç‰‡åˆ°å¤„ç†è¿‡åå›¾ç‰‡æ‰€æ·»åŠ é»‘è¾¹å¤§å°</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setBorder</span><span class="params">(<span class="keyword">int</span> border)</span></span>;</span><br><span class="line">    <span class="comment">// è·å–ä»åŸå§‹å›¾ç‰‡åˆ°å¤„ç†è¿‡åå›¾ç‰‡æ‰€æ·»åŠ é»‘è¾¹å¤§å°</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getBorder</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// å¤„ç†è¿‡åå›¾ç‰‡é«˜</span></span><br><span class="line">	<span class="keyword">int</span> height;</span><br><span class="line">	<span class="comment">// å¤„ç†è¿‡åå›¾ç‰‡å®½</span></span><br><span class="line">    <span class="keyword">int</span> width;</span><br><span class="line">	<span class="comment">// åŸå§‹å›¾ç‰‡å®½</span></span><br><span class="line">    <span class="keyword">int</span> w;</span><br><span class="line">	<span class="comment">// åŸå§‹å›¾ç‰‡é«˜</span></span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">	<span class="comment">// ä»åŸå§‹å›¾ç‰‡åˆ°å¤„ç†å›¾ç‰‡æ‰€æ·»åŠ çš„é»‘è¾¹å¤§å°</span></span><br><span class="line">    <span class="keyword">int</span> border;</span><br><span class="line">	<span class="comment">// å¤„ç†è¿‡åçš„å›¾ç‰‡</span></span><br><span class="line">    cv::Mat img;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YoloV5</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">     * @param ptFile yoloV5 ptæ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">	 * @param isCuda æ˜¯å¦ä½¿ç”¨ cuda é»˜è®¤ä¸èµ·ç”¨</span></span><br><span class="line"><span class="comment">	 * @param height yoloV5 è®­ç»ƒæ—¶å›¾ç‰‡çš„é«˜</span></span><br><span class="line"><span class="comment">	 * @param width yoloV5 è®­ç»ƒæ—¶å›¾ç‰‡çš„å®½</span></span><br><span class="line"><span class="comment">	 * @param confThres éæå¤§å€¼æŠ‘åˆ¶ä¸­çš„ scoreThresh</span></span><br><span class="line"><span class="comment">	 * @param iouThres éæå¤§å€¼æŠ‘åˆ¶ä¸­çš„ iouThresh</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">// YoloV5(std::string ptFile, bool isCuda = false, int height = 640, int width = 640,  float confThres = 0.25, float iouThres = 0.45);</span></span><br><span class="line">	<span class="comment">// YoloV5(int height = 640, int width = 640,  float confThres = 0.25, float iouThres = 0.45);</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">readModel</span><span class="params">(std::string ptFile, <span class="keyword">bool</span> isCuda = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">warmup</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * é¢„æµ‹å‡½æ•°</span></span><br><span class="line"><span class="comment">	 * @param img éœ€è¦é¢„æµ‹çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">prediction</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ”¹å˜å›¾ç‰‡å¤§å°çš„å‡½æ•°</span></span><br><span class="line"><span class="comment">	 * @param img åŸå§‹å›¾ç‰‡</span></span><br><span class="line"><span class="comment">	 * @param height è¦å¤„ç†æˆçš„å›¾ç‰‡çš„é«˜</span></span><br><span class="line"><span class="comment">	 * @param width è¦å¤„ç†æˆçš„å›¾ç‰‡çš„å®½</span></span><br><span class="line"><span class="comment">	 * @return å°è£…å¥½çš„å¤„ç†è¿‡åå›¾ç‰‡æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">predict</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> ImageResizeData <span class="title">resize</span><span class="params">(cv::Mat img, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ”¹å˜å›¾ç‰‡å¤§å°çš„å‡½æ•°</span></span><br><span class="line"><span class="comment">	 * @param img åŸå§‹å›¾ç‰‡</span></span><br><span class="line"><span class="comment">	 * @return å°è£…å¥½çš„å¤„ç†è¿‡åå›¾ç‰‡æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">ImageResizeData <span class="title">resize</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ”¹å˜å›¾ç‰‡å¤§å°çš„å‡½æ•°</span></span><br><span class="line"><span class="comment">	 * @param imgs åŸå§‹å›¾ç‰‡é›†åˆ</span></span><br><span class="line"><span class="comment">	 * @param height è¦å¤„ç†æˆçš„å›¾ç‰‡çš„é«˜</span></span><br><span class="line"><span class="comment">	 * @param width è¦å¤„ç†æˆçš„å›¾ç‰‡çš„å®½</span></span><br><span class="line"><span class="comment">	 * @return å°è£…å¥½çš„å¤„ç†è¿‡åå›¾ç‰‡æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> std::vector&lt;ImageResizeData&gt; <span class="title">resize</span><span class="params">(std::vector &lt;cv::Mat&gt; imgs, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ”¹å˜å›¾ç‰‡å¤§å°çš„å‡½æ•°</span></span><br><span class="line"><span class="comment">	 * @param imgs åŸå§‹å›¾ç‰‡é›†åˆ</span></span><br><span class="line"><span class="comment">	 * @return å°è£…å¥½çš„å¤„ç†è¿‡åå›¾ç‰‡æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">std::vector&lt;ImageResizeData&gt; <span class="title">resize</span><span class="params">(std::vector &lt;cv::Mat&gt; imgs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	bool existencePrediction(torch::Tensor clazz);</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ç”¨äºåˆ¤æ–­ç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨é¢„æµ‹</span></span><br><span class="line"><span class="comment">	 * @param classs é€šè¿‡é¢„æµ‹å‡½æ•°å¤„ç†å¥½çš„ç»“æœ</span></span><br><span class="line"><span class="comment">	 * @return å¦‚æœå›¾ç‰‡é›†åˆä¸­å­˜åœ¨ç»™å®šæŸä¸€ç§åˆ†ç±»è¿”å› true</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="comment">//	bool existencePrediction(std::vector&lt;torch::Tensor&gt; classs);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// æ˜¯å¦å¯ç”¨ cuda</span></span><br><span class="line">	<span class="keyword">bool</span> isCuda;</span><br><span class="line">	<span class="comment">// éæå¤§å€¼æŠ‘åˆ¶ä¸­çš„ç¬¬ä¸€æ­¥æ•°æ®æ¸…ç†</span></span><br><span class="line">	<span class="keyword">float</span> confThres;</span><br><span class="line">	<span class="comment">// éæå¤§å€¼æŠ‘åˆ¶ä¸­ iou</span></span><br><span class="line">	<span class="keyword">float</span> iouThres;</span><br><span class="line">	<span class="comment">// æ¨¡å‹æ‰€éœ€è¦çš„å›¾ç‰‡çš„é«˜</span></span><br><span class="line">	<span class="keyword">float</span> height;</span><br><span class="line">	<span class="comment">// æ¨¡å‹æ‰€éœ€è¦çš„å›¾ç‰‡çš„å®½</span></span><br><span class="line">	<span class="keyword">float</span> width;</span><br><span class="line">	<span class="comment">// ç”»æ¡†é¢œè‰² map</span></span><br><span class="line">	std::map&lt;<span class="keyword">int</span>, cv::Scalar&gt; mainColors;</span><br><span class="line">	<span class="comment">// æ¨¡å‹</span></span><br><span class="line">	torch::jit::script::Module model;</span><br><span class="line">	<span class="comment">// éšæœºè·å–ä¸€ç§é¢œè‰²</span></span><br><span class="line"><span class="comment">//	cv::Scalar getRandScalar();</span></span><br><span class="line">	<span class="comment">// å›¾ç‰‡é€šé“è½¬æ¢ä¸º rgb</span></span><br><span class="line">	<span class="function">cv::Mat <span class="title">img2RGB</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">// å›¾ç‰‡å˜ä¸º Tensor</span></span><br><span class="line">	<span class="function">torch::Tensor <span class="title">img2Tensor</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">// (center_x center_y w h) to (left, top, right, bottom)</span></span><br><span class="line">	<span class="function">torch::Tensor <span class="title">xywh2xyxy</span><span class="params">(torch::Tensor x)</span></span>;</span><br><span class="line">	<span class="comment">// éæå¤§å€¼æŠ‘åˆ¶ç®—æ³•</span></span><br><span class="line">	<span class="function">torch::Tensor <span class="title">nms</span><span class="params">(torch::Tensor bboxes, torch::Tensor scores, <span class="keyword">float</span> thresh)</span></span>;</span><br><span class="line">	<span class="comment">// é¢„æµ‹å‡ºæ¥çš„æ¡†æ ¹æ®åŸå§‹å›¾ç‰‡è¿˜åŸç®—æ³•</span></span><br><span class="line">	<span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">sizeOriginal</span><span class="params">(std::vector&lt;torch::Tensor&gt; result, std::vector&lt;ImageResizeData&gt; imgRDs)</span></span>;</span><br><span class="line">	<span class="comment">// éæå¤§å€¼æŠ‘åˆ¶ç®—æ³•æ•´ä½“</span></span><br><span class="line">	<span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">non_max_suppression</span><span class="params">(torch::Tensor preds, <span class="keyword">float</span> confThres = <span class="number">0.25</span>, <span class="keyword">float</span> iouThres = <span class="number">0.45</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// YoloV5::YoloV5(int height, int width, float confThres, float iouThres)</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 	this-&gt;height = height;</span></span><br><span class="line"><span class="comment">// 	this-&gt;width = width;</span></span><br><span class="line"><span class="comment">// 	this-&gt;isCuda = isCuda;</span></span><br><span class="line"><span class="comment">// 	this-&gt;iouThres = iouThres;</span></span><br><span class="line"><span class="comment">// 	this-&gt;confThres = confThres;</span></span><br><span class="line"><span class="comment">// 	model.eval();</span></span><br><span class="line"><span class="comment">// 	unsigned seed = time(0);</span></span><br><span class="line"><span class="comment">// 	std::srand(seed);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YoloV5::readModel</span><span class="params">(std::string ptFile, <span class="keyword">bool</span> isCuda)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;height = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;width = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;isCuda = isCuda;</span><br><span class="line">	<span class="keyword">this</span>-&gt;iouThres = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;confThres = <span class="number">0.25</span>;</span><br><span class="line">	model = torch::jit::<span class="built_in">load</span>(ptFile);</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;</span><br><span class="line">		model.<span class="built_in">to</span>(torch::kCUDA);</span><br><span class="line">	&#125;</span><br><span class="line">	model.<span class="built_in">eval</span>();</span><br><span class="line">	<span class="keyword">unsigned</span> seed = <span class="built_in">time</span>(<span class="number">0</span>);</span><br><span class="line">	std::<span class="built_in">srand</span>(seed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">YoloV5::non_max_suppression</span><span class="params">(torch::Tensor prediction, <span class="keyword">float</span> confThres, <span class="keyword">float</span> iouThres)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	torch::Tensor xc = prediction.<span class="built_in">select</span>(<span class="number">2</span>, <span class="number">4</span>) &gt; confThres;</span><br><span class="line">	<span class="keyword">int</span> maxWh = <span class="number">4096</span>;</span><br><span class="line">	<span class="keyword">int</span> maxNms = <span class="number">30000</span>;</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; output;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prediction.<span class="built_in">size</span>(<span class="number">0</span>); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		output.<span class="built_in">push_back</span>(torch::<span class="built_in">zeros</span>(&#123; <span class="number">0</span>, <span class="number">6</span> &#125;));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prediction.<span class="built_in">size</span>(<span class="number">0</span>); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		torch::Tensor x = prediction[i];</span><br><span class="line">		x = x.<span class="built_in">index_select</span>(<span class="number">0</span>, torch::<span class="built_in">nonzero</span>(xc[i]).<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">		<span class="keyword">if</span> (x.<span class="built_in">size</span>(<span class="number">0</span>) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">5</span>, x.<span class="built_in">size</span>(<span class="number">1</span>)).<span class="built_in">mul_</span>(x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">		torch::Tensor box = <span class="built_in">xywh2xyxy</span>(x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">		std::tuple&lt;torch::Tensor, torch::Tensor&gt; max_tuple = torch::<span class="built_in">max</span>(x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">5</span>, x.<span class="built_in">size</span>(<span class="number">1</span>)), <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">		x = torch::<span class="built_in">cat</span>(&#123; box, std::get&lt;<span class="number">0</span>&gt;(max_tuple), std::get&lt;<span class="number">1</span>&gt;(max_tuple) &#125;, <span class="number">1</span>);</span><br><span class="line">		x = x.<span class="built_in">index_select</span>(<span class="number">0</span>, torch::<span class="built_in">nonzero</span>(std::get&lt;<span class="number">0</span>&gt;(max_tuple) &gt; confThres).<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">		<span class="keyword">int</span> n = x.<span class="built_in">size</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (n &gt; maxNms)</span><br><span class="line">		&#123;</span><br><span class="line">			x = x.<span class="built_in">index_select</span>(<span class="number">0</span>, x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">4</span>).<span class="built_in">argsort</span>(<span class="number">0</span>, <span class="literal">true</span>).<span class="built_in">slice</span>(<span class="number">0</span>, <span class="number">0</span>, maxNms));</span><br><span class="line">		&#125;</span><br><span class="line">		torch::Tensor c = x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>) * maxWh;</span><br><span class="line">		torch::Tensor boxes = x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>) + c, scores = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">		torch::Tensor ix = <span class="built_in">nms</span>(boxes, scores, iouThres).<span class="built_in">to</span>(x.<span class="built_in">device</span>());</span><br><span class="line">		output[i] = x.<span class="built_in">index_select</span>(<span class="number">0</span>, ix).<span class="built_in">cpu</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cv::Mat <span class="title">YoloV5::img2RGB</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> imgC = img.<span class="built_in">channels</span>();</span><br><span class="line">	<span class="keyword">if</span> (imgC == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(img, img, cv::COLOR_GRAY2RGB);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(img, img, cv::COLOR_BGR2RGB);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">torch::Tensor <span class="title">YoloV5::img2Tensor</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	torch::Tensor data = torch::<span class="built_in">from_blob</span>(img.data, &#123;(<span class="keyword">int</span>)height, (<span class="keyword">int</span>)width, <span class="number">3</span> &#125;, torch::kByte);</span><br><span class="line">	data = data.<span class="built_in">permute</span>(&#123; <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span> &#125;);</span><br><span class="line">	data = data.<span class="built_in">toType</span>(torch::kFloat);</span><br><span class="line">	data = data.<span class="built_in">div</span>(<span class="number">255</span>);</span><br><span class="line">	data = data.<span class="built_in">unsqueeze</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">torch::Tensor <span class="title">YoloV5::xywh2xyxy</span><span class="params">(torch::Tensor x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	torch::Tensor y = x.<span class="built_in">clone</span>();</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>) - x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>) - x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>) + x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>) + x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">torch::Tensor <span class="title">YoloV5::nms</span><span class="params">(torch::Tensor bboxes, torch::Tensor scores, <span class="keyword">float</span> thresh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> x1 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">auto</span> y1 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">auto</span> x2 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">auto</span> y2 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">auto</span> areas = (x2 - x1) * (y2 - y1);</span><br><span class="line">	<span class="keyword">auto</span> tuple_sorted = scores.<span class="built_in">sort</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">auto</span> order = std::get&lt;<span class="number">1</span>&gt;(tuple_sorted);</span><br><span class="line"></span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; keep;</span><br><span class="line">	<span class="keyword">while</span> (order.<span class="built_in">numel</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (order.<span class="built_in">numel</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">auto</span> i = order.<span class="built_in">item</span>();</span><br><span class="line">			keep.<span class="built_in">push_back</span>(i.<span class="built_in">toInt</span>());</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">auto</span> i = order[<span class="number">0</span>].<span class="built_in">item</span>();</span><br><span class="line">			keep.<span class="built_in">push_back</span>(i.<span class="built_in">toInt</span>());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">auto</span> order_mask = order.<span class="built_in">narrow</span>(<span class="number">0</span>, <span class="number">1</span>, order.<span class="built_in">size</span>(<span class="number">-1</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">auto</span> xx1 = x1.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(x1[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>(), <span class="number">1e10</span>);</span><br><span class="line">		<span class="keyword">auto</span> yy1 = y1.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(y1[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>(), <span class="number">1e10</span>);</span><br><span class="line">		<span class="keyword">auto</span> xx2 = x2.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(<span class="number">0</span>, x2[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>());</span><br><span class="line">		<span class="keyword">auto</span> yy2 = y2.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(<span class="number">0</span>, y2[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>());</span><br><span class="line">		<span class="keyword">auto</span> inter = (xx2 - xx1).<span class="built_in">clamp</span>(<span class="number">0</span>, <span class="number">1e10</span>) * (yy2 - yy1).<span class="built_in">clamp</span>(<span class="number">0</span>, <span class="number">1e10</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">auto</span> iou = inter / (areas[keep.<span class="built_in">back</span>()] + areas.<span class="built_in">index</span>(&#123; order.<span class="built_in">narrow</span>(<span class="number">0</span>,<span class="number">1</span>,order.<span class="built_in">size</span>(<span class="number">-1</span>) - <span class="number">1</span>) &#125;) - inter);</span><br><span class="line">		<span class="keyword">auto</span> idx = (iou &lt;= thresh).<span class="built_in">nonzero</span>().<span class="built_in">squeeze</span>();</span><br><span class="line">		<span class="keyword">if</span> (idx.<span class="built_in">numel</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		order = order.<span class="built_in">index</span>(&#123; idx + <span class="number">1</span> &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> torch::<span class="built_in">tensor</span>(keep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">YoloV5::sizeOriginal</span><span class="params">(std::vector&lt;torch::Tensor&gt; result, std::vector&lt;ImageResizeData&gt; imgRDs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; resultOrg;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; result.<span class="built_in">size</span>(); i++)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		torch::Tensor data = result[i];</span><br><span class="line">		ImageResizeData imgRD = imgRDs[i];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; data.<span class="built_in">size</span>(<span class="number">0</span>); j++)</span><br><span class="line">		&#123;</span><br><span class="line">			torch::Tensor tensor = data.<span class="built_in">select</span>(<span class="number">0</span>, j);</span><br><span class="line">			<span class="comment">// (left, top, right, bottom)</span></span><br><span class="line">			<span class="keyword">if</span> (imgRD.<span class="built_in">isW</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				tensor[<span class="number">1</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">3</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">0</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getWidth</span>();</span><br><span class="line">				tensor[<span class="number">2</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getWidth</span>();</span><br><span class="line">				tensor[<span class="number">1</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getHeight</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">				tensor[<span class="number">3</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getHeight</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tensor[<span class="number">0</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">2</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">1</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getHeight</span>();</span><br><span class="line">				tensor[<span class="number">3</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getHeight</span>();</span><br><span class="line">				tensor[<span class="number">0</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getWidth</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">				tensor[<span class="number">2</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getWidth</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		resultOrg.<span class="built_in">push_back</span>(data);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resultOrg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YoloV5::warmup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    torch::Tensor data = torch::<span class="built_in">rand</span>(&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>&#125;);</span><br><span class="line">	<span class="keyword">if</span> (!data.<span class="built_in">is_cuda</span>() &amp;&amp; <span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cuda</span>();</span><br><span class="line">	<span class="keyword">if</span> (data.<span class="built_in">is_cuda</span>() &amp;&amp; !<span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cpu</span>();</span><br><span class="line">	torch::Tensor pred = model.forward(&#123; data &#125;).<span class="built_in">toTuple</span>()-&gt;<span class="built_in">elements</span>()[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; res =  <span class="built_in">non_max_suppression</span>(pred, confThres, iouThres);</span><br><span class="line">	pred = model.forward(&#123; data &#125;).<span class="built_in">toTuple</span>()-&gt;<span class="built_in">elements</span>()[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">	res =  <span class="built_in">non_max_suppression</span>(pred, confThres, iouThres);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">YoloV5::predict</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>&#123;</span><br><span class="line">	cv::Mat img = <span class="built_in">numpy_uint8_3c_to_cv_mat</span>(input);</span><br><span class="line">    std::vector&lt;torch::Tensor&gt; r;</span><br><span class="line">    ImageResizeData imgRD = <span class="built_in">resize</span>(img);</span><br><span class="line">	cv::Mat reImg = <span class="built_in">img2RGB</span>(imgRD.<span class="built_in">getImg</span>());</span><br><span class="line">	torch::Tensor data = <span class="built_in">img2Tensor</span>(reImg);</span><br><span class="line">	<span class="keyword">if</span> (!data.<span class="built_in">is_cuda</span>() &amp;&amp; <span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cuda</span>();</span><br><span class="line">	<span class="keyword">if</span> (data.<span class="built_in">is_cuda</span>() &amp;&amp; !<span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cpu</span>();</span><br><span class="line">	torch::Tensor pred = model.forward(&#123; data &#125;).<span class="built_in">toTuple</span>()-&gt;<span class="built_in">elements</span>()[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; result = <span class="built_in">non_max_suppression</span>(pred, confThres, iouThres);</span><br><span class="line">	std::vector&lt;ImageResizeData&gt; imgRDs;</span><br><span class="line">	imgRDs.<span class="built_in">push_back</span>(imgRD);</span><br><span class="line">	r =  <span class="built_in">sizeOriginal</span>(result, imgRDs);</span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; r[<span class="number">0</span>].<span class="built_in">size</span>(<span class="number">0</span>); i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> clazz = r[<span class="number">0</span>][i][<span class="number">5</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">if</span>(clazz)<span class="keyword">continue</span>;<span class="comment">//è¿‡æ»¤seatbelt</span></span><br><span class="line">        <span class="keyword">int</span> x = r[<span class="number">0</span>][i][<span class="number">0</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">int</span> y = r[<span class="number">0</span>][i][<span class="number">1</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">int</span> w = r[<span class="number">0</span>][i][<span class="number">2</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">int</span> h = r[<span class="number">0</span>][i][<span class="number">3</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="comment">// detectResult.push_back(clazz);</span></span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(x);</span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(y);</span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(w);</span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(h);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ImageResizeData <span class="title">YoloV5::resize</span><span class="params">(cv::Mat img, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ImageResizeData imgResizeData;</span><br><span class="line">	<span class="keyword">int</span> w = img.cols, h = img.rows;</span><br><span class="line">	imgResizeData.<span class="built_in">setH</span>(h);</span><br><span class="line">	imgResizeData.<span class="built_in">setW</span>(w);</span><br><span class="line">	imgResizeData.<span class="built_in">setHeight</span>(height);</span><br><span class="line">	imgResizeData.<span class="built_in">setWidth</span>(width);</span><br><span class="line">	<span class="keyword">bool</span> isW = (<span class="keyword">float</span>)w / (<span class="keyword">float</span>)h &gt; (<span class="keyword">float</span>)width / (<span class="keyword">float</span>)height;</span><br><span class="line"></span><br><span class="line">	cv::<span class="built_in">resize</span>(img, img, cv::<span class="built_in">Size</span>(</span><br><span class="line">		isW ? width : (<span class="keyword">int</span>)((<span class="keyword">float</span>)height / (<span class="keyword">float</span>)h * w),</span><br><span class="line">		isW ? (<span class="keyword">int</span>)((<span class="keyword">float</span>)width / (<span class="keyword">float</span>)w * h) : height));</span><br><span class="line"></span><br><span class="line">	w = img.cols, h = img.rows;</span><br><span class="line">	<span class="keyword">if</span> (isW)</span><br><span class="line">	&#123;</span><br><span class="line">		imgResizeData.<span class="built_in">setBorder</span>((height - h) / <span class="number">2</span>);</span><br><span class="line">		cv::<span class="built_in">copyMakeBorder</span>(img, img, (height - h) / <span class="number">2</span>, height - h - (height - h) / <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, cv::BORDER_CONSTANT);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		imgResizeData.<span class="built_in">setBorder</span>((width - w) / <span class="number">2</span>);</span><br><span class="line">		cv::<span class="built_in">copyMakeBorder</span>(img, img, <span class="number">0</span>, <span class="number">0</span>, (width - w) / <span class="number">2</span>, width - w - (width - w) / <span class="number">2</span>, cv::BORDER_CONSTANT);</span><br><span class="line">	&#125;</span><br><span class="line">	imgResizeData.<span class="built_in">setImg</span>(img);</span><br><span class="line">	<span class="keyword">return</span> imgResizeData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ImageResizeData <span class="title">YoloV5::resize</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> YoloV5::<span class="built_in">resize</span>(img, height, width);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;ImageResizeData&gt; <span class="title">YoloV5::resize</span><span class="params">(std::vector&lt;cv::Mat&gt; imgs, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;ImageResizeData&gt; imgRDs;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; imgs.<span class="built_in">size</span>();i++)</span><br><span class="line">	&#123;</span><br><span class="line">		imgRDs.<span class="built_in">push_back</span>(YoloV5::<span class="built_in">resize</span>(imgs[i], height, width));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> imgRDs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;ImageResizeData&gt; <span class="title">YoloV5::resize</span><span class="params">(std::vector&lt;cv::Mat&gt; imgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> YoloV5::<span class="built_in">resize</span>(imgs, height, width);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setImg</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;img = img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cv::Mat <span class="title">ImageResizeData::getImg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ImageResizeData::isW</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">float</span>)w / (<span class="keyword">float</span>)h &gt; (<span class="keyword">float</span>)width / (<span class="keyword">float</span>)height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setWidth</span><span class="params">(<span class="keyword">int</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;width = width;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getWidth</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> width;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setHeight</span><span class="params">(<span class="keyword">int</span> height)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;height = height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getHeight</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setW</span><span class="params">(<span class="keyword">int</span> w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;w = w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getW</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setH</span><span class="params">(<span class="keyword">int</span> h)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;h = h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getH</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setBorder</span><span class="params">(<span class="keyword">int</span> border)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;border = border;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getBorder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> border;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printCoordinate</span><span class="params">(std::vector&lt;<span class="keyword">int</span>&gt; &amp;detectResult)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; detectResult.<span class="built_in">size</span>()/<span class="number">4</span>; i++) &#123;</span><br><span class="line">                std::cout &lt;&lt; detectResult[i*<span class="number">4</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span>+<span class="number">1</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span>+<span class="number">2</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span>+<span class="number">3</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;============================&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// int main()</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">// 	YoloV5 yolo(&quot;/home/ubuntu/users/jazzy/newlib/libtorch/YoloV5-LibTorch/exp17best.torchscript_gpu.pt&quot;,true);</span></span><br><span class="line"><span class="comment">// 	yolo.warmup();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 	clock_t start, end;//æ£€æµ‹è®¡æ—¶</span></span><br><span class="line"><span class="comment">// 	cv::Mat frame;</span></span><br><span class="line"><span class="comment">//     std::vector&lt;int&gt; result;</span></span><br><span class="line"><span class="comment">// 	double sumtime = 0;</span></span><br><span class="line"><span class="comment">// 	for (int c = 0; c &lt; 20; c++) &#123;//æ£€æµ‹20æ¬¡</span></span><br><span class="line"><span class="comment">// 		start = clock();</span></span><br><span class="line"><span class="comment">// 		std::string imgPath = &quot;/home/ubuntu/users/jazzy/v5/dataset/images/val/cigar_212.jpg&quot;;</span></span><br><span class="line"><span class="comment">// 		frame = cv::imread(imgPath);</span></span><br><span class="line"><span class="comment">// 		result = yolo.predict(frame);</span></span><br><span class="line"><span class="comment">// 		end = clock();</span></span><br><span class="line"><span class="comment">// 		sumtime+=double(end - start) / CLOCKS_PER_SEC;</span></span><br><span class="line"><span class="comment">// 		printCoordinate(result);</span></span><br><span class="line"><span class="comment">// 		std::cout &lt;&lt; &quot;Detect time:&quot; &lt;&lt; double(end - start) / CLOCKS_PER_SEC &lt;&lt; &quot;s&quot; &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	std::cout&lt;&lt;&quot;average time:&quot;&lt;&lt;sumtime/20&lt;&lt;std::endl;</span></span><br><span class="line"><span class="comment">// 	return 0;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libtorchpredict, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;yolov5s libtorch and pybind11&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    py::class_&lt;YoloV5&gt;(m, <span class="string">&quot;YoloV5&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;readModel&quot;</span>, &amp;YoloV5::readModel, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;warmup&quot;</span>, &amp;YoloV5::warmup)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;predict&quot;</span>, &amp;YoloV5::predict, py::return_value_policy::copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="cmakelists"><a href="#cmakelists" class="headerlink" title="cmakelists"></a>cmakelists</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(YoloV5LibTorch)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 14)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line"><span class="built_in">set</span>(Torch_DIR /home/ubuntu/users/jazzy/newlib/libtorch/share/cmake/Torch)</span><br><span class="line">find_package(Torch PATHS <span class="variable">$&#123;Torch_DIR&#125;</span> NO_DEFAULT REQUIRED)</span><br><span class="line">add_subdirectory(pybind11)</span><br><span class="line"></span><br><span class="line">include_directories( <span class="variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span> )</span><br><span class="line">INCLUDE_DIRECTORIES(</span><br><span class="line">  <span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span></span><br><span class="line">  ./</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_library(torchpredict MODULE </span><br><span class="line">            predict.cpp</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">target_link_libraries(torchpredict </span><br><span class="line">            pybind11::module</span><br><span class="line">  )</span><br><span class="line">target_link_libraries(torchpredict <span class="variable">$&#123;OpenCV_LIBS&#125;</span> )</span><br><span class="line">target_link_libraries(torchpredict <span class="variable">$&#123;TORCH_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="pythonè°ƒç”¨"><a href="#pythonè°ƒç”¨" class="headerlink" title="pythonè°ƒç”¨"></a>pythonè°ƒç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> libtorchpredict</span><br><span class="line">yolo = libtorchpredict.YoloV5()</span><br><span class="line">yolo.readModel(<span class="string">&quot;path/to/pt&quot;</span>,<span class="literal">True</span>)</span><br><span class="line">yolo.warmup()<span class="comment">#ç©ºè·‘ä¸¤æ¬¡</span></span><br><span class="line">img = cv2.imread(<span class="string">&quot;path/to/image&quot;</span>)</span><br><span class="line">sumTime = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    start = time.time()</span><br><span class="line">    res = yolo.predict(img)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="built_in">print</span>(end-start)</span><br><span class="line">    sumTime+=(end-start)</span><br><span class="line"><span class="built_in">print</span>(sumTime/<span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<hr/>

<blockquote>
<p>æ³¨æ„ç‚¹ï¼š<br>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­, æœ‰ä¸‰ä¸ªåœ°æ–¹çš„å˜é‡å‘½åéœ€è¦ä¸€è‡´,åˆ†åˆ«æ˜¯ä¸Šè¿°ä»£ç ä¸­çš„: PYBIND11_MODULEæ¥å£å‡½æ•°ä¸­çš„map_interface, CMakeListä¸­çš„add_libraryä¸­çš„map_interface, pythonä»£ç ä¸­çš„ import map_interface. å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€PYBIND11_MODULE(map_interface, m)</span><br><span class="line">2ã€add_library(map_interface MODULE â€¦ )</span><br><span class="line">3ã€import map_interface <span class="comment"># c++æ¥å£</span></span><br></pre></td></tr></table></figure>

<p> linux ç³»ç»Ÿåœ¨ä½¿ç”¨ CMake ç¼–è¯‘ c++ åŠ¨æ€é“¾æ¥åº“çš„æ—¶å€™, ä¼šåŠ ä¸€ä¸ªå‰ç¼€lib, ç”Ÿæˆlibmap_interface.so, å› æ­¤,è¿™ä¸‰ä¸ªåœ°æ–¹çš„å‘½ååº”è¯¥ä¿®æ”¹å¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1ã€PYBIND11_MODULE(libmap_interface, m)</span><br><span class="line">2ã€add_library(map_interface MODULE â€¦ )</span><br><span class="line">3ã€import libmap_interface <span class="comment"># c++æ¥</span></span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
V100ä¸Šé¢åªè¦16msï¼Œæ±‡æ€»ä¸€ä¸‹å½“å‰æœ€æ–°çš„é€Ÿåº¦å¯¹æ¯”è¡¨æ ¼(libtorchåœ¨ç¬¬äº”è¡Œã€ç¬¬å…­è¡Œ)ï¼Œå…¶ä¸­çš„warmupæ˜¯æŒ‡ä½¿ç”¨éšæœºç”Ÿæˆçš„tensorè®©ç½‘ç»œæ¨ç†ï¼Œè¿™ä¸ªè¡¨æ ¼å¯ä»¥å‘ç°æ— è®ºæ˜¯onnxè¿˜æ˜¯libtorchï¼Œåªè¦ä½¿ç”¨äº†cudaï¼Œå°±éœ€è¦warmupã€‚

<h3 id="é€Ÿåº¦å¯¹æ¯”-1"><a href="#é€Ÿåº¦å¯¹æ¯”-1" class="headerlink" title="é€Ÿåº¦å¯¹æ¯”"></a>é€Ÿåº¦å¯¹æ¯”</h3><table>
<thead>
<tr>
<th align="center">è¯­è¨€</th>
<th align="center">æ¡†æ¶</th>
<th align="center">æ¨¡å‹</th>
<th align="center">æ—¶é—´</th>
<th align="center">å¤‡æ³¨</th>
<th>æ˜¾å­˜å ç”¨</th>
<th align="center">ä½ç½®</th>
</tr>
</thead>
<tbody><tr>
<td align="center">C++</td>
<td align="center">opencv 4.4.0</td>
<td align="center">onnx</td>
<td align="center">å19æ¬¡å¹³å‡32.3ms</td>
<td align="center">ç¬¬ä¸€æ¬¡éœ€è¦2så¤š</td>
<td>1130MB</td>
<td align="center">~/cvyolo_cpp/predict.cpp</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">opencv 4.4.0+<strong>so</strong></td>
<td align="center">onnx</td>
<td align="center">å19æ¬¡å¹³å‡<strong>14.9ms</strong></td>
<td align="center">ç¬¬ä¸€æ¬¡éœ€è¦3så¤š</td>
<td>1260MB</td>
<td align="center">~/cvyolo/pytest.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">pytorch 1.8.1</td>
<td align="center">pt</td>
<td align="center">169ms</td>
<td align="center">æ–¹å·®å°ï¼Œä½†æ˜¯æ¯”æˆ‘1650è¿˜æ…¢</td>
<td>1415MB</td>
<td align="center">~/v5/yolov5/predict.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">python-opencv</td>
<td align="center">onnx</td>
<td align="center">689ms</td>
<td align="center">æ–¹å·®å°</td>
<td>Pass(CPU)</td>
<td align="center">~/cvyolo/opencvYOLO.py</td>
</tr>
<tr>
<td align="center">C++</td>
<td align="center">opencv 4.4.0+libtorch</td>
<td align="center">torchscript</td>
<td align="center">134ms</td>
<td align="center">warmup*2</td>
<td>1413MB</td>
<td align="center">~/newlib/libtorch/YoloV5-LibTorch_cpp/build</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">python-opencv +libtorch+<strong>so</strong></td>
<td align="center">torchscript</td>
<td align="center">16.2ms</td>
<td align="center">warmup*2</td>
<td>1413MB</td>
<td align="center">~/newlib/libtorch/YoloV5-LibTorch_py/build</td>
</tr>
</tbody></table>
<h3 id="ç²¾åº¦å¯¹æ¯”"><a href="#ç²¾åº¦å¯¹æ¯”" class="headerlink" title="ç²¾åº¦å¯¹æ¯”"></a>ç²¾åº¦å¯¹æ¯”</h3><p>ç²¾åº¦è¿™éƒ¨åˆ†ä¾ç„¶ä½¿ç”¨æ‰€æœ‰valæ•°æ®è¿›è¡Œæµ‹è¯•</p>
<p>é—®é¢˜ï¼šåŒæ—¶å¯¼å…¥libtorchpredict.soå’Œpytorchçš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œå¯æ˜¯æˆ‘libtorchçš„ç‰ˆæœ¬å’Œtorchçš„ç‰ˆæœ¬åˆ†æ˜æ˜¯åŒ¹é…çš„ã€‚</p>
<p>ä¸ç®¡äº†ï¼Œå…ˆç”¨ptå¯¹æ¯”onnx(ä¸Šæ¬¡å¯¹æ¯”è¿‡)ï¼Œå ç”¨æ˜¾å­˜2200MB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python speedCompare_ptVSonnx.py &gt; ptVSonnx.txt </span><br></pre></td></tr></table></figure>

<p>ç„¶åç•¥å¾®ä¿®æ”¹speedtest.pyå†ç”¨onnxå¯¹æ¯”libtorchï¼Œå ç”¨æ˜¾å­˜2206MB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python speedCompare_onnxVSlibtorch.py &gt; onnxVSlibtorch.txt </span><br></pre></td></tr></table></figure>

<p>æœ€åå†å¯¹æ¯”ä¸€ä¸‹ptVSonnxå’ŒonnxVSlibtorchä¸¤ä¸ªæ–‡ä»¶ï¼Œç»“è®ºæ˜¯libtorchåªæœ‰æå°‘æ•°ä¼šæ¯”åŸå§‹ptæ¨¡å‹æ¼æ£€ã€‚</p>
<p>æ„Ÿè°¢libtorchï¼Œè®©æˆ‘èƒ½ç¡å¥½è§‰</p>
<hr>

<h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><h2 id="ubuntu-opencv-cudaç¼–è¯‘"><a href="#ubuntu-opencv-cudaç¼–è¯‘" class="headerlink" title="ubuntu opencv+cudaç¼–è¯‘"></a>ubuntu opencv+cudaç¼–è¯‘</h2><p>ç”¨è‡ªå·±çš„è´¦å·makeï¼Œç”¨ubuntuè´¦å·sudo make install</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> opencv-4.4.0</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span><br><span class="line">    -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib-4.4.0/modules .. \</span><br><span class="line">    -DWITH_CUDA=1 \</span><br><span class="line">    -DENABLE_FAST_MATH=1 \</span><br><span class="line">    -DCUDA_FAST_MATH=1 \</span><br><span class="line">    -DWITH_CUBLAS=1 \</span><br><span class="line">    -DOPENCV_GENERATE_PKGCONFIG=1 \</span><br><span class="line">    -DCUDA_GENERATION=Pascal ..</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34717531/article/details/107763872">https://blog.csdn.net/qq_34717531/article/details/107763872</a></p>
<p>å¯ä»¥æ‰“å°ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æ³•ç”¨CUDA(ç¥ä¼¼æˆ‘åœ¨windowsä¸‹é€‰é”™ç®—åŠ›çš„æƒ…å†µ),æ¶æ„ä¼¼ä¹ä¹Ÿå†™é”™äº†ï¼Ÿ</p>
<p><img src="./image-20210722134417691.png" alt="image-20210722134417691"></p>
<p><img src="./image-20210722134426908.png" alt="image-20210722134426908"></p>
<p>æ¥ä¸‹æ¥é‡æ–°ç¼–è¯‘</p>
<p><img src="./image-20210722135316031.png" alt="image-20210722135316031"></p>
<p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34717531/article/details/108735629">è¿™ç¯‡</a>ï¼Œä¿®æ”¹äº†æ¶æ„ï¼Œé‡æ–°ä¿®æ”¹äº†ç®—åŠ›ï¼Œé‡æ–°ç¼–è¯‘ï¼Œok</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> opencv-4.4.0</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span><br><span class="line">    -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib-4.4.0/modules .. \</span><br><span class="line">    -DWITH_CUDA=1 \</span><br><span class="line">    -DCUDA_ARCH_BIN=7.0 \</span><br><span class="line">    -DENABLE_FAST_MATH=1 \</span><br><span class="line">    -DCUDA_FAST_MATH=1 \</span><br><span class="line">    -DWITH_CUBLAS=1 \</span><br><span class="line">    -DOPENCV_GENERATE_PKGCONFIG=1 \</span><br><span class="line">    -DCUDA_GENERATION=Volta ..</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210722134617694.png" alt="image-20210722134617694"></p>
<h2 id="windowsä¸Šçš„pybind11å°è¯•"><a href="#windowsä¸Šçš„pybind11å°è¯•" class="headerlink" title="windowsä¸Šçš„pybind11å°è¯•"></a>windowsä¸Šçš„pybind11å°è¯•</h2><p>ä¸€æ¬¡å¤±è´¥çš„å°è¯•ï¼Œä½†æ˜¯CMakeå‘½ä»¤è¡Œç¼–è¯‘64ä½ç¨‹åºè¦å­¦ä¼šå¦‚ä½•æ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -G &quot;Visual Studio 15 2017 Win64&quot; ..</span><br></pre></td></tr></table></figure>

<h2 id="ubuntuä¸Šçš„pybind11å®‰è£…"><a href="#ubuntuä¸Šçš„pybind11å®‰è£…" class="headerlink" title="ubuntuä¸Šçš„pybind11å®‰è£…"></a>ubuntuä¸Šçš„pybind11å®‰è£…</h2><ul>
<li>makeæ—¶å€™æœ‰error-ä¸å½±å“</li>
<li>installæ—¶å€™è¦sudo-ä¸ç”¨install</li>
</ul>
<h2 id="windowså®‰è£…libtorch"><a href="#windowså®‰è£…libtorch" class="headerlink" title="windowså®‰è£…libtorch"></a>windowså®‰è£…libtorch</h2><p>ä¸‹è½½ï¼š<a target="_blank" rel="noopener" href="https://download.pytorch.org/libtorch/cu102/libtorch-win-shared-with-deps-1.8.1%2Bcu102.zip">torch1.8.1+cu102ä¸‹è½½</a></p>
<p>é…ç½®ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jiejiaodebeiying/article/details/117186165">https://blog.csdn.net/jiejiaodebeiying/article/details/117186165</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xixixing/p/12842066.html">https://www.cnblogs.com/xixixing/p/12842066.html</a></li>
</ul>
<p>æŠ¥é”™è§£å†³ï¼š</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44816589/article/details/117068262">https://blog.csdn.net/weixin_44816589/article/details/117068262</a></p>
</li>
<li><p>å¦å¤–åŠ è½½æ¨¡å‹æ—¶å€™æŠ¥C10:Errorï¼Œç½‘ä¸Šæ‰¾èµ„æ–™å‡ ä¹éƒ½è¯´æ˜¯å¯¼å‡ºtorchscriptçš„torchç‰ˆæœ¬ä¸libtorchå®‰è£…ç‰ˆæœ¬ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œåå¤å°è¯•ï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43950348/article/details/115697900">è¿™ç¯‡</a>è§£å†³:</p>
<blockquote>
<p>é¡¹ç›®å³é”®-&gt;å±æ€§-&gt;é“¾æ¥å™¨-&gt;å‘½ä»¤è¡Œ-&gt;å…¶ä»–é€‰é¡¹è¾“å…¥-&gt;/INCLUDE:?warp_size@cuda@at@@YAHXZ</p>
</blockquote>
</li>
</ul>
<p>æ£€æµ‹é€Ÿåº¦:</p>
<p>warmupâ€ç©ºè·‘â€œä¸¤æ¬¡ä¹‹åï¼Œä¼¼ä¹è¿˜æ²¡å‡†å¤‡å¥½ï¼š</p>
<p><img src="./image-20210725181836340.png" alt="image-20210725181836340"></p>
<p>äºæ˜¯åˆå¤šâ€ç©ºè·‘â€ä¸¤æ¬¡ï¼Œåœ¨æœ¬æœºçš„å¹³å‡æ£€æµ‹æ—¶é—´æ˜¯26msï¼Œè€Œæœ¬æœºç›´æ¥ä½¿ç”¨pytorchè¿›è¡Œæ¨ç†çš„å¹³å‡æ—¶é—´çº¦70msã€‚</p>
<p>windowsä¸‹çš„é€Ÿåº¦å¯¹æ¯”</p>
<table>
<thead>
<tr>
<th align="center">æ–¹å¼</th>
<th align="center">æ—¶é—´</th>
<th align="center">CUDA</th>
<th align="center">warmup</th>
</tr>
</thead>
<tbody><tr>
<td align="center">pytorch+pt</td>
<td align="center">70ms</td>
<td align="center">âˆš</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(MinGW@Qt)+onnx</td>
<td align="center">184ms</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(MSVC@VS)+onnx</td>
<td align="center">110ms</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(MSVC@VS)+onnx</td>
<td align="center">28ms</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">opencv(python)+onnx</td>
<td align="center">260ms</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(python)+onnx</td>
<td align="center">160ms</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">libtorch+torchscript</td>
<td align="center">26ms</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
</tbody></table>
<p>æ€»ä½“æ¥çœ‹ï¼Œlibtorchæ–¹å¼æœ‰å¾ˆå¤§ä¼˜åŠ¿ï¼Œå†åŠ ä¸Šè½¬æˆsoä¹‹åæ”¾åœ¨pythonä¸­ä½¿ç”¨ï¼Œä¼šå˜å¾—æ›´å¿«ã€‚</p>
<h2 id="libtorchæŒ‡å®šCUDAæˆ–CPU"><a href="#libtorchæŒ‡å®šCUDAæˆ–CPU" class="headerlink" title="libtorchæŒ‡å®šCUDAæˆ–CPU"></a>libtorchæŒ‡å®šCUDAæˆ–CPU</h2><p>æŒ‡å®šcudaæˆ–è€…æŒ‡å®šcpuï¼Œéœ€è¦å°†modelå’Œimgæ”¾åœ¨åŒä¸€ä¸ªè®¾å¤‡ä¸Š</p>
<h3 id="æŒ‡å®šCUDA"><a href="#æŒ‡å®šCUDA" class="headerlink" title="æŒ‡å®šCUDA"></a>æŒ‡å®šCUDA</h3><ul>
<li><p>model</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cudaID = <span class="number">0</span>;</span><br><span class="line">torch::jit::script::Module model;</span><br><span class="line">model = torch::jit::<span class="built_in">load</span>(ptFile,torch::<span class="built_in">Device</span>(torch::DeviceType::CUDA,cudaID));</span><br></pre></td></tr></table></figure></li>
<li><p>image</p>
<p><strong>ä¸æ˜¯inplaceæ“ä½œ</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">torch::Tensor data = torch::<span class="built_in">rand</span>(&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>&#125;);</span><br><span class="line">data = data.<span class="built_in">to</span>(torch::<span class="built_in">Device</span>(torch::kCUDA, cudaID));</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ul>
<li><p>model</p>
<p>ä½¿ç”¨çš„æ˜¯CUDAç‰ˆæœ¬çš„libtorchï¼Œmodelé»˜è®¤æ˜¯ä½¿ç”¨CUDA:0åŠ è½½çš„ï¼Œè¦ä½¿ç”¨cpuéœ€è¦åˆ¶å®šä¸€ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">torch::jit::script::Module model;</span><br><span class="line">model = torch::jit::<span class="built_in">load</span>(ptFile,torch::kCPU);</span><br></pre></td></tr></table></figure></li>
<li><p>image</p>
<p>imageé»˜è®¤åŠ è½½åˆ°cpuä¸Šï¼Œä¸éœ€è¦æ“ä½œ</p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/libtorch/" rel="tag"># libtorch</a>
              <a href="/tags/pybind11/" rel="tag"># pybind11</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/19/html-css-js/" rel="prev" title="html+css+js">
                  <i class="fa fa-chevron-left"></i> html+css+js
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/27/mysql/" rel="next" title="MySQL">
                  MySQL <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">movice</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
