<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"jazzylee.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.6.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="记录将c++文件转换成so并使用python调用的过程。">
<meta property="og:type" content="article">
<meta property="og:title" content="cpp2so4python">
<meta property="og:url" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/index.html">
<meta property="og:site_name" content="movice">
<meta property="og:description" content="记录将c++文件转换成so并使用python调用的过程。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721211506818.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721211517929.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721220655534.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722020258432.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722020644010.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/@0VF94S5TTMAP%25%5BHHUK2E4O.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722021039835.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722222533236.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722222622332.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722222841636.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722232421332.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722233227768.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723123411146.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723123944869.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723141755679.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723141854704.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723170929884.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723183855153.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723223009737.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210723223911763.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724005744222.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724005908718.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724005934382.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724011834389.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724011943591.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724104438802.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724104610950.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724105227731.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724110314909.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724160925922.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724162331186.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210724162624894.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722134417691.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722134426908.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722135316031.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210722134617694.png">
<meta property="og:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210725181836340.png">
<meta property="article:published_time" content="2021-07-20T10:08:42.000Z">
<meta property="article:modified_time" content="2021-08-04T07:23:52.638Z">
<meta property="article:author" content="ljz">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="libtorch">
<meta property="article:tag" content="pybind11">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jazzylee.github.io/2021/07/20/cpp2so4python/image-20210721211506818.png">


<link rel="canonical" href="https://jazzylee.github.io/2021/07/20/cpp2so4python/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://jazzylee.github.io/2021/07/20/cpp2so4python/","path":"2021/07/20/cpp2so4python/","title":"cpp2so4python"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>cpp2so4python | movice</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">movice</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%8F"><span class="nav-number">1.</span> <span class="nav-text">序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pybind11"><span class="nav-number">2.</span> <span class="nav-text">pybind11</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Copy%E7%BD%91%E7%BB%9C%E8%B5%84%E6%BA%90"><span class="nav-number">2.1.</span> <span class="nav-text">Copy网络资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86C-%E7%9A%84%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E8%BD%AC%E4%B8%BAso"><span class="nav-number">2.2.</span> <span class="nav-text">将C++的目标检测转为so</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%9A%84cmakelists"><span class="nav-number">2.2.1.</span> <span class="nav-text">生成可执行文件的cmakelists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90so%E7%9A%84cmakelists"><span class="nav-number">2.2.2.</span> <span class="nav-text">生成so的cmakelists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90so%E7%9A%84c-%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.3.</span> <span class="nav-text">生成so的c++源文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E8%B0%83%E7%94%A8so"><span class="nav-number">2.2.4.</span> <span class="nav-text">python调用so</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%99%E6%8F%92%E6%9B%B2"><span class="nav-number">2.2.5.</span> <span class="nav-text">报错插曲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%9C%9C%E6%B1%81%E7%96%91%E9%97%AE"><span class="nav-number">2.2.6.</span> <span class="nav-text">蜜汁疑问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84"><span class="nav-number">2.3.</span> <span class="nav-text">完善</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90so%E7%9A%84c-%E6%BA%90%E6%96%87%E4%BB%B6-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">生成so的c++源文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E8%B0%83%E7%94%A8so-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">python调用so</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9F%E5%BA%A6%E5%AF%B9%E6%AF%94"><span class="nav-number">2.3.3.</span> <span class="nav-text">速度对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%9F%E7%B3%95%E7%9A%84%E7%B2%BE%E5%BA%A6"><span class="nav-number">2.3.4.</span> <span class="nav-text">糟糕的精度</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9boxThreshold"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">修改boxThreshold</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#yolov5m-pt-gt-yolov5m-onnx"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">yolov5m.pt-&gt;yolov5m.onnx</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%B1%E8%B4%A5%E7%9A%84%E7%8C%9C%E6%83%B3"><span class="nav-number">2.3.4.2.1.</span> <span class="nav-text">失败的猜想</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pt2pth2onnx"><span class="nav-number">2.3.4.2.2.</span> <span class="nav-text">pt2pth2onnx</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%A1%E6%80%9D%E4%B9%B1%E6%83%B3"><span class="nav-number">3.</span> <span class="nav-text">胡思乱想</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#libtorch"><span class="nav-number">4.</span> <span class="nav-text">libtorch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD-%E6%9C%89%E5%9D%91"><span class="nav-number">4.1.</span> <span class="nav-text">下载(有坑)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">4.2.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.3.</span> <span class="nav-text">加载模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E5%9D%91"><span class="nav-number">4.4.</span> <span class="nav-text">大坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#remake-%C3%97"><span class="nav-number">4.5.</span> <span class="nav-text">remake(×)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#remake2-%E2%88%9A"><span class="nav-number">4.6.</span> <span class="nav-text">remake2(√)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B2%BE%E5%BA%A6%E5%AF%B9%E6%AF%94-libtorch-onnx-pt"><span class="nav-number">4.7.</span> <span class="nav-text">精度对比(libtorch&#x2F;onnx&#x2F;pt)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%941"><span class="nav-number">4.7.1.</span> <span class="nav-text">对比1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%942"><span class="nav-number">4.7.2.</span> <span class="nav-text">对比2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%943"><span class="nav-number">4.7.3.</span> <span class="nav-text">对比3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%944"><span class="nav-number">4.7.4.</span> <span class="nav-text">对比4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">4.7.5.</span> <span class="nav-text">结论</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libtorch-pybind11"><span class="nav-number">4.8.</span> <span class="nav-text">libtorch+pybind11</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.8.1.</span> <span class="nav-text">c++程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cmakelists"><span class="nav-number">4.8.2.</span> <span class="nav-text">cmakelists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E8%B0%83%E7%94%A8"><span class="nav-number">4.8.3.</span> <span class="nav-text">python调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9F%E5%BA%A6%E5%AF%B9%E6%AF%94-1"><span class="nav-number">4.8.4.</span> <span class="nav-text">速度对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B2%BE%E5%BA%A6%E5%AF%B9%E6%AF%94"><span class="nav-number">4.8.5.</span> <span class="nav-text">精度对比</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ubuntu-opencv-cuda%E7%BC%96%E8%AF%91"><span class="nav-number">5.1.</span> <span class="nav-text">ubuntu opencv+cuda编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows%E4%B8%8A%E7%9A%84pybind11%E5%B0%9D%E8%AF%95"><span class="nav-number">5.2.</span> <span class="nav-text">windows上的pybind11尝试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ubuntu%E4%B8%8A%E7%9A%84pybind11%E5%AE%89%E8%A3%85"><span class="nav-number">5.3.</span> <span class="nav-text">ubuntu上的pybind11安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows%E5%AE%89%E8%A3%85libtorch"><span class="nav-number">5.4.</span> <span class="nav-text">windows安装libtorch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libtorch%E6%8C%87%E5%AE%9ACUDA%E6%88%96CPU"><span class="nav-number">5.5.</span> <span class="nav-text">libtorch指定CUDA或CPU</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9ACUDA"><span class="nav-number">5.5.1.</span> <span class="nav-text">指定CUDA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU"><span class="nav-number">5.5.2.</span> <span class="nav-text">CPU</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ljz</p>
  <div class="site-description" itemprop="description">写博客,或在写博客的路上</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
    </div>
    <div style="display:none">
      <!--clustrmaps-->
      <script type="text/javascript" id="clustrmaps" src="//clustrmaps.com/map_v2.js?d=V7pseSmYqG3eRqg-m6VS1UxwXHXL8gIybqq7QtBtLug&cl=ffffff&w=a"></script>
    </div>
    <!--music-->
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=195595&auto=0&height=66"></iframe>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jazzylee.github.io/2021/07/20/cpp2so4python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ljz">
      <meta itemprop="description" content="写博客,或在写博客的路上">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="movice">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          cpp2so4python
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-20 18:08:42" itemprop="dateCreated datePublished" datetime="2021-07-20T18:08:42+08:00">2021-07-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-08-04 15:23:52" itemprop="dateModified" datetime="2021-08-04T15:23:52+08:00">2021-08-04</time>
      </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>记录将c++文件转换成so并使用python调用的过程。</p>
<span id="more"></span>

<h1 id="序"><a href="#序" class="headerlink" title="序"></a>序</h1><p><a href="https://jazzylee.github.io/2021/07/17/yolo5-opencv-cuda/">上一篇</a>中记录了YOLOv5s在C++中的使用，采用的方法是将YOLOv5s的pt模型转成onnx模型，在C++中使用OpenCV的dnn模块加载模型进行推理，全程是在本地跑的（原因是服务器上的OpenCV竟没有CUDA加速，不过后来sudo重新编译了CUDA加速的版本），速度表现已经十分让我满意了。但是实际使用中，还是要求使在python环境中运行，于是开始找方法将C++转成python可导入的模块。</p>
<p>查了资料并比较了一下，决定使用pybind11。</p>
<blockquote>
<p>PS：ubuntu上的pybind11安装网络上有一堆资源，可以不用sudo，make完之后就可以用了。在使用时，我的cpp和pybind11文件夹放在同级目录，cmakelists中add_subdirectory(pybind11)</p>
</blockquote>
<h1 id="pybind11"><a href="#pybind11" class="headerlink" title="pybind11"></a>pybind11</h1><p>网上例子太多，其实仔细看一两个，就能基础操作了。</p>
<h2 id="Copy网络资源"><a href="#Copy网络资源" class="headerlink" title="Copy网络资源"></a>Copy网络资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42227520/article/details/108214796">参考1</a>，其中包含了cpp，cmakelists，经尝试，可以生成so并成功导入python。但是这个例子没有python import后的调用部分<img src="./image-20210721211506818.png" alt="image-20210721211506818"></li>
</ul>
<p><img src="./image-20210721211517929.png" alt="image-20210721211517929"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Heart_M/article/details/110958091">参考2</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zouzoupaopao229/article/details/106802249">参考3</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148076952">参考4</a></li>
</ul>
<p>以<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42227520/article/details/108214796">参考1</a>中的CreateObj方法(其实就是个算乘法的)为例：</p>
<p><img src="./image-20210721220655534.png" alt="image-20210721220655534"></p>
<p>生成so并被python导入后，调用CreatObj，传入两个int，返回int，py中使用如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libmap_interface</span><br><span class="line">mapinterface =libmap_interface.MapInterface()<span class="comment">#MapInterface是CPP中定义的类，这句实例化产生了对象mapinterface</span></span><br><span class="line">a=mapinterface.CreateObj(<span class="number">3</span>,<span class="number">4</span>)<span class="comment">#调用CreatObj方法，计算两数乘法</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&gt;<span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>这个例子里的函数命名有点奇葩，改了改，并精简了一下，可以作为一个pybind的mini demo</p>
<ul>
<li>C++如下</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">mul</span><span class="params">(<span class="keyword">int</span> img_row, <span class="keyword">int</span> img_col)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">echoInt</span><span class="params">(<span class="keyword">int</span> para)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayBye</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MapInterface::mul</span><span class="params">(<span class="keyword">int</span> img_row, <span class="keyword">int</span> img_col)</span></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> img_col*img_row;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapInterface::echoInt</span><span class="params">(<span class="keyword">int</span> para)</span></span>&#123;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;para: &quot;</span> &lt;&lt; para &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MapInterface::sayBye</span><span class="params">()</span></span>&#123;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;goodbye&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libmymap, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;pybind11 Hierarchical Localization cpp backend&quot;</span>;</span><br><span class="line">    py::class_&lt;MapInterface&gt;(m, <span class="string">&quot;MapInterface&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;mul&quot;</span>, &amp;MapInterface::mul, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;echoInt&quot;</span>, &amp;MapInterface::echoInt)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;sayBye&quot;</span>, &amp;MapInterface::sayBye);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>cmakelists如下</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION  <span class="number">3.16</span>.<span class="number">2</span>)</span><br><span class="line"><span class="keyword">project</span>(ProjectName)</span><br><span class="line"><span class="keyword">add_compile_options</span>(-std=c++<span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11 -g&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(PYBIND11_CPP_STANDARD -std=c++<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(pybind11)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INCLUDE_DIRECTORIES</span>(</span><br><span class="line">  <span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span></span><br><span class="line">  ./</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">add_library</span>(mymap MODULE </span><br><span class="line">            mymap.cpp</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(mymap </span><br><span class="line">            pybind11::module</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<ul>
<li>测试py如下</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libmymap</span><br><span class="line">cls = libmymap.MapInterface()</span><br><span class="line">cls.mul(<span class="number">3</span>,<span class="number">9</span>)<span class="comment">#&gt;27</span></span><br><span class="line">cls.sayBye()<span class="comment">#&gt;goodbye</span></span><br><span class="line">cls.echoInt(<span class="number">0</span>)<span class="comment">#&gt;para: 0</span></span><br></pre></td></tr></table></figure>

<h2 id="将C-的目标检测转为so"><a href="#将C-的目标检测转为so" class="headerlink" title="将C++的目标检测转为so"></a>将C++的目标检测转为so</h2><h3 id="生成可执行文件的cmakelists"><a href="#生成可执行文件的cmakelists" class="headerlink" title="生成可执行文件的cmakelists"></a>生成可执行文件的cmakelists</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION  3.16.2)</span><br><span class="line">project(yoloso)</span><br><span class="line">add_compile_options(-std=c++11)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -std=c++11 -g&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(PYBIND11_CPP_STANDARD -std=c++11)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">add_subdirectory(pybind11)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include_directories( <span class="variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span> )</span><br><span class="line">add_executable( predict predict.cpp )</span><br><span class="line">target_link_libraries( predict <span class="variable">$&#123;OpenCV_LIBS&#125;</span> )</span><br></pre></td></tr></table></figure>

<h3 id="生成so的cmakelists"><a href="#生成so的cmakelists" class="headerlink" title="生成so的cmakelists"></a>生成so的cmakelists</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION  <span class="number">3.16</span>.<span class="number">2</span>)</span><br><span class="line"><span class="keyword">project</span>(yoloso)</span><br><span class="line"><span class="keyword">add_compile_options</span>(-std=c++<span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11 -g&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE <span class="string">&quot;Release&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(PYBIND11_CPP_STANDARD -std=c++<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(OpenCV REQUIRED)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(pybind11)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>( <span class="variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span> )</span><br><span class="line"><span class="keyword">INCLUDE_DIRECTORIES</span>(</span><br><span class="line">  <span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span></span><br><span class="line">  ./</span><br><span class="line">)</span><br><span class="line"><span class="keyword">add_library</span>(predict MODULE </span><br><span class="line">            predict.cpp</span><br><span class="line">    )</span><br><span class="line"><span class="comment">#add_executable( predict predict.cpp )</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(predict </span><br><span class="line">            pybind11::module</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">target_link_libraries</span>( predict <span class="variable">$&#123;OpenCV_LIBS&#125;</span> )</span><br></pre></td></tr></table></figure>

<h3 id="生成so的c-源文件"><a href="#生成so的c-源文件" class="headerlink" title="生成so的c++源文件"></a>生成so的c++源文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/dnn.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> dnn;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Output</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;<span class="comment">//类别</span></span><br><span class="line">	<span class="keyword">float</span> confidence;<span class="comment">//置信度</span></span><br><span class="line">	cv::Rect box;<span class="comment">//矩形框</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(<span class="number">1.f</span> / (<span class="number">1.f</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netAnchors[<span class="number">3</span>][<span class="number">6</span>] = &#123; &#123; <span class="number">10.0</span>, <span class="number">13.0</span>, <span class="number">16.0</span>, <span class="number">30.0</span>, <span class="number">33.0</span>, <span class="number">23.0</span> &#125;,&#123; <span class="number">30.0</span>, <span class="number">61.0</span>, <span class="number">62.0</span>, <span class="number">45.0</span>, <span class="number">59.0</span>, <span class="number">119.0</span> &#125;,&#123; <span class="number">116.0</span>, <span class="number">90.0</span>, <span class="number">156.0</span>, <span class="number">198.0</span>, <span class="number">373.0</span>, <span class="number">326.0</span> &#125; &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netStride[<span class="number">3</span>] = &#123; <span class="number">8.0</span>, <span class="number">16.0</span>, <span class="number">32.0</span> &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netWidth = <span class="number">640</span>; <span class="comment">//输入大小</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netHeight = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;</span><br><span class="line">	<span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;</span><br><span class="line">	std::vector&lt;std::string&gt; className = &#123; <span class="string">&quot;cigar&quot;</span>,<span class="string">&quot;seatBelt&quot;</span> &#125;;<span class="comment">//类名</span></span><br><span class="line">	Net net;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">readModel</span><span class="params">(std::string netPath, <span class="keyword">bool</span> isCuda)</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">(string SrcImg)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Yolo::readModel</span><span class="params">(string netPath, <span class="keyword">bool</span> isCuda = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		net = <span class="built_in">readNetFromONNX</span>(netPath);</span><br><span class="line">	&#125;<span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;<span class="comment">//use GPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_CUDA);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CUDA);</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;	<span class="comment">//use CPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_DEFAULT);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CPU);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">Yolo::detect</span><span class="params">(string srcImg)</span> </span>&#123;</span><br><span class="line">	Mat blob;</span><br><span class="line">	Mat SrcImg = <span class="built_in">imread</span>(srcImg);</span><br><span class="line">	vector&lt;Output&gt; output;</span><br><span class="line">	<span class="built_in">blobFromImage</span>(SrcImg, blob, <span class="number">1</span> / <span class="number">255.0</span>, cv::<span class="built_in">Size</span>(netWidth, netHeight), <span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	net.<span class="built_in">setInput</span>(blob);</span><br><span class="line">	vector&lt;Mat&gt; netOutputImg;</span><br><span class="line">	net.forward(netOutputImg, net.<span class="built_in">getUnconnectedOutLayersNames</span>());</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; classIds;<span class="comment">//结果id数组</span></span><br><span class="line">	vector&lt;<span class="keyword">float</span>&gt; confidences;<span class="comment">//结果每个id对应置信度数组</span></span><br><span class="line">	vector&lt;Rect&gt; boxes;<span class="comment">//每个id矩形框</span></span><br><span class="line">	<span class="keyword">float</span> ratio_h = (<span class="keyword">float</span>)SrcImg.rows / netHeight;</span><br><span class="line">	<span class="keyword">float</span> ratio_w = (<span class="keyword">float</span>)SrcImg.cols / netWidth;</span><br><span class="line">	<span class="keyword">int</span> net_width = className.<span class="built_in">size</span>() + <span class="number">5</span>;  <span class="comment">//输出的网络宽度是类别数+5</span></span><br><span class="line">	<span class="keyword">float</span>* pdata = (<span class="keyword">float</span>*)netOutputImg[<span class="number">0</span>].data;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> stride = <span class="number">0</span>; stride &lt; <span class="number">3</span>; stride++) &#123;    <span class="comment">//stride</span></span><br><span class="line">		<span class="keyword">int</span> grid_x = (<span class="keyword">int</span>)(netWidth / netStride[stride]);</span><br><span class="line">		<span class="keyword">int</span> grid_y = (<span class="keyword">int</span>)(netHeight / netStride[stride]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> anchor = <span class="number">0</span>; anchor &lt; <span class="number">3</span>; anchor++) &#123; <span class="comment">//anchors</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_w = netAnchors[stride][anchor * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_h = netAnchors[stride][anchor * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid_y; i++) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid_y; j++) &#123;</span><br><span class="line">					<span class="keyword">float</span> box_score = <span class="built_in">Sigmoid</span>(pdata[<span class="number">4</span>]);<span class="comment">//获取每一行的box框中含有某个物体的概率</span></span><br><span class="line">					<span class="keyword">if</span> (box_score &gt; boxThreshold) &#123;</span><br><span class="line">						<span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32FC1, pdata + <span class="number">5</span>)</span></span>;</span><br><span class="line">						Point classIdPoint;</span><br><span class="line">						<span class="keyword">double</span> max_class_socre;</span><br><span class="line">						cv::<span class="built_in">minMaxLoc</span>(scores, <span class="number">0</span>, &amp;max_class_socre, <span class="number">0</span>, &amp;classIdPoint);</span><br><span class="line">						max_class_socre = <span class="built_in">Sigmoid</span>((<span class="keyword">float</span>)max_class_socre);</span><br><span class="line">						<span class="keyword">if</span> (max_class_socre &gt; classThreshold) &#123;</span><br><span class="line">							<span class="keyword">float</span> x = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">0</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + j) * netStride[stride];  <span class="comment">//x</span></span><br><span class="line">							<span class="keyword">float</span> y = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">1</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + i) * netStride[stride];   <span class="comment">//y</span></span><br><span class="line">							<span class="keyword">float</span> w = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">2</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_w;   <span class="comment">//w</span></span><br><span class="line">							<span class="keyword">float</span> h = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">3</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_h;  <span class="comment">//h</span></span><br><span class="line">							<span class="keyword">int</span> left = (x - <span class="number">0.5</span>*w)*ratio_w;</span><br><span class="line">							<span class="keyword">int</span> top = (y - <span class="number">0.5</span>*h)*ratio_h;</span><br><span class="line">							classIds.<span class="built_in">push_back</span>(classIdPoint.x);</span><br><span class="line">							confidences.<span class="built_in">push_back</span>(max_class_socre);</span><br><span class="line">							boxes.<span class="built_in">push_back</span>(<span class="built_in">Rect</span>(left, top, <span class="built_in"><span class="keyword">int</span></span>(w*ratio_w), <span class="built_in"><span class="keyword">int</span></span>(h*ratio_h)));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					pdata += net_width;<span class="comment">//指针移到下一行</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//NMS</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; nms_result;</span><br><span class="line">	<span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nms_result.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> idx = nms_result[i];</span><br><span class="line">		Output result;</span><br><span class="line">		result.id = classIds[idx];</span><br><span class="line">		result.confidence = confidences[idx];</span><br><span class="line">		result.box = boxes[idx];</span><br><span class="line">		<span class="keyword">if</span> (result.id == <span class="number">0</span>) &#123;<span class="comment">//only cigar</span></span><br><span class="line">			output.<span class="built_in">push_back</span>(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; output.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().y);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// void printCoordinate(vector&lt;int&gt; &amp;detectResult) &#123;</span></span><br><span class="line"><span class="comment">// 	for (int i = 0; i &lt; detectResult.size()/4; i++) &#123;</span></span><br><span class="line"><span class="comment">// 		cout &lt;&lt; detectResult[i*4] &lt;&lt; &quot;\t&quot; &lt;&lt; detectResult[i * 4+1] &lt;&lt; &quot;\t&quot; &lt;&lt; detectResult[i * 4+2] &lt;&lt; &quot;\t&quot; &lt;&lt; detectResult[i * 4+3] &lt;&lt; &quot;\t&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	cout &lt;&lt; &quot;============================&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// int main()</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">// 	string img_path = &quot;./0 (6).png&quot;;</span></span><br><span class="line"><span class="comment">// 	string modelPath = &quot;./yolov5s.onnx&quot;;</span></span><br><span class="line"><span class="comment">// 	Yolo model;</span></span><br><span class="line"><span class="comment">// 	bool initFlag = false;</span></span><br><span class="line"><span class="comment">// 	clock_t start, end;//检测计时</span></span><br><span class="line"><span class="comment">// 	if (model.readModel(modelPath)) &#123;</span></span><br><span class="line"><span class="comment">// 		for (int c = 0; c &lt; 20; c++) &#123;//检测20次</span></span><br><span class="line"><span class="comment">// 			start = clock();</span></span><br><span class="line"><span class="comment">// 			Mat img = imread(img_path);</span></span><br><span class="line"><span class="comment">// 			vector&lt;int&gt; detectResult = model.detect(img);</span></span><br><span class="line"><span class="comment">// 			end = clock();</span></span><br><span class="line"><span class="comment">// 			cout &lt;&lt; &quot;Detect time:&quot; &lt;&lt; double(end - start) / CLOCKS_PER_SEC &lt;&lt; &quot;s&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// 			printCoordinate(detectResult);</span></span><br><span class="line"><span class="comment">// 		&#125;</span></span><br><span class="line"><span class="comment">// 	&#125;else &#123;</span></span><br><span class="line"><span class="comment">// 		cout &lt;&lt; &quot;模型初始化失败&quot; &lt;&lt; endl;</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	return 0;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libpredict, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;yolov5s lib for python&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    py::class_&lt;Yolo&gt;(m, <span class="string">&quot;Yolo&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;readModel&quot;</span>, &amp;Yolo::readModel, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;detect&quot;</span>, &amp;Yolo::detect, py::return_value_policy::copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="python调用so"><a href="#python调用so" class="headerlink" title="python调用so"></a>python调用so</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> libpredict</span><br><span class="line"></span><br><span class="line">yolo = libpredict.Yolo()</span><br><span class="line">useGpu = <span class="literal">True</span></span><br><span class="line">modelPath = <span class="string">&#x27;./yolov5s.onnx&#x27;</span></span><br><span class="line">imgPath = <span class="string">&#x27;test.png&#x27;</span></span><br><span class="line"></span><br><span class="line">inited = yolo.readModel(modelPath,useGpu)</span><br><span class="line"><span class="keyword">if</span>(inited):</span><br><span class="line">    sumTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        img = cv2.imread(imgPath)</span><br><span class="line">        start = time.time()</span><br><span class="line">        result = yolo.detect(img)</span><br><span class="line">        end = time.time()</span><br><span class="line">        <span class="built_in">print</span>(end-start)</span><br><span class="line">        <span class="keyword">if</span> i!= <span class="number">0</span>:</span><br><span class="line">            sumTime+=(end-start)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;============&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(sumTime/<span class="number">19</span>)</span><br></pre></td></tr></table></figure>

<h3 id="报错插曲"><a href="#报错插曲" class="headerlink" title="报错插曲"></a>报错插曲</h3><p><img src="./image-20210722020258432.png" alt="image-20210722020258432"></p>
<p>已解决，添加了#include&lt;pybind11/stl.h&gt;头文件</p>
<p><img src="./image-20210722020644010.png" alt="image-20210722020644010"></p>
<p>现在的瑕疵是dnn模块还不支持cuda加速，另外，现在<strong>还不支持直接传入mat</strong>(后面解决)</p>
<h3 id="蜜汁疑问"><a href="#蜜汁疑问" class="headerlink" title="蜜汁疑问"></a>蜜汁疑问</h3><p>为什么用了pybind11后，比原始的c++实现更快了？？</p>
<p><img src="./@0VF94S5TTMAP%25%5BHHUK2E4O.png" alt="img"></p>
<p><img src="./image-20210722021039835.png" alt="image-20210722021039835"></p>
<h2 id="完善"><a href="#完善" class="headerlink" title="完善"></a>完善</h2><p>上面的程序python中直接传入img path，但是显然传入opencv加载的图片更具一般性。然而python中的opencv加载的图片是ndarray的格式，C++中是cv::mat。<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/be16847b0b74?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation">参考</a>解决，主要是在cpp中增加了ndarray转mat的函数。</p>
<p>最终的cpp/py如下：</p>
<h3 id="生成so的c-源文件-1"><a href="#生成so的c-源文件-1" class="headerlink" title="生成so的c++源文件"></a>生成so的c++源文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/dnn.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/numpy.h&gt;</span><span class="comment">//add</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> dnn;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Output</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;<span class="comment">//类别</span></span><br><span class="line">	<span class="keyword">float</span> confidence;<span class="comment">//置信度</span></span><br><span class="line">	cv::Rect box;<span class="comment">//矩形框</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Python-&gt;C++ Mat</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_1c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;1-channel image must be 2 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC1, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_3c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;3-channel image must be 3 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC3, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(<span class="number">1.f</span> / (<span class="number">1.f</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netAnchors[<span class="number">3</span>][<span class="number">6</span>] = &#123; &#123; <span class="number">10.0</span>, <span class="number">13.0</span>, <span class="number">16.0</span>, <span class="number">30.0</span>, <span class="number">33.0</span>, <span class="number">23.0</span> &#125;,&#123; <span class="number">30.0</span>, <span class="number">61.0</span>, <span class="number">62.0</span>, <span class="number">45.0</span>, <span class="number">59.0</span>, <span class="number">119.0</span> &#125;,&#123; <span class="number">116.0</span>, <span class="number">90.0</span>, <span class="number">156.0</span>, <span class="number">198.0</span>, <span class="number">373.0</span>, <span class="number">326.0</span> &#125; &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netStride[<span class="number">3</span>] = &#123; <span class="number">8.0</span>, <span class="number">16.0</span>, <span class="number">32.0</span> &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netWidth = <span class="number">640</span>; <span class="comment">//输入大小</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netHeight = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;</span><br><span class="line">	<span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;</span><br><span class="line">	std::vector&lt;std::string&gt; className = &#123; <span class="string">&quot;cigar&quot;</span>,<span class="string">&quot;seatBelt&quot;</span> &#125;;<span class="comment">//类名</span></span><br><span class="line">	Net net;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">readModel</span><span class="params">(std::string netPath, <span class="keyword">bool</span> isCuda)</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Yolo::readModel</span><span class="params">(string netPath, <span class="keyword">bool</span> isCuda = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		net = <span class="built_in">readNetFromONNX</span>(netPath);</span><br><span class="line">	&#125;<span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;<span class="comment">//use GPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_CUDA);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CUDA);</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;	<span class="comment">//use CPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_DEFAULT);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CPU);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">Yolo::detect</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span> </span>&#123;</span><br><span class="line">	Mat blob;</span><br><span class="line">	<span class="comment">// Mat SrcImg = imread(srcImg);</span></span><br><span class="line">	Mat SrcImg = <span class="built_in">numpy_uint8_3c_to_cv_mat</span>(input);</span><br><span class="line">	vector&lt;Output&gt; output;</span><br><span class="line">	<span class="built_in">blobFromImage</span>(SrcImg, blob, <span class="number">1</span> / <span class="number">255.0</span>, cv::<span class="built_in">Size</span>(netWidth, netHeight), <span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	net.<span class="built_in">setInput</span>(blob);</span><br><span class="line">	vector&lt;Mat&gt; netOutputImg;</span><br><span class="line">	net.forward(netOutputImg, net.<span class="built_in">getUnconnectedOutLayersNames</span>());</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; classIds;<span class="comment">//结果id数组</span></span><br><span class="line">	vector&lt;<span class="keyword">float</span>&gt; confidences;<span class="comment">//结果每个id对应置信度数组</span></span><br><span class="line">	vector&lt;Rect&gt; boxes;<span class="comment">//每个id矩形框</span></span><br><span class="line">	<span class="keyword">float</span> ratio_h = (<span class="keyword">float</span>)SrcImg.rows / netHeight;</span><br><span class="line">	<span class="keyword">float</span> ratio_w = (<span class="keyword">float</span>)SrcImg.cols / netWidth;</span><br><span class="line">	<span class="keyword">int</span> net_width = className.<span class="built_in">size</span>() + <span class="number">5</span>;  <span class="comment">//输出的网络宽度是类别数+5</span></span><br><span class="line">	<span class="keyword">float</span>* pdata = (<span class="keyword">float</span>*)netOutputImg[<span class="number">0</span>].data;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> stride = <span class="number">0</span>; stride &lt; <span class="number">3</span>; stride++) &#123;    <span class="comment">//stride</span></span><br><span class="line">		<span class="keyword">int</span> grid_x = (<span class="keyword">int</span>)(netWidth / netStride[stride]);</span><br><span class="line">		<span class="keyword">int</span> grid_y = (<span class="keyword">int</span>)(netHeight / netStride[stride]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> anchor = <span class="number">0</span>; anchor &lt; <span class="number">3</span>; anchor++) &#123; <span class="comment">//anchors</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_w = netAnchors[stride][anchor * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_h = netAnchors[stride][anchor * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid_y; i++) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid_y; j++) &#123;</span><br><span class="line">					<span class="keyword">float</span> box_score = <span class="built_in">Sigmoid</span>(pdata[<span class="number">4</span>]);<span class="comment">//获取每一行的box框中含有某个物体的概率</span></span><br><span class="line">					<span class="keyword">if</span> (box_score &gt; boxThreshold) &#123;</span><br><span class="line">						<span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32FC1, pdata + <span class="number">5</span>)</span></span>;</span><br><span class="line">						Point classIdPoint;</span><br><span class="line">						<span class="keyword">double</span> max_class_socre;</span><br><span class="line">						cv::<span class="built_in">minMaxLoc</span>(scores, <span class="number">0</span>, &amp;max_class_socre, <span class="number">0</span>, &amp;classIdPoint);</span><br><span class="line">						max_class_socre = <span class="built_in">Sigmoid</span>((<span class="keyword">float</span>)max_class_socre);</span><br><span class="line">						<span class="keyword">if</span> (max_class_socre &gt; classThreshold) &#123;</span><br><span class="line">							<span class="keyword">float</span> x = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">0</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + j) * netStride[stride];  <span class="comment">//x</span></span><br><span class="line">							<span class="keyword">float</span> y = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">1</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + i) * netStride[stride];   <span class="comment">//y</span></span><br><span class="line">							<span class="keyword">float</span> w = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">2</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_w;   <span class="comment">//w</span></span><br><span class="line">							<span class="keyword">float</span> h = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">3</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_h;  <span class="comment">//h</span></span><br><span class="line">							<span class="keyword">int</span> left = (x - <span class="number">0.5</span>*w)*ratio_w;</span><br><span class="line">							<span class="keyword">int</span> top = (y - <span class="number">0.5</span>*h)*ratio_h;</span><br><span class="line">							classIds.<span class="built_in">push_back</span>(classIdPoint.x);</span><br><span class="line">							confidences.<span class="built_in">push_back</span>(max_class_socre);</span><br><span class="line">							boxes.<span class="built_in">push_back</span>(<span class="built_in">Rect</span>(left, top, <span class="built_in"><span class="keyword">int</span></span>(w*ratio_w), <span class="built_in"><span class="keyword">int</span></span>(h*ratio_h)));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					pdata += net_width;<span class="comment">//指针移到下一行</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//NMS</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; nms_result;</span><br><span class="line">	<span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nms_result.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> idx = nms_result[i];</span><br><span class="line">		Output result;</span><br><span class="line">		result.id = classIds[idx];</span><br><span class="line">		result.confidence = confidences[idx];</span><br><span class="line">		result.box = boxes[idx];</span><br><span class="line">		<span class="keyword">if</span> (result.id == <span class="number">0</span>) &#123;<span class="comment">//only cigar</span></span><br><span class="line">			output.<span class="built_in">push_back</span>(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; output.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().y);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libpredict, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;yolov5s lib for python&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    py::class_&lt;Yolo&gt;(m, <span class="string">&quot;Yolo&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;readModel&quot;</span>, &amp;Yolo::readModel, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;detect&quot;</span>, &amp;Yolo::detect, py::return_value_policy::copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="python调用so-1"><a href="#python调用so-1" class="headerlink" title="python调用so"></a>python调用so</h3><p>这时，python中使用时，传入的参数是imread后的ndarray</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> libpredict</span><br><span class="line">yolo = libpredict.Yolo()</span><br><span class="line">initFlag = yolo.readModel(<span class="string">&quot;./yolov5s.onnx&quot;</span>,<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span>(initFlag):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    	img = cv2.imread(<span class="string">&quot;./0 (6).png&quot;</span>)</span><br><span class="line">    	start = time.time()</span><br><span class="line">    	result = yolo.detect(img)</span><br><span class="line">    	<span class="built_in">print</span>(time.time()-start)</span><br><span class="line">    	<span class="built_in">print</span>(result)</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&#x27;============&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="速度对比"><a href="#速度对比" class="headerlink" title="速度对比"></a>速度对比</h3><p>yolov5s检测速度对比(同一张图片，20次取平均)</p>
<ul>
<li><p>Tesla V100-SXM2 32GB，<strong>空载</strong></p>
</li>
<li><p>Intel(R) Xeon(R) Gold 6240 CPU @ 2.60GHz</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">语言</th>
<th align="center">框架</th>
<th align="center">模型</th>
<th align="center">时间</th>
<th align="center">备注</th>
<th>显存占用</th>
<th align="center">路径</th>
</tr>
</thead>
<tbody><tr>
<td align="center">C++</td>
<td align="center">opencv 4.4.0+cuda</td>
<td align="center">onnx</td>
<td align="center">后19次平均32.3ms</td>
<td align="center">第一次需要2s多</td>
<td>1130MB</td>
<td align="center">~/cvyolo_cpp/predict.cpp</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">opencv 4.4.0+cuda+<strong>so</strong></td>
<td align="center">onnx</td>
<td align="center">后19次平均<strong>14.9ms</strong></td>
<td align="center">第一次需要3s多</td>
<td>1260MB</td>
<td align="center">~/cvyolo/pytest.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">pytorch 1.8.1+cuda</td>
<td align="center">pt</td>
<td align="center">169ms</td>
<td align="center">方差小，但是比我1650还慢</td>
<td>1415MB</td>
<td align="center">~/v5/yolov5/predict.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">python-opencv</td>
<td align="center">onnx</td>
<td align="center">689ms</td>
<td align="center">方差小</td>
<td>Pass(CPU)</td>
<td align="center">~/cvyolo/opencvYOLO.py</td>
</tr>
</tbody></table>
<h3 id="糟糕的精度"><a href="#糟糕的精度" class="headerlink" title="糟糕的精度"></a>糟糕的精度</h3><p>这个速度已经相当令我满意了，pybind11生成so后，第二行python中的结果和第一行c++中的推理结果一致，且耗时更短。</p>
<p>但是当和原版pytorch的pt模型对比时，发现精度掉了太多，于是尝试提升模型精度。</p>
<p>能想到的几个方法是：</p>
<ul>
<li>使用yolov5m训练的权重再转onnx(虽然yolov5m在pytorch中的速度比v5s慢一些，但是精度高一些)</li>
<li>想办法修改一下后处理的部分(NMS)</li>
</ul>
<h4 id="修改boxThreshold"><a href="#修改boxThreshold" class="headerlink" title="修改boxThreshold"></a>修改boxThreshold</h4><p>pytorch方式对比opencv onnx方式的区别在于后处理不一样，pytorch的后处理官方在predict.py中写好了，opencv的后处理是copy别人的github项目，另外copy来的里面有3个可控的参数，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;<span class="comment">//a threshold used in non maximum suppression.</span></span><br><span class="line"><span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;<span class="comment">//a threshold used to filter boxes by score.</span></span><br><span class="line"><span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;<span class="comment">//这个没有用在NMS中，表示含有某个物体的概率</span></span><br><span class="line"><span class="comment">//调用时核心是使用下面的的函数</span></span><br><span class="line"><span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line"><span class="comment">//声明如下</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NMSBoxes</span><span class="params">(<span class="keyword">const</span> std::vector&lt;Rect&gt;&amp; bboxes, <span class="keyword">const</span> std::vector&lt;<span class="keyword">float</span>&gt;&amp; scores,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">const</span> <span class="keyword">float</span> score_threshold, <span class="keyword">const</span> <span class="keyword">float</span> nms_threshold,</span></span></span><br><span class="line"><span class="params"><span class="function">                               CV_OUT std::vector&lt;<span class="keyword">int</span>&gt;&amp; indices,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">const</span> <span class="keyword">float</span> eta = <span class="number">1.f</span>, <span class="keyword">const</span> <span class="keyword">int</span> top_k = <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="comment">/** @brief Performs non maximum suppression given boxes and corresponding scores.</span></span><br><span class="line"><span class="comment">     * @param bboxes a set of bounding boxes to apply NMS.</span></span><br><span class="line"><span class="comment">     * @param scores a set of corresponding confidences.</span></span><br><span class="line"><span class="comment">     * @param score_threshold a threshold used to filter boxes by score.</span></span><br><span class="line"><span class="comment">     * @param nms_threshold a threshold used in non maximum suppression.</span></span><br><span class="line"><span class="comment">     * @param indices the kept indices of bboxes after NMS.</span></span><br><span class="line"><span class="comment">     * @param eta a coefficient in adaptive threshold formula: \f$nms\_threshold_&#123;i+1&#125;=eta\cdot nms\_threshold_i\f$.</span></span><br><span class="line"><span class="comment">     * @param top_k if `&gt;0`, keep at most @p top_k picked indices.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure>

<p>在原版yolov5的predict.py中只有两个：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conf_thres=<span class="number">0.25</span>,  <span class="comment"># confidence threshold</span></span><br><span class="line">iou_thres=<span class="number">0.45</span>,  <span class="comment"># NMS IOU threshold</span></span><br></pre></td></tr></table></figure>

<p>尝试把boxThreshold调高一点，如0.4</p>
<p>调整前后对比，发现确实少了一个框，但是留下的这个更离谱。。。</p>
<blockquote>
<p>pt模型没有检测到目标，onnx检测到两个框(真实的目标和字母P的竖线)。</p>
<p>但是改了boxThreshold后，把P的竖线留下了。。。</p>
</blockquote>
<p><img src="./image-20210722222533236.png" alt="before(python+so)"></p>
<p><img src="./image-20210722222622332.png" alt="after(c++)"></p>
<p><img src="./image-20210722222841636.png" alt="image-20210722222841636"></p>
<h4 id="yolov5m-pt-gt-yolov5m-onnx"><a href="#yolov5m-pt-gt-yolov5m-onnx" class="headerlink" title="yolov5m.pt-&gt;yolov5m.onnx"></a>yolov5m.pt-&gt;yolov5m.onnx</h4><blockquote>
<p>此时boxThreshold改为原始的0.25</p>
</blockquote>
<p>已生成onnx(E:\projs\v5\yolov5\runs\train\exp15\weights)，但是模型文件竟然到了80MB+</p>
<p>抽象的输出又来了，而且这次耗时更久。</p>
<p><img src="./image-20210722232421332.png" alt="image-20210722232421332"></p>
<p>下面试试pt原版耗时多久，检测ok，所以还是<strong>pt-&gt;pth-&gt;onnx</strong>出了问题</p>
<p><img src="./image-20210722233227768.png" alt="image-20210722233227768"></p>
<h5 id="失败的猜想"><a href="#失败的猜想" class="headerlink" title="失败的猜想"></a>失败的猜想</h5><p>尝试一下使用pt直接转onnx，生成的onnx大小84.2MB</p>
<p>问题来了，同样是下面一段，在windows可用，ubuntu不可用</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;opencv2/dnn.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> dnn;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Output</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;<span class="comment">//类别</span></span><br><span class="line">	<span class="keyword">float</span> confidence;<span class="comment">//置信度</span></span><br><span class="line">	cv::Rect box;<span class="comment">//矩形框</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yolo</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">Sigmoid</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(<span class="number">1.f</span> / (<span class="number">1.f</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netAnchors[<span class="number">3</span>][<span class="number">6</span>] = &#123; &#123; <span class="number">10.0</span>, <span class="number">13.0</span>, <span class="number">16.0</span>, <span class="number">30.0</span>, <span class="number">33.0</span>, <span class="number">23.0</span> &#125;,&#123; <span class="number">30.0</span>, <span class="number">61.0</span>, <span class="number">62.0</span>, <span class="number">45.0</span>, <span class="number">59.0</span>, <span class="number">119.0</span> &#125;,&#123; <span class="number">116.0</span>, <span class="number">90.0</span>, <span class="number">156.0</span>, <span class="number">198.0</span>, <span class="number">373.0</span>, <span class="number">326.0</span> &#125; &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> netStride[<span class="number">3</span>] = &#123; <span class="number">8.0</span>, <span class="number">16.0</span>, <span class="number">32.0</span> &#125;;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netWidth = <span class="number">640</span>; <span class="comment">//输入大小</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> netHeight = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">double</span> nmsThreshold = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">double</span> boxThreshold = <span class="number">0.25</span>;</span><br><span class="line">	<span class="keyword">double</span> classThreshold = <span class="number">0.25</span>;</span><br><span class="line">	std::vector&lt;std::string&gt; className = &#123; <span class="string">&quot;cigar&quot;</span>,<span class="string">&quot;seatBelt&quot;</span> &#125;;<span class="comment">//类名</span></span><br><span class="line">	Net net;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">readModel</span><span class="params">(std::string netPath, <span class="keyword">bool</span> isCuda)</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">detect</span><span class="params">(string SrcImg)</span></span>;</span><br><span class="line">	<span class="comment">// vector&lt;int&gt; detect(py::array_t&lt;unsigned char&gt;&amp; input);//生成so文件要用这个</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Yolo::readModel</span><span class="params">(string netPath, <span class="keyword">bool</span> isCuda = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		net = <span class="built_in">readNetFromONNX</span>(netPath);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in"><span class="keyword">catch</span></span> (<span class="keyword">const</span> std::exception&amp;) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;<span class="comment">//use GPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_CUDA);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CUDA);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;	<span class="comment">//use CPU</span></span><br><span class="line">		net.<span class="built_in">setPreferableBackend</span>(cv::dnn::DNN_BACKEND_DEFAULT);</span><br><span class="line">		net.<span class="built_in">setPreferableTarget</span>(cv::dnn::DNN_TARGET_CPU);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">Yolo::detect</span><span class="params">(string srcImg)</span> </span>&#123;</span><br><span class="line">	Mat blob;</span><br><span class="line">	Mat SrcImg = <span class="built_in">imread</span>(srcImg);</span><br><span class="line">	<span class="comment">// Mat SrcImg = numpy_uint8_3c_to_cv_mat(input);//so文件要用</span></span><br><span class="line">	vector&lt;Output&gt; output;</span><br><span class="line">	<span class="built_in">blobFromImage</span>(SrcImg, blob, <span class="number">1</span> / <span class="number">255.0</span>, cv::<span class="built_in">Size</span>(netWidth, netHeight), <span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	net.<span class="built_in">setInput</span>(blob);</span><br><span class="line">	vector&lt;Mat&gt; netOutputImg;</span><br><span class="line">	net.forward(netOutputImg, net.<span class="built_in">getUnconnectedOutLayersNames</span>());</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; classIds;<span class="comment">//结果id数组</span></span><br><span class="line">	vector&lt;<span class="keyword">float</span>&gt; confidences;<span class="comment">//结果每个id对应置信度数组</span></span><br><span class="line">	vector&lt;Rect&gt; boxes;<span class="comment">//每个id矩形框</span></span><br><span class="line">	<span class="keyword">float</span> ratio_h = (<span class="keyword">float</span>)SrcImg.rows / netHeight;</span><br><span class="line">	<span class="keyword">float</span> ratio_w = (<span class="keyword">float</span>)SrcImg.cols / netWidth;</span><br><span class="line">	<span class="keyword">int</span> net_width = className.<span class="built_in">size</span>() + <span class="number">5</span>;  <span class="comment">//输出的网络宽度是类别数+5</span></span><br><span class="line">	<span class="keyword">float</span>* pdata = (<span class="keyword">float</span>*)netOutputImg[<span class="number">0</span>].data;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> stride = <span class="number">0</span>; stride &lt; <span class="number">3</span>; stride++) &#123;    <span class="comment">//stride</span></span><br><span class="line">		<span class="keyword">int</span> grid_x = (<span class="keyword">int</span>)(netWidth / netStride[stride]);</span><br><span class="line">		<span class="keyword">int</span> grid_y = (<span class="keyword">int</span>)(netHeight / netStride[stride]);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> anchor = <span class="number">0</span>; anchor &lt; <span class="number">3</span>; anchor++) &#123; <span class="comment">//anchors</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_w = netAnchors[stride][anchor * <span class="number">2</span>];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> anchor_h = netAnchors[stride][anchor * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grid_y; i++) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; grid_y; j++) &#123;</span><br><span class="line">					<span class="keyword">float</span> box_score = <span class="built_in">Sigmoid</span>(pdata[<span class="number">4</span>]);<span class="comment">//获取每一行的box框中含有某个物体的概率</span></span><br><span class="line">					<span class="keyword">if</span> (box_score &gt; boxThreshold) &#123;</span><br><span class="line">						<span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32FC1, pdata + <span class="number">5</span>)</span></span>;</span><br><span class="line">						Point classIdPoint;</span><br><span class="line">						<span class="keyword">double</span> max_class_socre;</span><br><span class="line">						cv::<span class="built_in">minMaxLoc</span>(scores, <span class="number">0</span>, &amp;max_class_socre, <span class="number">0</span>, &amp;classIdPoint);</span><br><span class="line">						max_class_socre = <span class="built_in">Sigmoid</span>((<span class="keyword">float</span>)max_class_socre);</span><br><span class="line">						<span class="keyword">if</span> (max_class_socre &gt; classThreshold) &#123;</span><br><span class="line">							<span class="keyword">float</span> x = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">0</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + j) * netStride[stride];  <span class="comment">//x</span></span><br><span class="line">							<span class="keyword">float</span> y = (<span class="built_in">Sigmoid</span>(pdata[<span class="number">1</span>]) * <span class="number">2.f</span> - <span class="number">0.5f</span> + i) * netStride[stride];   <span class="comment">//y</span></span><br><span class="line">							<span class="keyword">float</span> w = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">2</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_w;   <span class="comment">//w</span></span><br><span class="line">							<span class="keyword">float</span> h = <span class="built_in">powf</span>(<span class="built_in">Sigmoid</span>(pdata[<span class="number">3</span>]) * <span class="number">2.f</span>, <span class="number">2.f</span>) * anchor_h;  <span class="comment">//h</span></span><br><span class="line">							<span class="keyword">int</span> left = (x - <span class="number">0.5</span>*w)*ratio_w;</span><br><span class="line">							<span class="keyword">int</span> top = (y - <span class="number">0.5</span>*h)*ratio_h;</span><br><span class="line">							classIds.<span class="built_in">push_back</span>(classIdPoint.x);</span><br><span class="line">							confidences.<span class="built_in">push_back</span>(max_class_socre);</span><br><span class="line">							boxes.<span class="built_in">push_back</span>(<span class="built_in">Rect</span>(left, top, <span class="built_in"><span class="keyword">int</span></span>(w*ratio_w), <span class="built_in"><span class="keyword">int</span></span>(h*ratio_h)));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					pdata += net_width;<span class="comment">//指针移到下一行</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//NMS</span></span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; nms_result;</span><br><span class="line">	<span class="built_in">NMSBoxes</span>(boxes, confidences, classThreshold, nmsThreshold, nms_result);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nms_result.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		<span class="keyword">int</span> idx = nms_result[i];</span><br><span class="line">		Output result;</span><br><span class="line">		result.id = classIds[idx];</span><br><span class="line">		result.confidence = confidences[idx];</span><br><span class="line">		result.box = boxes[idx];</span><br><span class="line">		<span class="keyword">if</span> (result.id == <span class="number">0</span>) &#123;<span class="comment">//only cigar</span></span><br><span class="line">			output.<span class="built_in">push_back</span>(result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; output.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">tl</span>().y);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().x);</span><br><span class="line">		detectResult.<span class="built_in">push_back</span>(output[i].box.<span class="built_in">br</span>().y);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printCoordinate</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;detectResult)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; detectResult.<span class="built_in">size</span>() / <span class="number">4</span>; i++) &#123;</span><br><span class="line">		cout &lt;&lt; detectResult[i * <span class="number">4</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span> + <span class="number">1</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span> + <span class="number">2</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span> + <span class="number">3</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;============================&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	string modelPath = <span class="string">&quot;E:/projs/v5/yolov5/runs/train/exp15/weights/yolov5m_best.onnx&quot;</span>;</span><br><span class="line">	Yolo model;</span><br><span class="line">	string img_path = <span class="string">&quot;F:/cvTest/000.jpg&quot;</span>;</span><br><span class="line">	<span class="comment">//string img_path = &quot;./0 (6).png&quot;;</span></span><br><span class="line">	<span class="keyword">bool</span> initFlag = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">clock_t</span> start, end;<span class="comment">//检测计时</span></span><br><span class="line">	<span class="keyword">if</span> (model.<span class="built_in">readModel</span>(modelPath)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">20</span>; c++) &#123;<span class="comment">//检测20次</span></span><br><span class="line">			start = <span class="built_in">clock</span>();</span><br><span class="line">			<span class="comment">//so文件</span></span><br><span class="line">			<span class="comment">// Mat img = imread(img_path);</span></span><br><span class="line">			<span class="comment">// vector&lt;int&gt; detectResult = model.detect(img);</span></span><br><span class="line">			<span class="comment">//可执行文件</span></span><br><span class="line">			vector&lt;<span class="keyword">int</span>&gt; detectResult = model.<span class="built_in">detect</span>(img_path);</span><br><span class="line">			end = <span class="built_in">clock</span>();</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Detect time:&quot;</span> &lt;&lt; <span class="built_in"><span class="keyword">double</span></span>(end - start) / CLOCKS_PER_SEC &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="built_in">printCoordinate</span>(detectResult);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;模型初始化失败&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ubuntu报错内容为</p>
<p><img src="./image-20210723123411146.png" alt="image-20210723123411146"></p>
<p><strong>和上面使用yolov5s的报错一致，仔细看CV_32FC1和CV_32SC1</strong>，感觉在源码里见过？尝试修改源码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cv::Mat scores(1, className.size(), CV_32FC1, pdata + 5);//原始版本</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">scores</span><span class="params">(<span class="number">1</span>, className.size(), CV_32SC1, pdata + <span class="number">5</span>)</span></span>;<span class="comment">//改成这个</span></span><br></pre></td></tr></table></figure>

<p>结果还是不行，看来没这么简单</p>
<p><img src="./image-20210723123944869.png" alt="image-20210723123944869"></p>
<p>还是改回去吧，老老实实用pt转pth再转onnx</p>
<h5 id="pt2pth2onnx"><a href="#pt2pth2onnx" class="headerlink" title="pt2pth2onnx"></a>pt2pth2onnx</h5><p>两个版本的convert，耗时不一样？</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hpc203/yolov5-dnn-cpp-python">这个版本</a>耗时很长，检测出抽象图片</p>
<p><img src="./image-20210723141755679.png" alt="image-20210723141755679"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hpc203/yolov5-dnn-cpp-python-v2">这个</a>速度正常了许多，但是检测不到目标？？？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string model_path = <span class="string">&quot;F:/Downloads/chromeDownload/yolov5-dnn-cpp-python-v2-main/convert-onnx/yolov5m.onnx&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210723141854704.png" alt="image-20210723141854704"></p>
<p>挺容易漏检，ubuntu c++可以跑通，转成so放在python里对比发现，python里面平均检测时间从v5s的15ms提到了当前v5m的20ms左右，但是精确度双双拉跨。</p>
<p>因为训练数据并不多，所以就没尝试更大的v5l和v5x了。</p>
<h1 id="胡思乱想"><a href="#胡思乱想" class="headerlink" title="胡思乱想"></a>胡思乱想</h1><ul>
<li><input checked="" disabled="" type="checkbox"> 其实可以暴露一个让dnn选择指定cuda的接口(附录五)</li>
<li><input checked="" disabled="" type="checkbox"> 上镜率很高的那个博客里面评论区也提到了精度下降的问题，评论区有人提到一个libtorch，这才想起来官方给的export里面，除了可以转onnx，还可以转libtorch，以及coreml(Apple的机器学习框架)，所以下面尝试libtorch</li>
</ul>
<h1 id="libtorch"><a href="#libtorch" class="headerlink" title="libtorch"></a>libtorch</h1><blockquote>
<p>LibTorch是基于PyTorch的包含头文件，库文件和CMake编译（配置）文件的C++ API。</p>
</blockquote>
<p>ubuntu上的安装记录如下</p>
<h2 id="下载-有坑"><a href="#下载-有坑" class="headerlink" title="下载(有坑)"></a>下载(有坑)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o libtorch https://download.pytorch.org/libtorch/cu102/libtorch-shared-with-deps-1.8.1%2Bcu102.zip</span><br></pre></td></tr></table></figure>

<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/john_bh/article/details/108221748">参考文章</a></p>
<blockquote>
<p>看教程过程中发现一个python-c嵌入cmake的命令，cool</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -DCMAKE_PREFIX_PATH=`python -c <span class="string">&#x27;import torch;print(torch.utils.cmake_prefix_path)&#x27;</span>`</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> libtorch</span><br><span class="line">mkdir example</span><br><span class="line"><span class="built_in">cd</span> example</span><br></pre></td></tr></table></figure>

<p>cmakelists:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span> FATAL_ERROR)</span><br><span class="line"><span class="keyword">project</span>(example-app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(Torch REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CMAKE_CXX_FLAGS&#125; $&#123;TORCH_CXX_FLAGS&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(example-app example-app.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(example-app <span class="string">&quot;$&#123;TORCH_LIBRARIES&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">set_property</span>(<span class="keyword">TARGET</span> example-app PROPERTY CXX_STANDARD <span class="number">14</span>)</span><br></pre></td></tr></table></figure>

<p>example-app.cpp:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;torch/torch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt;<span class="string">&quot;cuda::is_available():&quot;</span> &lt;&lt; torch::cuda::<span class="built_in">is_available</span>() &lt;&lt; std::endl;</span><br><span class="line">  torch::Tensor tensor = torch::<span class="built_in">rand</span>(&#123;<span class="number">2</span>, <span class="number">3</span>&#125;);</span><br><span class="line">  std::cout &lt;&lt; tensor &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build	</span><br><span class="line"><span class="comment">#cmake -DCMAKE_PREFIX_PATH=/absolute/path/to/libtorch ..</span></span><br><span class="line">cmake -DCMAKE_PREFIX_PATH=/home/ubuntu/users/jazzy/libtorch ..</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>芜湖：CPU？？？</p>
<p><img src="./image-20210723170929884.png" alt="image-20210723170929884"></p>
<h2 id="加载模型"><a href="#加载模型" class="headerlink" title="加载模型"></a>加载模型</h2><p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/376149679">https://zhuanlan.zhihu.com/p/376149679</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/ncdhz/YoloV5-LibTorch">https://github.com/ncdhz/YoloV5-LibTorch</a></p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/yasenh/libtorch-yolov5">https://github.com/yasenh/libtorch-yolov5</a> star好多</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/SwordSing/libtorch-yolov5">https://github.com/SwordSing/libtorch-yolov5</a> 这个精简</p>
<p><img src="./image-20210723183855153.png" alt="image-20210723183855153"></p>
<h2 id="大坑"><a href="#大坑" class="headerlink" title="大坑"></a>大坑</h2><p>上面的libtorch和opencv一起用的时候编译不通过，一堆类似undefined reference to `cv::imread的问题。</p>
<p>查了很多资料，找到<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/62124555/cant-link-a-project-using-cmake-with-opencv-and-libtorch">这个</a>：</p>
<p><img src="./image-20210723223009737.png" alt="image-20210723223009737"></p>
<p>于是重新下这个libtorch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://download.pytorch.org/libtorch/cu102/libtorch-cxx11-abi-shared-with-deps-1.8.1%2Bcu102.zip</span><br></pre></td></tr></table></figure>

<p>编译通过，<a target="_blank" rel="noopener" href="https://github.com/BIGBALLON/PyTorch-CPP">这个例子</a>这次跑得很顺</p>
<p><img src="./image-20210723223911763.png" alt="image-20210723223911763"></p>
<h2 id="remake-×"><a href="#remake-×" class="headerlink" title="remake(×)"></a>remake(×)</h2><p>使用：<a target="_blank" rel="noopener" href="https://github.com/yasenh/libtorch-yolov5">https://github.com/yasenh/libtorch-yolov5</a></p>
<p>问题：imwrite出错</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./libtorch-yolov5 --weights <span class="string">&quot;../official_yolov5s.torchscript.pt&quot;</span> --source <span class="string">&quot;/home/ubuntu/users/jazzy/cvyolo/0 (6).png&quot;</span> --view-img <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724005744222.png" alt="image-20210724005744222"></p>
<p>解决：imwrite时候改成绝对路径</p>
<p><img src="./image-20210724005908718.png" alt="image-20210724005908718"></p>
<p>识别结果是这个样子，说明yolov5转torchscript成功被读入了，不过这个time有点扎心？也可能是模型本身太大导致的。</p>
<p><img src="./image-20210724005934382.png" alt="image-20210724005934382"></p>
<p>准备导入自己的试试。而且cpp里面东西太多，得精简一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 22 ms</span><br><span class="line">[W NNPACK.cpp:80] Could not initialize NNPACK! Reason: Unsupported hardware.</span><br><span class="line">inference takes : 1153 ms</span><br><span class="line">post-process takes : 5 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 744 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 925 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 10 ms</span><br><span class="line">inference takes : 771 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 7 ms</span><br><span class="line">inference takes : 832 ms</span><br><span class="line">post-process takes : 23 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 8 ms</span><br><span class="line">inference takes : 640 ms</span><br><span class="line">post-process takes : 13 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 335 ms</span><br><span class="line">post-process takes : 32 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 524 ms</span><br><span class="line">post-process takes : 14 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 492 ms</span><br><span class="line">post-process takes : 21 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 12 ms</span><br><span class="line">inference takes : 698 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 7 ms</span><br><span class="line">inference takes : 415 ms</span><br><span class="line">post-process takes : 18 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 520 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 603 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 9 ms</span><br><span class="line">inference takes : 318 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 499 ms</span><br><span class="line">post-process takes : 16 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 528 ms</span><br><span class="line">post-process takes : 18 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 331 ms</span><br><span class="line">post-process takes : 12 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 704 ms</span><br><span class="line">post-process takes : 15 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 8 ms</span><br><span class="line">inference takes : 494 ms</span><br><span class="line">post-process takes : 14 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 496 ms</span><br><span class="line">post-process takes : 26 ms</span><br><span class="line">----------Detecting----------</span><br><span class="line">pre-process takes : 6 ms</span><br><span class="line">inference takes : 696 ms</span><br><span class="line">post-process takes : 13 ms</span><br><span class="line">img saved~</span><br></pre></td></tr></table></figure>

<p>打扰了。。。上面没开cuda加速，都是CPU跑的</p>
<p><img src="./image-20210724011834389.png" alt="image-20210724011834389"></p>
<p>设置成true之后发现，，，似乎有img还存在cpu上</p>
<p><img src="./image-20210724011943591.png" alt="image-20210724011943591"></p>
<p>现在的main是这样：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;detector.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cxxopts.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;std::string&gt; <span class="title">LoadNames</span><span class="params">(<span class="keyword">const</span> std::string&amp; path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// load class names</span></span><br><span class="line">    std::vector&lt;std::string&gt; class_names;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">infile</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (infile.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">        std::string line;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span> (infile,line)) &#123;</span><br><span class="line">            class_names.<span class="built_in">emplace_back</span>(line);</span><br><span class="line">        &#125;</span><br><span class="line">        infile.<span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error loading the class names!\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> class_names;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Demo</span><span class="params">(cv::Mat&amp; img,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> std::vector&lt;std::vector&lt;Detection&gt;&gt;&amp; detections,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; class_names,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">bool</span> label = <span class="literal">true</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!detections.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; detection : detections[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">auto</span>&amp; box = detection.bbox;</span><br><span class="line">            <span class="keyword">float</span> score = detection.score;</span><br><span class="line">            <span class="keyword">int</span> class_idx = detection.class_idx;</span><br><span class="line"></span><br><span class="line">            cv::<span class="built_in">rectangle</span>(img, box, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (label) &#123;</span><br><span class="line">                std::stringstream ss;</span><br><span class="line">                ss &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; score;</span><br><span class="line">                std::string s = class_names[class_idx] + <span class="string">&quot; &quot;</span> + ss.<span class="built_in">str</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">auto</span> font_face = cv::FONT_HERSHEY_DUPLEX;</span><br><span class="line">                <span class="keyword">auto</span> font_scale = <span class="number">1.0</span>;</span><br><span class="line">                <span class="keyword">int</span> thickness = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">int</span> baseline=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">auto</span> s_size = cv::<span class="built_in">getTextSize</span>(s, font_face, font_scale, thickness, &amp;baseline);</span><br><span class="line">                cv::<span class="built_in">rectangle</span>(img,</span><br><span class="line">                        cv::<span class="built_in">Point</span>(box.<span class="built_in">tl</span>().x, box.<span class="built_in">tl</span>().y - s_size.height - <span class="number">5</span>),</span><br><span class="line">                        cv::<span class="built_in">Point</span>(box.<span class="built_in">tl</span>().x + s_size.width, box.<span class="built_in">tl</span>().y),</span><br><span class="line">                        cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">-1</span>);</span><br><span class="line">                cv::<span class="built_in">putText</span>(img, s, cv::<span class="built_in">Point</span>(box.<span class="built_in">tl</span>().x, box.<span class="built_in">tl</span>().y - <span class="number">5</span>),</span><br><span class="line">                            font_face , font_scale, cv::<span class="built_in">Scalar</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), thickness);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cv::namedWindow(&quot;Result&quot;, cv::WINDOW_AUTOSIZE);</span></span><br><span class="line">    <span class="comment">// cv::imshow(&quot;Result&quot;, img);</span></span><br><span class="line">    <span class="comment">// cv::waitKey(0);</span></span><br><span class="line">    cv::<span class="built_in">imwrite</span>(<span class="string">&quot;/home/ubuntu/users/jazzy/newlib/libtorch/libtorch-yolov5/build/Result.jpg&quot;</span>,img);</span><br><span class="line">    std::cout&lt;&lt;<span class="string">&quot;img saved~&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">cxxopts::Options <span class="title">parser</span><span class="params">(argv[<span class="number">0</span>], <span class="string">&quot;A LibTorch inference implementation of the yolov5&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> add other args</span></span><br><span class="line">    parser.<span class="built_in">allow_unrecognised_options</span>().<span class="built_in">add_options</span>()</span><br><span class="line">            (<span class="string">&quot;weights&quot;</span>, <span class="string">&quot;model.torchscript.pt path&quot;</span>, cxxopts::value&lt;std::string&gt;())</span><br><span class="line">            (<span class="string">&quot;source&quot;</span>, <span class="string">&quot;source&quot;</span>, cxxopts::value&lt;std::string&gt;())</span><br><span class="line">            (<span class="string">&quot;conf-thres&quot;</span>, <span class="string">&quot;object confidence threshold&quot;</span>, cxxopts::value&lt;<span class="keyword">float</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;0.4&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;iou-thres&quot;</span>, <span class="string">&quot;IOU threshold for NMS&quot;</span>, cxxopts::value&lt;<span class="keyword">float</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;0.5&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;gpu&quot;</span>, <span class="string">&quot;Enable cuda device or cpu&quot;</span>, cxxopts::value&lt;<span class="keyword">bool</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;true&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;view-img&quot;</span>, <span class="string">&quot;display results&quot;</span>, cxxopts::value&lt;<span class="keyword">bool</span>&gt;()-&gt;<span class="built_in">default_value</span>(<span class="string">&quot;false&quot;</span>))</span><br><span class="line">            (<span class="string">&quot;h,help&quot;</span>, <span class="string">&quot;Print usage&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> opt = parser.<span class="built_in">parse</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opt.<span class="built_in">count</span>(<span class="string">&quot;help&quot;</span>)) &#123;</span><br><span class="line">        std::cout &lt;&lt; parser.<span class="built_in">help</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if gpu flag is set</span></span><br><span class="line">    <span class="keyword">bool</span> is_gpu = opt[<span class="string">&quot;gpu&quot;</span>].as&lt;<span class="keyword">bool</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set device type - CPU/GPU</span></span><br><span class="line">    torch::DeviceType device_type;</span><br><span class="line">    <span class="keyword">if</span> (torch::cuda::<span class="built_in">is_available</span>() &amp;&amp; is_gpu) &#123;</span><br><span class="line">        device_type = torch::kCUDA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        device_type = torch::kCPU;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load class names from dataset for visualization</span></span><br><span class="line">    std::vector&lt;std::string&gt; class_names = <span class="built_in">LoadNames</span>(<span class="string">&quot;../coco.names&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (class_names.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load network</span></span><br><span class="line">    std::string weights = opt[<span class="string">&quot;weights&quot;</span>].as&lt;std::string&gt;();</span><br><span class="line">    <span class="comment">//std::string weights = &quot;../official_yolov5s.torchscript.pt&quot;;</span></span><br><span class="line">    <span class="keyword">auto</span> detector = <span class="built_in">Detector</span>(weights, device_type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load input image</span></span><br><span class="line">    std::string source = opt[<span class="string">&quot;source&quot;</span>].as&lt;std::string&gt;();</span><br><span class="line">    cv::Mat img = cv::<span class="built_in">imread</span>(source);</span><br><span class="line">    <span class="keyword">if</span> (img.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error loading the image!\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run once to warm up</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Run once on empty image&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">auto</span> temp_img = cv::Mat::<span class="built_in">zeros</span>(img.rows, img.cols, CV_32FC3);</span><br><span class="line">    detector.<span class="built_in">Run</span>(temp_img, <span class="number">1.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up threshold</span></span><br><span class="line">    <span class="keyword">float</span> conf_thres = opt[<span class="string">&quot;conf-thres&quot;</span>].as&lt;<span class="keyword">float</span>&gt;();</span><br><span class="line">    <span class="keyword">float</span> iou_thres = opt[<span class="string">&quot;iou-thres&quot;</span>].as&lt;<span class="keyword">float</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inference</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">auto</span> result = detector.<span class="built_in">Run</span>(img, conf_thres, iou_thres);</span><br><span class="line">        <span class="keyword">if</span>(i==<span class="number">19</span>)<span class="built_in">Demo</span>(img, result, class_names);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// visualize detections</span></span><br><span class="line">    <span class="comment">// if (opt[&quot;view-img&quot;].as&lt;bool&gt;()) &#123;</span></span><br><span class="line">    <span class="comment">//     Demo(img, result, class_names);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// cv::destroyAllWindows();</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>难搞，换个github项目看看</p>
<h2 id="remake2-√"><a href="#remake2-√" class="headerlink" title="remake2(√)"></a>remake2(√)</h2><p>使用：<a target="_blank" rel="noopener" href="https://github.com/ncdhz/YoloV5-LibTorch">https://github.com/ncdhz/YoloV5-LibTorch</a> </p>
<p>发现如果pt模型是CPU的模型，再libtorch里面使用cuda 的话会有下面的错误：</p>
<p><img src="./image-20210724104438802.png" alt="image-20210724104438802"></p>
<p>不用cuda的话(false)顺利运行，但是速度感人</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">YoloV5 <span class="title">yolo</span><span class="params">(<span class="string">&quot;/home/ubuntu/users/jazzy/newlib/libtorch/YoloV5-LibTorch/test/exp17best.torchscript.pt&quot;</span>,<span class="literal">false</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724104610950.png" alt="image-20210724104610950"></p>
<p><img src="./image-20210724105227731.png" alt="image-20210724105227731"></p>
<p>后来知道可能是因为使用的torchlib模型是CPU版的。下面尝试GPU的libtorch模型，成了，export 使用gpu的模型copy<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40198848/article/details/112872844">这个</a>代码，并且精简了一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&#x27;./&#x27;</span>)  <span class="comment"># to run &#x27;$ python *.py&#x27; files in subdirectories</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> models.experimental <span class="keyword">import</span> attempt_load</span><br><span class="line"><span class="keyword">from</span> utils.activations <span class="keyword">import</span> Hardswish, SiLU</span><br><span class="line"><span class="keyword">from</span> utils.general <span class="keyword">import</span> set_logging, check_img_size</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--weights&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;./runs/train/exp17/weights/best.pt&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;weights path&#x27;</span>)  <span class="comment"># from yolov5/models/</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--img-size&#x27;</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=[<span class="number">640</span>, <span class="number">640</span>], <span class="built_in">help</span>=<span class="string">&#x27;image size&#x27;</span>)  <span class="comment"># height, width</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--batch-size&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1</span>, <span class="built_in">help</span>=<span class="string">&#x27;batch size&#x27;</span>)</span><br><span class="line">    opt = parser.parse_args()</span><br><span class="line">    opt.img_size *= <span class="number">2</span> <span class="keyword">if</span> <span class="built_in">len</span>(opt.img_size) == <span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span>  <span class="comment"># expand</span></span><br><span class="line">    <span class="built_in">print</span>(opt)</span><br><span class="line">    set_logging()</span><br><span class="line">    t = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load PyTorch model</span></span><br><span class="line">    model = attempt_load(opt.weights, map_location=torch.device(<span class="string">&#x27;cuda&#x27;</span>))  <span class="comment"># load FP32 model</span></span><br><span class="line">    labels = model.names</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Checks</span></span><br><span class="line">    gs = <span class="built_in">int</span>(<span class="built_in">max</span>(model.stride))  <span class="comment"># grid size (max stride)</span></span><br><span class="line">    opt.img_size = [check_img_size(x, gs) <span class="keyword">for</span> x <span class="keyword">in</span> opt.img_size]  <span class="comment"># verify img_size are gs-multiples</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Input</span></span><br><span class="line">    img = torch.zeros(opt.batch_size, <span class="number">3</span>, *opt.img_size).to(device=<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">    <span class="comment"># image size(1,3,320,192) iDetection</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update model</span></span><br><span class="line">    <span class="keyword">for</span> k, m <span class="keyword">in</span> model.named_modules():</span><br><span class="line">        m._non_persistent_buffers_set = <span class="built_in">set</span>()  <span class="comment"># pytorch 1.6.0 compatibility</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, models.common.Conv):  <span class="comment"># assign export-friendly activations</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m.act, nn.Hardswish):</span><br><span class="line">                m.act = Hardswish()</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m.act, nn.SiLU):</span><br><span class="line">                m.act = SiLU()</span><br><span class="line">        <span class="comment"># elif isinstance(m, models.yolo.Detect):</span></span><br><span class="line">        <span class="comment">#     m.forward = m.forward_export  # assign forward (optional)</span></span><br><span class="line">    <span class="comment">#model.model[-1].export = True  # set Detect() layer export=True</span></span><br><span class="line">    model.model[-<span class="number">1</span>].export = <span class="literal">False</span></span><br><span class="line">    y = model(img)  <span class="comment"># dry run</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># TorchScript export</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nStarting TorchScript export with torch %s...&#x27;</span> % torch.__version__)</span><br><span class="line">        f = opt.weights.replace(<span class="string">&#x27;.pt&#x27;</span>, <span class="string">&#x27;.torchscript.pt&#x27;</span>)  <span class="comment"># filename</span></span><br><span class="line">        ts = torch.jit.trace(model, img)</span><br><span class="line">        ts.save(f)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;TorchScript export success, saved as %s&#x27;</span> % f)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;TorchScript export failure: %s&#x27;</span> % e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\nExport complete (%.2fs). Visualize with https://github.com/lutzroeder/netron.&#x27;</span> % (time.time() - t))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是速度依然感人（相同环境下比直接用pytorch快了一些，不清楚为什么服务器跑起来这么慢）</p>
<p><img src="./image-20210724110314909.png" alt="image-20210724110314909"></p>
<p>当前用的是yolov5s（exp17）转的torchscript模型。速度相对快了一点，看看精度怎么样。</p>
<h2 id="精度对比-libtorch-onnx-pt"><a href="#精度对比-libtorch-onnx-pt" class="headerlink" title="精度对比(libtorch/onnx/pt)"></a>精度对比(libtorch/onnx/pt)</h2><p>libtorch与onnx及pt的精度对比，用于验证libtorch是否拉跨，拉跨的话后面就不搞这个了。</p>
<h3 id="对比1"><a href="#对比1" class="headerlink" title="对比1"></a>对比1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_572.jpg</span><br><span class="line">onnx time: 1.7160511016845703 result: [278, 30, 304, 47, 130, 237, 170, 261]</span><br><span class="line">pt time: 0.11151266098022461 result: [[0, 131, 236, 170, 260]]</span><br><span class="line"></span><br><span class="line">libtorch:准确度ok，速度比pt快：平均70ms</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724160925922.png" alt="image-20210724160925922"></p>
<h3 id="对比2"><a href="#对比2" class="headerlink" title="对比2"></a>对比2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_555.jpg</span><br><span class="line">onnx time: 0.02010798454284668 result: [263, 60, 314, 272, 149, 242, 173, 309]</span><br><span class="line">pt time: 0.12859725952148438 result: []</span><br><span class="line"></span><br><span class="line">libtorch:准确度和pt一致(检测不到)，平均103ms</span><br></pre></td></tr></table></figure>

<h3 id="对比3"><a href="#对比3" class="headerlink" title="对比3"></a>对比3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_215.png</span><br><span class="line">onnx time: 0.02190113067626953 result: []</span><br><span class="line">pt time: 0.1412513256072998 result: [[0, 343, 319, 363, 327]]</span><br><span class="line"></span><br><span class="line">libtorch:平均127ms，结果和pt一致</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724162331186.png" alt="image-20210724162331186"></p>
<h3 id="对比4"><a href="#对比4" class="headerlink" title="对比4"></a>对比4</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./val/cigar_212.jpg</span><br><span class="line">onnx time: 0.017680644989013672 result: [1, 290, 117, 341, 6, 89, 62, 113, 137, 126, 190, 151, 1, 364, 80, 396]</span><br><span class="line">pt time: 0.11270976066589355 result: [[0, 0, 193, 68, 231]]</span><br><span class="line"></span><br><span class="line">libtorch:133ms!??结果ok</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210724162624894.png" alt="image-20210724162624894"></p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>精度和速度和原始的几乎没区别，下面尝试转成so在python中调用。</p>
<h2 id="libtorch-pybind11"><a href="#libtorch-pybind11" class="headerlink" title="libtorch+pybind11"></a>libtorch+pybind11</h2><blockquote>
<p>分析：</p>
<p>暴露接口：加载模型，warmup，检测</p>
<p>返回值：vector</p>
</blockquote>
<p>这个部分把几个cpp文件合在一起了，并且删除了没用到的函数。cmakelists部分卡了我很久。</p>
<h3 id="c-程序"><a href="#c-程序" class="headerlink" title="c++程序"></a>c++程序</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;torch/torch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;torch/script.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/stl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pybind11/numpy.h&gt;</span><span class="comment">//add</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> py = pybind11; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Python-&gt;C++ Mat</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_1c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;1-channel image must be 2 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC1, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cv::Mat <span class="title">numpy_uint8_3c_to_cv_mat</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">ndim</span>() != <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;3-channel image must be 3 dims &quot;</span>);</span><br><span class="line"></span><br><span class="line">    py::buffer_info buf = input.<span class="built_in">request</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">mat</span><span class="params">(buf.shape[<span class="number">0</span>], buf.shape[<span class="number">1</span>], CV_8UC3, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf.ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ImageResizeData 图片处理过后保存图片的数据结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageResizeData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 添加处理过后的图片</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setImg</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">    <span class="comment">// 获取处理过后的图片</span></span><br><span class="line">	<span class="function">cv::Mat <span class="title">getImg</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 当原始图片宽高比大于处理过后图片宽高比时此函数返回 true</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">isW</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 当原始图片高宽比大于处理过后图片高宽比时此函数返回 true</span></span><br><span class="line"><span class="comment">//	bool isH();</span></span><br><span class="line">    <span class="comment">// 添加处理之后图片的宽</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setWidth</span><span class="params">(<span class="keyword">int</span> width)</span></span>;</span><br><span class="line">    <span class="comment">// 获取处理之后图片的宽</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 添加处理之后图片的高</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setHeight</span><span class="params">(<span class="keyword">int</span> height)</span></span>;</span><br><span class="line">    <span class="comment">// 获取处理之后图片的高</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 添加原始图片的宽</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setW</span><span class="params">(<span class="keyword">int</span> w)</span></span>;</span><br><span class="line">    <span class="comment">// 获取原始图片的宽</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getW</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 添加原始图片的高</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setH</span><span class="params">(<span class="keyword">int</span> h)</span></span>;</span><br><span class="line">    <span class="comment">// 获取原始图片的高</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getH</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 添加从原始图片到处理过后图片所添加黑边大小</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setBorder</span><span class="params">(<span class="keyword">int</span> border)</span></span>;</span><br><span class="line">    <span class="comment">// 获取从原始图片到处理过后图片所添加黑边大小</span></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getBorder</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 处理过后图片高</span></span><br><span class="line">	<span class="keyword">int</span> height;</span><br><span class="line">	<span class="comment">// 处理过后图片宽</span></span><br><span class="line">    <span class="keyword">int</span> width;</span><br><span class="line">	<span class="comment">// 原始图片宽</span></span><br><span class="line">    <span class="keyword">int</span> w;</span><br><span class="line">	<span class="comment">// 原始图片高</span></span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">	<span class="comment">// 从原始图片到处理图片所添加的黑边大小</span></span><br><span class="line">    <span class="keyword">int</span> border;</span><br><span class="line">	<span class="comment">// 处理过后的图片</span></span><br><span class="line">    cv::Mat img;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YoloV5</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * @param ptFile yoloV5 pt文件路径</span></span><br><span class="line"><span class="comment">	 * @param isCuda 是否使用 cuda 默认不起用</span></span><br><span class="line"><span class="comment">	 * @param height yoloV5 训练时图片的高</span></span><br><span class="line"><span class="comment">	 * @param width yoloV5 训练时图片的宽</span></span><br><span class="line"><span class="comment">	 * @param confThres 非极大值抑制中的 scoreThresh</span></span><br><span class="line"><span class="comment">	 * @param iouThres 非极大值抑制中的 iouThresh</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">// YoloV5(std::string ptFile, bool isCuda = false, int height = 640, int width = 640,  float confThres = 0.25, float iouThres = 0.45);</span></span><br><span class="line">	<span class="comment">// YoloV5(int height = 640, int width = 640,  float confThres = 0.25, float iouThres = 0.45);</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">readModel</span><span class="params">(std::string ptFile, <span class="keyword">bool</span> isCuda = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">warmup</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 预测函数</span></span><br><span class="line"><span class="comment">	 * @param img 需要预测的图片</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">prediction</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 改变图片大小的函数</span></span><br><span class="line"><span class="comment">	 * @param img 原始图片</span></span><br><span class="line"><span class="comment">	 * @param height 要处理成的图片的高</span></span><br><span class="line"><span class="comment">	 * @param width 要处理成的图片的宽</span></span><br><span class="line"><span class="comment">	 * @return 封装好的处理过后图片数据结构</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">predict</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> ImageResizeData <span class="title">resize</span><span class="params">(cv::Mat img, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 改变图片大小的函数</span></span><br><span class="line"><span class="comment">	 * @param img 原始图片</span></span><br><span class="line"><span class="comment">	 * @return 封装好的处理过后图片数据结构</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">ImageResizeData <span class="title">resize</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 改变图片大小的函数</span></span><br><span class="line"><span class="comment">	 * @param imgs 原始图片集合</span></span><br><span class="line"><span class="comment">	 * @param height 要处理成的图片的高</span></span><br><span class="line"><span class="comment">	 * @param width 要处理成的图片的宽</span></span><br><span class="line"><span class="comment">	 * @return 封装好的处理过后图片数据结构</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> std::vector&lt;ImageResizeData&gt; <span class="title">resize</span><span class="params">(std::vector &lt;cv::Mat&gt; imgs, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 改变图片大小的函数</span></span><br><span class="line"><span class="comment">	 * @param imgs 原始图片集合</span></span><br><span class="line"><span class="comment">	 * @return 封装好的处理过后图片数据结构</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">std::vector&lt;ImageResizeData&gt; <span class="title">resize</span><span class="params">(std::vector &lt;cv::Mat&gt; imgs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	bool existencePrediction(torch::Tensor clazz);</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用于判断给定数据是否存在预测</span></span><br><span class="line"><span class="comment">	 * @param classs 通过预测函数处理好的结果</span></span><br><span class="line"><span class="comment">	 * @return 如果图片集合中存在给定某一种分类返回 true</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="comment">//	bool existencePrediction(std::vector&lt;torch::Tensor&gt; classs);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// 是否启用 cuda</span></span><br><span class="line">	<span class="keyword">bool</span> isCuda;</span><br><span class="line">	<span class="comment">// 非极大值抑制中的第一步数据清理</span></span><br><span class="line">	<span class="keyword">float</span> confThres;</span><br><span class="line">	<span class="comment">// 非极大值抑制中 iou</span></span><br><span class="line">	<span class="keyword">float</span> iouThres;</span><br><span class="line">	<span class="comment">// 模型所需要的图片的高</span></span><br><span class="line">	<span class="keyword">float</span> height;</span><br><span class="line">	<span class="comment">// 模型所需要的图片的宽</span></span><br><span class="line">	<span class="keyword">float</span> width;</span><br><span class="line">	<span class="comment">// 画框颜色 map</span></span><br><span class="line">	std::map&lt;<span class="keyword">int</span>, cv::Scalar&gt; mainColors;</span><br><span class="line">	<span class="comment">// 模型</span></span><br><span class="line">	torch::jit::script::Module model;</span><br><span class="line">	<span class="comment">// 随机获取一种颜色</span></span><br><span class="line"><span class="comment">//	cv::Scalar getRandScalar();</span></span><br><span class="line">	<span class="comment">// 图片通道转换为 rgb</span></span><br><span class="line">	<span class="function">cv::Mat <span class="title">img2RGB</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">// 图片变为 Tensor</span></span><br><span class="line">	<span class="function">torch::Tensor <span class="title">img2Tensor</span><span class="params">(cv::Mat img)</span></span>;</span><br><span class="line">	<span class="comment">// (center_x center_y w h) to (left, top, right, bottom)</span></span><br><span class="line">	<span class="function">torch::Tensor <span class="title">xywh2xyxy</span><span class="params">(torch::Tensor x)</span></span>;</span><br><span class="line">	<span class="comment">// 非极大值抑制算法</span></span><br><span class="line">	<span class="function">torch::Tensor <span class="title">nms</span><span class="params">(torch::Tensor bboxes, torch::Tensor scores, <span class="keyword">float</span> thresh)</span></span>;</span><br><span class="line">	<span class="comment">// 预测出来的框根据原始图片还原算法</span></span><br><span class="line">	<span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">sizeOriginal</span><span class="params">(std::vector&lt;torch::Tensor&gt; result, std::vector&lt;ImageResizeData&gt; imgRDs)</span></span>;</span><br><span class="line">	<span class="comment">// 非极大值抑制算法整体</span></span><br><span class="line">	<span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">non_max_suppression</span><span class="params">(torch::Tensor preds, <span class="keyword">float</span> confThres = <span class="number">0.25</span>, <span class="keyword">float</span> iouThres = <span class="number">0.45</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// YoloV5::YoloV5(int height, int width, float confThres, float iouThres)</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 	this-&gt;height = height;</span></span><br><span class="line"><span class="comment">// 	this-&gt;width = width;</span></span><br><span class="line"><span class="comment">// 	this-&gt;isCuda = isCuda;</span></span><br><span class="line"><span class="comment">// 	this-&gt;iouThres = iouThres;</span></span><br><span class="line"><span class="comment">// 	this-&gt;confThres = confThres;</span></span><br><span class="line"><span class="comment">// 	model.eval();</span></span><br><span class="line"><span class="comment">// 	unsigned seed = time(0);</span></span><br><span class="line"><span class="comment">// 	std::srand(seed);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YoloV5::readModel</span><span class="params">(std::string ptFile, <span class="keyword">bool</span> isCuda)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;height = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;width = <span class="number">640</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;isCuda = isCuda;</span><br><span class="line">	<span class="keyword">this</span>-&gt;iouThres = <span class="number">0.45</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;confThres = <span class="number">0.25</span>;</span><br><span class="line">	model = torch::jit::<span class="built_in">load</span>(ptFile);</span><br><span class="line">	<span class="keyword">if</span> (isCuda) &#123;</span><br><span class="line">		model.<span class="built_in">to</span>(torch::kCUDA);</span><br><span class="line">	&#125;</span><br><span class="line">	model.<span class="built_in">eval</span>();</span><br><span class="line">	<span class="keyword">unsigned</span> seed = <span class="built_in">time</span>(<span class="number">0</span>);</span><br><span class="line">	std::<span class="built_in">srand</span>(seed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">YoloV5::non_max_suppression</span><span class="params">(torch::Tensor prediction, <span class="keyword">float</span> confThres, <span class="keyword">float</span> iouThres)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	torch::Tensor xc = prediction.<span class="built_in">select</span>(<span class="number">2</span>, <span class="number">4</span>) &gt; confThres;</span><br><span class="line">	<span class="keyword">int</span> maxWh = <span class="number">4096</span>;</span><br><span class="line">	<span class="keyword">int</span> maxNms = <span class="number">30000</span>;</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; output;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prediction.<span class="built_in">size</span>(<span class="number">0</span>); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		output.<span class="built_in">push_back</span>(torch::<span class="built_in">zeros</span>(&#123; <span class="number">0</span>, <span class="number">6</span> &#125;));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prediction.<span class="built_in">size</span>(<span class="number">0</span>); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		torch::Tensor x = prediction[i];</span><br><span class="line">		x = x.<span class="built_in">index_select</span>(<span class="number">0</span>, torch::<span class="built_in">nonzero</span>(xc[i]).<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">		<span class="keyword">if</span> (x.<span class="built_in">size</span>(<span class="number">0</span>) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">5</span>, x.<span class="built_in">size</span>(<span class="number">1</span>)).<span class="built_in">mul_</span>(x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">		torch::Tensor box = <span class="built_in">xywh2xyxy</span>(x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">		std::tuple&lt;torch::Tensor, torch::Tensor&gt; max_tuple = torch::<span class="built_in">max</span>(x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">5</span>, x.<span class="built_in">size</span>(<span class="number">1</span>)), <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">		x = torch::<span class="built_in">cat</span>(&#123; box, std::get&lt;<span class="number">0</span>&gt;(max_tuple), std::get&lt;<span class="number">1</span>&gt;(max_tuple) &#125;, <span class="number">1</span>);</span><br><span class="line">		x = x.<span class="built_in">index_select</span>(<span class="number">0</span>, torch::<span class="built_in">nonzero</span>(std::get&lt;<span class="number">0</span>&gt;(max_tuple) &gt; confThres).<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">		<span class="keyword">int</span> n = x.<span class="built_in">size</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (n == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (n &gt; maxNms)</span><br><span class="line">		&#123;</span><br><span class="line">			x = x.<span class="built_in">index_select</span>(<span class="number">0</span>, x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">4</span>).<span class="built_in">argsort</span>(<span class="number">0</span>, <span class="literal">true</span>).<span class="built_in">slice</span>(<span class="number">0</span>, <span class="number">0</span>, maxNms));</span><br><span class="line">		&#125;</span><br><span class="line">		torch::Tensor c = x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>) * maxWh;</span><br><span class="line">		torch::Tensor boxes = x.<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>) + c, scores = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">		torch::Tensor ix = <span class="built_in">nms</span>(boxes, scores, iouThres).<span class="built_in">to</span>(x.<span class="built_in">device</span>());</span><br><span class="line">		output[i] = x.<span class="built_in">index_select</span>(<span class="number">0</span>, ix).<span class="built_in">cpu</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cv::Mat <span class="title">YoloV5::img2RGB</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> imgC = img.<span class="built_in">channels</span>();</span><br><span class="line">	<span class="keyword">if</span> (imgC == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(img, img, cv::COLOR_GRAY2RGB);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cv::<span class="built_in">cvtColor</span>(img, img, cv::COLOR_BGR2RGB);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">torch::Tensor <span class="title">YoloV5::img2Tensor</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	torch::Tensor data = torch::<span class="built_in">from_blob</span>(img.data, &#123;(<span class="keyword">int</span>)height, (<span class="keyword">int</span>)width, <span class="number">3</span> &#125;, torch::kByte);</span><br><span class="line">	data = data.<span class="built_in">permute</span>(&#123; <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span> &#125;);</span><br><span class="line">	data = data.<span class="built_in">toType</span>(torch::kFloat);</span><br><span class="line">	data = data.<span class="built_in">div</span>(<span class="number">255</span>);</span><br><span class="line">	data = data.<span class="built_in">unsqueeze</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">torch::Tensor <span class="title">YoloV5::xywh2xyxy</span><span class="params">(torch::Tensor x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	torch::Tensor y = x.<span class="built_in">clone</span>();</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>) - x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>) - x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>) + x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">	y.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>) = x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>) + x.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">torch::Tensor <span class="title">YoloV5::nms</span><span class="params">(torch::Tensor bboxes, torch::Tensor scores, <span class="keyword">float</span> thresh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> x1 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">auto</span> y1 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">auto</span> x2 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">auto</span> y2 = bboxes.<span class="built_in">select</span>(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">auto</span> areas = (x2 - x1) * (y2 - y1);</span><br><span class="line">	<span class="keyword">auto</span> tuple_sorted = scores.<span class="built_in">sort</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">auto</span> order = std::get&lt;<span class="number">1</span>&gt;(tuple_sorted);</span><br><span class="line"></span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; keep;</span><br><span class="line">	<span class="keyword">while</span> (order.<span class="built_in">numel</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (order.<span class="built_in">numel</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">auto</span> i = order.<span class="built_in">item</span>();</span><br><span class="line">			keep.<span class="built_in">push_back</span>(i.<span class="built_in">toInt</span>());</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">auto</span> i = order[<span class="number">0</span>].<span class="built_in">item</span>();</span><br><span class="line">			keep.<span class="built_in">push_back</span>(i.<span class="built_in">toInt</span>());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">auto</span> order_mask = order.<span class="built_in">narrow</span>(<span class="number">0</span>, <span class="number">1</span>, order.<span class="built_in">size</span>(<span class="number">-1</span>) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">auto</span> xx1 = x1.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(x1[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>(), <span class="number">1e10</span>);</span><br><span class="line">		<span class="keyword">auto</span> yy1 = y1.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(y1[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>(), <span class="number">1e10</span>);</span><br><span class="line">		<span class="keyword">auto</span> xx2 = x2.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(<span class="number">0</span>, x2[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>());</span><br><span class="line">		<span class="keyword">auto</span> yy2 = y2.<span class="built_in">index</span>(&#123; order_mask &#125;).<span class="built_in">clamp</span>(<span class="number">0</span>, y2[keep.<span class="built_in">back</span>()].<span class="built_in">item</span>().<span class="built_in">toFloat</span>());</span><br><span class="line">		<span class="keyword">auto</span> inter = (xx2 - xx1).<span class="built_in">clamp</span>(<span class="number">0</span>, <span class="number">1e10</span>) * (yy2 - yy1).<span class="built_in">clamp</span>(<span class="number">0</span>, <span class="number">1e10</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">auto</span> iou = inter / (areas[keep.<span class="built_in">back</span>()] + areas.<span class="built_in">index</span>(&#123; order.<span class="built_in">narrow</span>(<span class="number">0</span>,<span class="number">1</span>,order.<span class="built_in">size</span>(<span class="number">-1</span>) - <span class="number">1</span>) &#125;) - inter);</span><br><span class="line">		<span class="keyword">auto</span> idx = (iou &lt;= thresh).<span class="built_in">nonzero</span>().<span class="built_in">squeeze</span>();</span><br><span class="line">		<span class="keyword">if</span> (idx.<span class="built_in">numel</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		order = order.<span class="built_in">index</span>(&#123; idx + <span class="number">1</span> &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> torch::<span class="built_in">tensor</span>(keep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;torch::Tensor&gt; <span class="title">YoloV5::sizeOriginal</span><span class="params">(std::vector&lt;torch::Tensor&gt; result, std::vector&lt;ImageResizeData&gt; imgRDs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; resultOrg;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; result.<span class="built_in">size</span>(); i++)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		torch::Tensor data = result[i];</span><br><span class="line">		ImageResizeData imgRD = imgRDs[i];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; data.<span class="built_in">size</span>(<span class="number">0</span>); j++)</span><br><span class="line">		&#123;</span><br><span class="line">			torch::Tensor tensor = data.<span class="built_in">select</span>(<span class="number">0</span>, j);</span><br><span class="line">			<span class="comment">// (left, top, right, bottom)</span></span><br><span class="line">			<span class="keyword">if</span> (imgRD.<span class="built_in">isW</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				tensor[<span class="number">1</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">3</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">0</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getWidth</span>();</span><br><span class="line">				tensor[<span class="number">2</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getWidth</span>();</span><br><span class="line">				tensor[<span class="number">1</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getHeight</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">				tensor[<span class="number">3</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getHeight</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tensor[<span class="number">0</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">2</span>] -= imgRD.<span class="built_in">getBorder</span>();</span><br><span class="line">				tensor[<span class="number">1</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getHeight</span>();</span><br><span class="line">				tensor[<span class="number">3</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getH</span>() / (<span class="keyword">float</span>)imgRD.<span class="built_in">getHeight</span>();</span><br><span class="line">				tensor[<span class="number">0</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getWidth</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">				tensor[<span class="number">2</span>] *= (<span class="keyword">float</span>)imgRD.<span class="built_in">getW</span>() / (<span class="keyword">float</span>)(imgRD.<span class="built_in">getWidth</span>() - <span class="number">2</span> * imgRD.<span class="built_in">getBorder</span>());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		resultOrg.<span class="built_in">push_back</span>(data);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resultOrg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YoloV5::warmup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    torch::Tensor data = torch::<span class="built_in">rand</span>(&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>&#125;);</span><br><span class="line">	<span class="keyword">if</span> (!data.<span class="built_in">is_cuda</span>() &amp;&amp; <span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cuda</span>();</span><br><span class="line">	<span class="keyword">if</span> (data.<span class="built_in">is_cuda</span>() &amp;&amp; !<span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cpu</span>();</span><br><span class="line">	torch::Tensor pred = model.forward(&#123; data &#125;).<span class="built_in">toTuple</span>()-&gt;<span class="built_in">elements</span>()[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; res =  <span class="built_in">non_max_suppression</span>(pred, confThres, iouThres);</span><br><span class="line">	pred = model.forward(&#123; data &#125;).<span class="built_in">toTuple</span>()-&gt;<span class="built_in">elements</span>()[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">	res =  <span class="built_in">non_max_suppression</span>(pred, confThres, iouThres);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">YoloV5::predict</span><span class="params">(py::<span class="keyword">array_t</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;&amp; input)</span></span>&#123;</span><br><span class="line">	cv::Mat img = <span class="built_in">numpy_uint8_3c_to_cv_mat</span>(input);</span><br><span class="line">    std::vector&lt;torch::Tensor&gt; r;</span><br><span class="line">    ImageResizeData imgRD = <span class="built_in">resize</span>(img);</span><br><span class="line">	cv::Mat reImg = <span class="built_in">img2RGB</span>(imgRD.<span class="built_in">getImg</span>());</span><br><span class="line">	torch::Tensor data = <span class="built_in">img2Tensor</span>(reImg);</span><br><span class="line">	<span class="keyword">if</span> (!data.<span class="built_in">is_cuda</span>() &amp;&amp; <span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cuda</span>();</span><br><span class="line">	<span class="keyword">if</span> (data.<span class="built_in">is_cuda</span>() &amp;&amp; !<span class="keyword">this</span>-&gt;isCuda)data = data.<span class="built_in">cpu</span>();</span><br><span class="line">	torch::Tensor pred = model.forward(&#123; data &#125;).<span class="built_in">toTuple</span>()-&gt;<span class="built_in">elements</span>()[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">	std::vector&lt;torch::Tensor&gt; result = <span class="built_in">non_max_suppression</span>(pred, confThres, iouThres);</span><br><span class="line">	std::vector&lt;ImageResizeData&gt; imgRDs;</span><br><span class="line">	imgRDs.<span class="built_in">push_back</span>(imgRD);</span><br><span class="line">	r =  <span class="built_in">sizeOriginal</span>(result, imgRDs);</span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt; detectResult;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; r[<span class="number">0</span>].<span class="built_in">size</span>(<span class="number">0</span>); i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> clazz = r[<span class="number">0</span>][i][<span class="number">5</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">if</span>(clazz)<span class="keyword">continue</span>;<span class="comment">//过滤seatbelt</span></span><br><span class="line">        <span class="keyword">int</span> x = r[<span class="number">0</span>][i][<span class="number">0</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">int</span> y = r[<span class="number">0</span>][i][<span class="number">1</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">int</span> w = r[<span class="number">0</span>][i][<span class="number">2</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="keyword">int</span> h = r[<span class="number">0</span>][i][<span class="number">3</span>].<span class="built_in">item</span>().<span class="built_in">toInt</span>();</span><br><span class="line">        <span class="comment">// detectResult.push_back(clazz);</span></span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(x);</span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(y);</span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(w);</span><br><span class="line">        detectResult.<span class="built_in">push_back</span>(h);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> detectResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ImageResizeData <span class="title">YoloV5::resize</span><span class="params">(cv::Mat img, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ImageResizeData imgResizeData;</span><br><span class="line">	<span class="keyword">int</span> w = img.cols, h = img.rows;</span><br><span class="line">	imgResizeData.<span class="built_in">setH</span>(h);</span><br><span class="line">	imgResizeData.<span class="built_in">setW</span>(w);</span><br><span class="line">	imgResizeData.<span class="built_in">setHeight</span>(height);</span><br><span class="line">	imgResizeData.<span class="built_in">setWidth</span>(width);</span><br><span class="line">	<span class="keyword">bool</span> isW = (<span class="keyword">float</span>)w / (<span class="keyword">float</span>)h &gt; (<span class="keyword">float</span>)width / (<span class="keyword">float</span>)height;</span><br><span class="line"></span><br><span class="line">	cv::<span class="built_in">resize</span>(img, img, cv::<span class="built_in">Size</span>(</span><br><span class="line">		isW ? width : (<span class="keyword">int</span>)((<span class="keyword">float</span>)height / (<span class="keyword">float</span>)h * w),</span><br><span class="line">		isW ? (<span class="keyword">int</span>)((<span class="keyword">float</span>)width / (<span class="keyword">float</span>)w * h) : height));</span><br><span class="line"></span><br><span class="line">	w = img.cols, h = img.rows;</span><br><span class="line">	<span class="keyword">if</span> (isW)</span><br><span class="line">	&#123;</span><br><span class="line">		imgResizeData.<span class="built_in">setBorder</span>((height - h) / <span class="number">2</span>);</span><br><span class="line">		cv::<span class="built_in">copyMakeBorder</span>(img, img, (height - h) / <span class="number">2</span>, height - h - (height - h) / <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, cv::BORDER_CONSTANT);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		imgResizeData.<span class="built_in">setBorder</span>((width - w) / <span class="number">2</span>);</span><br><span class="line">		cv::<span class="built_in">copyMakeBorder</span>(img, img, <span class="number">0</span>, <span class="number">0</span>, (width - w) / <span class="number">2</span>, width - w - (width - w) / <span class="number">2</span>, cv::BORDER_CONSTANT);</span><br><span class="line">	&#125;</span><br><span class="line">	imgResizeData.<span class="built_in">setImg</span>(img);</span><br><span class="line">	<span class="keyword">return</span> imgResizeData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ImageResizeData <span class="title">YoloV5::resize</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> YoloV5::<span class="built_in">resize</span>(img, height, width);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;ImageResizeData&gt; <span class="title">YoloV5::resize</span><span class="params">(std::vector&lt;cv::Mat&gt; imgs, <span class="keyword">int</span> height, <span class="keyword">int</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;ImageResizeData&gt; imgRDs;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; imgs.<span class="built_in">size</span>();i++)</span><br><span class="line">	&#123;</span><br><span class="line">		imgRDs.<span class="built_in">push_back</span>(YoloV5::<span class="built_in">resize</span>(imgs[i], height, width));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> imgRDs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;ImageResizeData&gt; <span class="title">YoloV5::resize</span><span class="params">(std::vector&lt;cv::Mat&gt; imgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> YoloV5::<span class="built_in">resize</span>(imgs, height, width);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setImg</span><span class="params">(cv::Mat img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;img = img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cv::Mat <span class="title">ImageResizeData::getImg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ImageResizeData::isW</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">float</span>)w / (<span class="keyword">float</span>)h &gt; (<span class="keyword">float</span>)width / (<span class="keyword">float</span>)height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setWidth</span><span class="params">(<span class="keyword">int</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;width = width;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getWidth</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> width;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setHeight</span><span class="params">(<span class="keyword">int</span> height)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;height = height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getHeight</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setW</span><span class="params">(<span class="keyword">int</span> w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;w = w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getW</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setH</span><span class="params">(<span class="keyword">int</span> h)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;h = h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getH</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageResizeData::setBorder</span><span class="params">(<span class="keyword">int</span> border)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;border = border;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ImageResizeData::getBorder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> border;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printCoordinate</span><span class="params">(std::vector&lt;<span class="keyword">int</span>&gt; &amp;detectResult)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; detectResult.<span class="built_in">size</span>()/<span class="number">4</span>; i++) &#123;</span><br><span class="line">                std::cout &lt;&lt; detectResult[i*<span class="number">4</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span>+<span class="number">1</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span>+<span class="number">2</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; detectResult[i * <span class="number">4</span>+<span class="number">3</span>] &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;============================&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// int main()</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">// 	YoloV5 yolo(&quot;/home/ubuntu/users/jazzy/newlib/libtorch/YoloV5-LibTorch/exp17best.torchscript_gpu.pt&quot;,true);</span></span><br><span class="line"><span class="comment">// 	yolo.warmup();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 	clock_t start, end;//检测计时</span></span><br><span class="line"><span class="comment">// 	cv::Mat frame;</span></span><br><span class="line"><span class="comment">//     std::vector&lt;int&gt; result;</span></span><br><span class="line"><span class="comment">// 	double sumtime = 0;</span></span><br><span class="line"><span class="comment">// 	for (int c = 0; c &lt; 20; c++) &#123;//检测20次</span></span><br><span class="line"><span class="comment">// 		start = clock();</span></span><br><span class="line"><span class="comment">// 		std::string imgPath = &quot;/home/ubuntu/users/jazzy/v5/dataset/images/val/cigar_212.jpg&quot;;</span></span><br><span class="line"><span class="comment">// 		frame = cv::imread(imgPath);</span></span><br><span class="line"><span class="comment">// 		result = yolo.predict(frame);</span></span><br><span class="line"><span class="comment">// 		end = clock();</span></span><br><span class="line"><span class="comment">// 		sumtime+=double(end - start) / CLOCKS_PER_SEC;</span></span><br><span class="line"><span class="comment">// 		printCoordinate(result);</span></span><br><span class="line"><span class="comment">// 		std::cout &lt;&lt; &quot;Detect time:&quot; &lt;&lt; double(end - start) / CLOCKS_PER_SEC &lt;&lt; &quot;s&quot; &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	std::cout&lt;&lt;&quot;average time:&quot;&lt;&lt;sumtime/20&lt;&lt;std::endl;</span></span><br><span class="line"><span class="comment">// 	return 0;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(libtorchpredict, m) &#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;yolov5s libtorch and pybind11&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    py::class_&lt;YoloV5&gt;(m, <span class="string">&quot;YoloV5&quot;</span>)</span><br><span class="line">    .<span class="built_in">def</span>(py::<span class="built_in">init</span>())</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;readModel&quot;</span>, &amp;YoloV5::readModel, py::return_value_policy::copy)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;warmup&quot;</span>, &amp;YoloV5::warmup)</span><br><span class="line">    .<span class="built_in">def</span>(<span class="string">&quot;predict&quot;</span>, &amp;YoloV5::predict, py::return_value_policy::copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="cmakelists"><a href="#cmakelists" class="headerlink" title="cmakelists"></a>cmakelists</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.10)</span><br><span class="line">project(YoloV5LibTorch)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 14)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line"><span class="built_in">set</span>(Torch_DIR /home/ubuntu/users/jazzy/newlib/libtorch/share/cmake/Torch)</span><br><span class="line">find_package(Torch PATHS <span class="variable">$&#123;Torch_DIR&#125;</span> NO_DEFAULT REQUIRED)</span><br><span class="line">add_subdirectory(pybind11)</span><br><span class="line"></span><br><span class="line">include_directories( <span class="variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span> )</span><br><span class="line">INCLUDE_DIRECTORIES(</span><br><span class="line">  <span class="variable">$&#123;pybind11_INCLUDE_DIRS&#125;</span></span><br><span class="line">  ./</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_library(torchpredict MODULE </span><br><span class="line">            predict.cpp</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">target_link_libraries(torchpredict </span><br><span class="line">            pybind11::module</span><br><span class="line">  )</span><br><span class="line">target_link_libraries(torchpredict <span class="variable">$&#123;OpenCV_LIBS&#125;</span> )</span><br><span class="line">target_link_libraries(torchpredict <span class="variable">$&#123;TORCH_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="python调用"><a href="#python调用" class="headerlink" title="python调用"></a>python调用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> libtorchpredict</span><br><span class="line">yolo = libtorchpredict.YoloV5()</span><br><span class="line">yolo.readModel(<span class="string">&quot;path/to/pt&quot;</span>,<span class="literal">True</span>)</span><br><span class="line">yolo.warmup()<span class="comment">#空跑两次</span></span><br><span class="line">img = cv2.imread(<span class="string">&quot;path/to/image&quot;</span>)</span><br><span class="line">sumTime = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    start = time.time()</span><br><span class="line">    res = yolo.predict(img)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="built_in">print</span>(end-start)</span><br><span class="line">    sumTime+=(end-start)</span><br><span class="line"><span class="built_in">print</span>(sumTime/<span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<hr/>

<blockquote>
<p>注意点：<br>在使用过程中, 有三个地方的变量命名需要一致,分别是上述代码中的: PYBIND11_MODULE接口函数中的map_interface, CMakeList中的add_library中的map_interface, python代码中的 import map_interface. 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、PYBIND11_MODULE(map_interface, m)</span><br><span class="line">2、add_library(map_interface MODULE … )</span><br><span class="line">3、import map_interface <span class="comment"># c++接口</span></span><br></pre></td></tr></table></figure>

<p> linux 系统在使用 CMake 编译 c++ 动态链接库的时候, 会加一个前缀lib, 生成libmap_interface.so, 因此,这三个地方的命名应该修改如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、PYBIND11_MODULE(libmap_interface, m)</span><br><span class="line">2、add_library(map_interface MODULE … )</span><br><span class="line">3、import libmap_interface <span class="comment"># c++接</span></span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
V100上面只要16ms，汇总一下当前最新的速度对比表格(libtorch在第五行、第六行)，其中的warmup是指使用随机生成的tensor让网络推理，这个表格可以发现无论是onnx还是libtorch，只要使用了cuda，就需要warmup。

<h3 id="速度对比-1"><a href="#速度对比-1" class="headerlink" title="速度对比"></a>速度对比</h3><table>
<thead>
<tr>
<th align="center">语言</th>
<th align="center">框架</th>
<th align="center">模型</th>
<th align="center">时间</th>
<th align="center">备注</th>
<th>显存占用</th>
<th align="center">位置</th>
</tr>
</thead>
<tbody><tr>
<td align="center">C++</td>
<td align="center">opencv 4.4.0</td>
<td align="center">onnx</td>
<td align="center">后19次平均32.3ms</td>
<td align="center">第一次需要2s多</td>
<td>1130MB</td>
<td align="center">~/cvyolo_cpp/predict.cpp</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">opencv 4.4.0+<strong>so</strong></td>
<td align="center">onnx</td>
<td align="center">后19次平均<strong>14.9ms</strong></td>
<td align="center">第一次需要3s多</td>
<td>1260MB</td>
<td align="center">~/cvyolo/pytest.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">pytorch 1.8.1</td>
<td align="center">pt</td>
<td align="center">169ms</td>
<td align="center">方差小，但是比我1650还慢</td>
<td>1415MB</td>
<td align="center">~/v5/yolov5/predict.py</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">python-opencv</td>
<td align="center">onnx</td>
<td align="center">689ms</td>
<td align="center">方差小</td>
<td>Pass(CPU)</td>
<td align="center">~/cvyolo/opencvYOLO.py</td>
</tr>
<tr>
<td align="center">C++</td>
<td align="center">opencv 4.4.0+libtorch</td>
<td align="center">torchscript</td>
<td align="center">134ms</td>
<td align="center">warmup*2</td>
<td>1413MB</td>
<td align="center">~/newlib/libtorch/YoloV5-LibTorch_cpp/build</td>
</tr>
<tr>
<td align="center">python</td>
<td align="center">python-opencv +libtorch+<strong>so</strong></td>
<td align="center">torchscript</td>
<td align="center">16.2ms</td>
<td align="center">warmup*2</td>
<td>1413MB</td>
<td align="center">~/newlib/libtorch/YoloV5-LibTorch_py/build</td>
</tr>
</tbody></table>
<h3 id="精度对比"><a href="#精度对比" class="headerlink" title="精度对比"></a>精度对比</h3><p>精度这部分依然使用所有val数据进行测试</p>
<p>问题：同时导入libtorchpredict.so和pytorch的时候会报错，可是我libtorch的版本和torch的版本分明是匹配的。</p>
<p>不管了，先用pt对比onnx(上次对比过)，占用显存2200MB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python speedCompare_ptVSonnx.py &gt; ptVSonnx.txt </span><br></pre></td></tr></table></figure>

<p>然后略微修改speedtest.py再用onnx对比libtorch，占用显存2206MB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python speedCompare_onnxVSlibtorch.py &gt; onnxVSlibtorch.txt </span><br></pre></td></tr></table></figure>

<p>最后再对比一下ptVSonnx和onnxVSlibtorch两个文件，结论是libtorch只有极少数会比原始pt模型漏检。</p>
<p>感谢libtorch，让我能睡好觉</p>
<hr>

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="ubuntu-opencv-cuda编译"><a href="#ubuntu-opencv-cuda编译" class="headerlink" title="ubuntu opencv+cuda编译"></a>ubuntu opencv+cuda编译</h2><p>用自己的账号make，用ubuntu账号sudo make install</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> opencv-4.4.0</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span><br><span class="line">    -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib-4.4.0/modules .. \</span><br><span class="line">    -DWITH_CUDA=1 \</span><br><span class="line">    -DENABLE_FAST_MATH=1 \</span><br><span class="line">    -DCUDA_FAST_MATH=1 \</span><br><span class="line">    -DWITH_CUBLAS=1 \</span><br><span class="line">    -DOPENCV_GENERATE_PKGCONFIG=1 \</span><br><span class="line">    -DCUDA_GENERATION=Pascal ..</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34717531/article/details/107763872">https://blog.csdn.net/qq_34717531/article/details/107763872</a></p>
<p>可以打印信息，但是没法用CUDA(神似我在windows下选错算力的情况),架构似乎也写错了？</p>
<p><img src="./image-20210722134417691.png" alt="image-20210722134417691"></p>
<p><img src="./image-20210722134426908.png" alt="image-20210722134426908"></p>
<p>接下来重新编译</p>
<p><img src="./image-20210722135316031.png" alt="image-20210722135316031"></p>
<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34717531/article/details/108735629">这篇</a>，修改了架构，重新修改了算力，重新编译，ok</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> opencv-4.4.0</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span><br><span class="line">    -DOPENCV_EXTRA_MODULES_PATH=../opencv_contrib-4.4.0/modules .. \</span><br><span class="line">    -DWITH_CUDA=1 \</span><br><span class="line">    -DCUDA_ARCH_BIN=7.0 \</span><br><span class="line">    -DENABLE_FAST_MATH=1 \</span><br><span class="line">    -DCUDA_FAST_MATH=1 \</span><br><span class="line">    -DWITH_CUBLAS=1 \</span><br><span class="line">    -DOPENCV_GENERATE_PKGCONFIG=1 \</span><br><span class="line">    -DCUDA_GENERATION=Volta ..</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><img src="./image-20210722134617694.png" alt="image-20210722134617694"></p>
<h2 id="windows上的pybind11尝试"><a href="#windows上的pybind11尝试" class="headerlink" title="windows上的pybind11尝试"></a>windows上的pybind11尝试</h2><p>一次失败的尝试，但是CMake命令行编译64位程序要学会如何操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -G &quot;Visual Studio 15 2017 Win64&quot; ..</span><br></pre></td></tr></table></figure>

<h2 id="ubuntu上的pybind11安装"><a href="#ubuntu上的pybind11安装" class="headerlink" title="ubuntu上的pybind11安装"></a>ubuntu上的pybind11安装</h2><ul>
<li>make时候有error-不影响</li>
<li>install时候要sudo-不用install</li>
</ul>
<h2 id="windows安装libtorch"><a href="#windows安装libtorch" class="headerlink" title="windows安装libtorch"></a>windows安装libtorch</h2><p>下载：<a target="_blank" rel="noopener" href="https://download.pytorch.org/libtorch/cu102/libtorch-win-shared-with-deps-1.8.1%2Bcu102.zip">torch1.8.1+cu102下载</a></p>
<p>配置：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jiejiaodebeiying/article/details/117186165">https://blog.csdn.net/jiejiaodebeiying/article/details/117186165</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xixixing/p/12842066.html">https://www.cnblogs.com/xixixing/p/12842066.html</a></li>
</ul>
<p>报错解决：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44816589/article/details/117068262">https://blog.csdn.net/weixin_44816589/article/details/117068262</a></p>
</li>
<li><p>另外加载模型时候报C10:Error，网上找资料几乎都说是导出torchscript的torch版本与libtorch安装版本不一致导致的，反复尝试，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43950348/article/details/115697900">这篇</a>解决:</p>
<blockquote>
<p>项目右键-&gt;属性-&gt;链接器-&gt;命令行-&gt;其他选项输入-&gt;/INCLUDE:?warp_size@cuda@at@@YAHXZ</p>
</blockquote>
</li>
</ul>
<p>检测速度:</p>
<p>warmup”空跑“两次之后，似乎还没准备好：</p>
<p><img src="./image-20210725181836340.png" alt="image-20210725181836340"></p>
<p>于是又多”空跑”两次，在本机的平均检测时间是26ms，而本机直接使用pytorch进行推理的平均时间约70ms。</p>
<p>windows下的速度对比</p>
<table>
<thead>
<tr>
<th align="center">方式</th>
<th align="center">时间</th>
<th align="center">CUDA</th>
<th align="center">warmup</th>
</tr>
</thead>
<tbody><tr>
<td align="center">pytorch+pt</td>
<td align="center">70ms</td>
<td align="center">√</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(MinGW@Qt)+onnx</td>
<td align="center">184ms</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(MSVC@VS)+onnx</td>
<td align="center">110ms</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(MSVC@VS)+onnx</td>
<td align="center">28ms</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">opencv(python)+onnx</td>
<td align="center">260ms</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">opencv(python)+onnx</td>
<td align="center">160ms</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">libtorch+torchscript</td>
<td align="center">26ms</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
</tbody></table>
<p>总体来看，libtorch方式有很大优势，再加上转成so之后放在python中使用，会变得更快。</p>
<h2 id="libtorch指定CUDA或CPU"><a href="#libtorch指定CUDA或CPU" class="headerlink" title="libtorch指定CUDA或CPU"></a>libtorch指定CUDA或CPU</h2><p>指定cuda或者指定cpu，需要将model和img放在同一个设备上</p>
<h3 id="指定CUDA"><a href="#指定CUDA" class="headerlink" title="指定CUDA"></a>指定CUDA</h3><ul>
<li><p>model</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cudaID = <span class="number">0</span>;</span><br><span class="line">torch::jit::script::Module model;</span><br><span class="line">model = torch::jit::<span class="built_in">load</span>(ptFile,torch::<span class="built_in">Device</span>(torch::DeviceType::CUDA,cudaID));</span><br></pre></td></tr></table></figure></li>
<li><p>image</p>
<p><strong>不是inplace操作</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">torch::Tensor data = torch::<span class="built_in">rand</span>(&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">640</span>, <span class="number">640</span>&#125;);</span><br><span class="line">data = data.<span class="built_in">to</span>(torch::<span class="built_in">Device</span>(torch::kCUDA, cudaID));</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ul>
<li><p>model</p>
<p>使用的是CUDA版本的libtorch，model默认是使用CUDA:0加载的，要使用cpu需要制定一下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">torch::jit::script::Module model;</span><br><span class="line">model = torch::jit::<span class="built_in">load</span>(ptFile,torch::kCPU);</span><br></pre></td></tr></table></figure></li>
<li><p>image</p>
<p>image默认加载到cpu上，不需要操作</p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/libtorch/" rel="tag"># libtorch</a>
              <a href="/tags/pybind11/" rel="tag"># pybind11</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/19/html-css-js/" rel="prev" title="html+css+js">
                  <i class="fa fa-chevron-left"></i> html+css+js
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/27/mysql/" rel="next" title="MySQL">
                  MySQL <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ljz</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
